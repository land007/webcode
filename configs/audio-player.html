<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Webcode Audio Player</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #1a1a2e;
    color: #eee;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    gap: 24px;
  }
  h1 { font-size: 1.4rem; opacity: 0.85; letter-spacing: 0.03em; }
  #status {
    font-size: 0.9rem;
    opacity: 0.6;
    min-height: 1.4em;
    text-align: center;
  }
  #toggle-btn {
    font-size: 2.5rem;
    padding: 18px 36px;
    border: none;
    border-radius: 50px;
    cursor: pointer;
    transition: background 0.2s, transform 0.1s;
    background: #2a5298;
    color: #fff;
    box-shadow: 0 4px 20px rgba(0,0,0,0.4);
  }
  #toggle-btn:hover { background: #3060b0; transform: scale(1.04); }
  #toggle-btn.active { background: #1a8a4a; }
  #toggle-btn.error  { background: #8a1a1a; }
  .hint {
    font-size: 0.78rem;
    opacity: 0.45;
    text-align: center;
    max-width: 320px;
    line-height: 1.6;
  }
</style>
</head>
<body>
<h1>ğŸ–¥ï¸ Webcode Desktop Audio</h1>
<button id="toggle-btn">ğŸ”‡ å¼€å¯éŸ³é¢‘</button>
<div id="status">ç‚¹å‡»æŒ‰é’®å¼€å§‹æ’­æ”¾å®¹å™¨æ¡Œé¢éŸ³é¢‘</div>
<p class="hint">æµè§ˆå™¨å®‰å…¨ç­–ç•¥è¦æ±‚ç”¨æˆ·ä¸»åŠ¨ç‚¹å‡»æ‰èƒ½æ’­æ”¾éŸ³é¢‘ã€‚<br>éŸ³é¢‘ç»ç”± PulseAudio â†’ WebSocket å®æ—¶ä¼ è¾“ï¼Œå»¶è¿Ÿçº¦ 50msã€‚</p>

<script>
(function () {
  'use strict';
  var AUDIO_WS_PORT = 20006;
  var SAMPLE_RATE = 44100;
  var CHANNELS = 2;

  var btn    = document.getElementById('toggle-btn');
  var status = document.getElementById('status');

  var audioCtx    = null;
  var ws          = null;
  var nextPlayTime = 0;
  var active      = false;

  function setStatus(msg) { status.textContent = msg; }

  function stopAudio() {
    active = false;
    btn.textContent = 'ğŸ”‡ å¼€å¯éŸ³é¢‘';
    btn.className = '';
    setStatus('å·²åœæ­¢');
    if (ws)        { ws.close(); ws = null; }
    if (audioCtx)  { audioCtx.close(); audioCtx = null; }
  }

  function startAudio() {
    active = true;
    btn.textContent = 'â³ è¿æ¥ä¸­â€¦';
    btn.className = '';
    setStatus('æ­£åœ¨è¿æ¥ WebSocket éŸ³é¢‘æœåŠ¡â€¦');

    try {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)({
        sampleRate: SAMPLE_RATE,
      });
    } catch (e) {
      setStatus('é”™è¯¯ï¼šæ— æ³•åˆ›å»º AudioContext â€” ' + e.message);
      stopAudio();
      return;
    }

    nextPlayTime = audioCtx.currentTime + 0.02; // 20ms initial buffer for low latency

    var wsUrl = 'ws://' + location.hostname + ':' + AUDIO_WS_PORT;
    try {
      ws = new WebSocket(wsUrl);
    } catch (e) {
      setStatus('é”™è¯¯ï¼šWebSocket è¿æ¥å¤±è´¥ â€” ' + e.message);
      stopAudio();
      return;
    }

    ws.binaryType = 'arraybuffer';

    ws.onopen = function () {
      btn.textContent = 'ğŸ”Š åœæ­¢éŸ³é¢‘';
      btn.className = 'active';
      setStatus('æ­£åœ¨æ’­æ”¾â€¦ (' + wsUrl + ')');
    };

    ws.onerror = function () {
      setStatus('é”™è¯¯ï¼šWebSocket è¿æ¥æ–­å¼€');
      btn.className = 'error';
      setTimeout(stopAudio, 2000);
    };

    ws.onclose = function () {
      if (active) {
        setStatus('è¿æ¥å·²å…³é—­');
        btn.className = 'error';
        setTimeout(stopAudio, 2000);
      }
    };

    ws.onmessage = function (event) {
      if (!audioCtx) return;
      var raw = new Int16Array(event.data);
      var numFrames = raw.length / CHANNELS;
      if (numFrames < 1) return;

      var buffer = audioCtx.createBuffer(CHANNELS, numFrames, SAMPLE_RATE);
      for (var ch = 0; ch < CHANNELS; ch++) {
        var channelData = buffer.getChannelData(ch);
        for (var i = 0; i < numFrames; i++) {
          channelData[i] = raw[i * CHANNELS + ch] / 32768.0;
        }
      }

      var source = audioCtx.createBufferSource();
      source.buffer = buffer;
      source.connect(audioCtx.destination);

      var now = audioCtx.currentTime;
      if (nextPlayTime < now) { nextPlayTime = now + 0.01; } // 10ms resync buffer for low latency
      source.start(nextPlayTime);
      nextPlayTime += buffer.duration;
    };
  }

  btn.addEventListener('click', function () {
    if (active) { stopAudio(); } else { startAudio(); }
  });
})();
</script>
</body>
</html>
