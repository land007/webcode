<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebCode Dashboard</title>
  <!-- 主题初始化：在 CSS 加载前设置 data-theme，防止页面闪烁 -->
  <script>(function(){
    try { var t = localStorage.getItem('webcode-theme') || 'dark'; document.documentElement.setAttribute('data-theme', t); } catch(e) {}
  })();</script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg:        #1a1d23;
      --surface:   #22262e;
      --surface2:  #2a2f3a;
      --border:    #363c4a;
      --accent:    #4f8ef7;
      --text:      #e2e8f0;
      --text-muted:#8892a4;
      --success:   #3ecf8e;
      --tab-h:     42px;
    }

    html[data-theme="light"] {
      --bg:        #f0f2f5;
      --surface:   #ffffff;
      --surface2:  #edf0f5;
      --border:    #d1d5df;
      --text:      #1e2130;
      --text-muted:#5c667a;
    }

    @media (prefers-color-scheme: light) {
      html[data-theme="system"] {
        --bg:        #f0f2f5;
        --surface:   #ffffff;
        --surface2:  #edf0f5;
        --border:    #d1d5df;
        --text:      #1e2130;
        --text-muted:#5c667a;
      }
    }

    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 14px;
      overflow: hidden;
    }

    body {
      display: flex;
      flex-direction: column;
    }

    .topbar {
      display: flex;
      flex-direction: row;
      flex-wrap: nowrap;
      align-items: center;
      gap: 4px;
      height: var(--tab-h);
      min-height: var(--tab-h);
      max-height: var(--tab-h);
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 0 12px;
      flex-shrink: 0;
      overflow: hidden;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      font-size: 14px;
      color: var(--accent);
      margin-right: 16px;
      flex-shrink: 0;
    }

    .logo svg { width: 24px; height: 24px; flex-shrink: 0; }

    .tab-btn {
      height: 32px;
      padding: 0 12px;
      border-radius: 6px;
      background: transparent;
      color: var(--text-muted);
      font-size: 13px;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
      transition: all 0.15s;
      flex-shrink: 0;
    }

    .tab-btn:hover { background: var(--surface2); color: var(--text); }
    .tab-btn.active { background: var(--surface2); color: var(--text); }
    .tab-btn svg { width: 16px; height: 16px; flex-shrink: 0; }

    .spacer { flex: 1; min-width: 0; }

    .tab-actions {
      display: flex;
      align-items: center;
      gap: 4px;
      flex-shrink: 0;
    }

    .btn-icon {
      width: 28px;
      height: 28px;
      padding: 0;
      border-radius: 6px;
      background: transparent;
      color: var(--text-muted);
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
      flex-shrink: 0;
    }

    .btn-icon:hover { background: var(--surface2); color: var(--text); }
    .btn-icon svg { width: 16px; height: 16px; }

    .theme-cycle-btn,
    .lang-cycle-btn {
      padding: 3px 9px;
      font-size: 12px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text);
      cursor: pointer;
      white-space: nowrap;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .theme-cycle-btn:hover,
    .lang-cycle-btn:hover {
      background: var(--surface);
      border-color: var(--accent);
    }

    .theme-cycle-btn svg,
    .lang-cycle-btn svg { width: 16px; height: 16px; flex-shrink: 0; }

    .status-pill {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--text-muted);
      padding: 0 8px;
      flex-shrink: 0;
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
      box-shadow: 0 0 6px var(--success);
      flex-shrink: 0;
    }

    .btn-fullscreen {
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.15s;
      flex-shrink: 0;
    }

    .btn-fullscreen:hover { background: var(--surface); border-color: var(--accent); }

    .iframe-area {
      flex: 1;
      position: relative;
      background: var(--bg);
      min-height: 0;
    }

    .iframe-area iframe {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      border: none;
      display: none;
    }

    .iframe-area iframe.visible { display: block; }

    .loading-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg);
      z-index: 10;
    }

    .loading-overlay.hidden { display: none; }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

    /* ── Status dot colors ───────────────────────────────────────────── */
    .dot-green  { background: var(--success); box-shadow: 0 0 6px var(--success); }
    .dot-yellow { background: #f5a623; box-shadow: 0 0 6px #f5a623; animation: pulse 1.2s infinite; }
    .dot-red    { background: #e05252; }
    .dot-gray   { background: var(--text-muted); box-shadow: none; }

    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.4} }

    /* ── Status pill as button ───────────────────────────────────────── */
    .status-pill {
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 0 8px;
    }
    .status-pill:hover { opacity: 0.8; }

    /* ── Modal overlay ───────────────────────────────────────────────── */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.hidden { display: none; }

    .modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      width: 90vw;
      max-width: 680px;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      flex-shrink: 0;
    }

    .modal-header h3 {
      font-size: 15px;
      font-weight: 600;
    }

    .modal-header-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .modal-body {
      overflow-y: auto;
      flex: 1;
    }

    /* ── Process grid ────────────────────────────────────────────────── */
    .process-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 8px;
    }

    .svc-card {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px 14px 12px;
      position: relative;
    }

    .svc-name {
      font-weight: 600;
      font-size: 13px;
      margin-bottom: 4px;
      padding-right: 32px;
    }

    .svc-state {
      font-size: 12px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .svc-actions {
      position: absolute;
      top: 10px;
      right: 8px;
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .svc-restart-btn {
      width: 22px;
      height: 22px;
      padding: 3px;
      border: none;
      border-radius: 4px;
      background: var(--surface);
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background .15s, color .15s;
    }

    .svc-restart-btn:hover { background: var(--accent); color: #fff; }
    .svc-restart-btn svg { width: 14px; height: 14px; }

    /* ── Log toggle button ───────────────────────────────────────────── */
    .svc-log-btn {
      width: 22px;
      height: 22px;
      padding: 3px;
      border: none;
      border-radius: 4px;
      background: var(--surface);
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background .15s, color .15s;
    }
    .svc-log-btn:hover { background: var(--surface2); color: var(--text); }
    .svc-log-btn.active { color: var(--accent); }
    .svc-log-btn svg { width: 14px; height: 14px; }

    /* ── Log area ────────────────────────────────────────────────────── */
    .log-area {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
      font-size: 11px;
      line-height: 1.6;
      color: var(--text);
      padding: 8px 10px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-all;
    }

    /* Error line highlighting */
    .log-line-error {
      color: #e05252;
      background: rgba(224, 82, 82, 0.1);
      padding: 2px 4px;
      border-radius: 3px;
      margin: 2px -4px;
    }

    /* stderr section header */
    .log-stderr-header {
      color: #e05252;
      font-weight: 600;
      border-bottom: 1px solid var(--border);
      padding: 4px 0;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="logo">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
        <line x1="3" y1="9" x2="21" y2="9"></line>
        <line x1="9" y1="21" x2="9" y2="9"></line>
      </svg>
      <span>WebCode</span>
    </div>

    <button class="tab-btn active" data-tab="desktop">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
        <line x1="8" y1="21" x2="16" y2="21"></line>
        <line x1="12" y1="17" x2="12" y2="21"></line>
      </svg>
      <span data-i18n="desktop">桌面</span>
    </button>

    <button class="tab-btn" data-tab="ide">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="16 18 22 12 16 6"></polyline>
        <polyline points="8 6 2 12 8 18"></polyline>
      </svg>
      <span data-i18n="ide">IDE</span>
    </button>

    <button class="tab-btn" data-tab="kanban">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="3" width="18" height="18" rx="2"></rect>
        <line x1="9" y1="3" x2="9" y2="21"></line>
        <line x1="15" y1="3" x2="15" y2="21"></line>
      </svg>
      <span data-i18n="kanban">看板</span>
    </button>

    <button class="tab-btn" data-tab="ai">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 16a6 6 0 1 1 6-6 6 6 0 0 1-6 6z"></path>
        <circle cx="12" cy="12" r="3"></circle>
      </svg>
      <span data-i18n="ai">AI</span>
    </button>

    <span class="spacer"></span>

    <div class="tab-actions" id="tab-actions">
      <button class="btn-icon" id="btn-refresh" data-i18n-title="refresh">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
          <path d="M3 3v5h5"></path>
          <path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"></path>
          <path d="M16 21h5v-5"></path>
        </svg>
      </button>
    </div>

    <button class="status-pill" id="statusPill">
      <span class="dot dot-gray" id="status-dot"></span>
      <span id="status-text" data-i18n="online">所有服务正常</span>
    </button>

    <button class="theme-cycle-btn" id="themeCycleBtn"></button>
    <button class="lang-cycle-btn"  id="langCycleBtn"></button>

    <button class="btn-fullscreen" id="fullscreenBtn">
      <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path>
      </svg>
      <span data-i18n="fullscreen">全屏</span>
    </button>
  </div>

  <div class="iframe-area">
    <div class="loading-overlay hidden" id="loadingOverlay">
      <div class="loading-spinner"></div>
    </div>
    <iframe id="frame-desktop" class="visible"
      src="http://127.0.0.1:20004/vnc.html?autoconnect=true&resize=remote&password=__VNC_PASSWORD__"
      allow="clipboard-read; clipboard-write; autoplay; fullscreen; pointer-lock"></iframe>
    <iframe id="frame-ide"
      src="http://127.0.0.1:20001"
      allow="clipboard-read; clipboard-write;"></iframe>
    <iframe id="frame-kanban"
      src="http://127.0.0.1:20002"
      allow="clipboard-read; clipboard-write;"></iframe>
    <iframe id="frame-ai"
      src="http://127.0.0.1:20003/?token=__OPENCLAW_TOKEN__"
      allow="clipboard-read; clipboard-write;"></iframe>
  </div>

  <!-- Status Modal -->
  <div class="modal-overlay hidden" id="statusModal">
    <div class="modal">
      <div class="modal-header">
        <h3 id="modalTitle">进程状态</h3>
        <div class="modal-header-actions">
          <button class="btn-icon" id="modalRefreshBtn" title="刷新">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
              <path d="M3 3v5h5"></path>
              <path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"></path>
              <path d="M16 21h5v-5"></path>
            </svg>
          </button>
          <button class="btn-icon" id="closeModal">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
      </div>
      <div class="modal-body">
        <div class="process-grid" id="processGrid"></div>
      </div>
    </div>
  </div>

  <!-- Logs Modal -->
  <div class="modal-overlay hidden" id="logsModal">
    <div class="modal" style="max-width:800px;height:70vh;display:flex;flex-direction:column">
      <div class="modal-header">
        <h3 id="logsModalTitle">进程日志</h3>
        <div class="modal-header-actions">
          <button class="btn-icon" id="logsRefreshBtn" title="刷新">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
              <path d="M3 3v5h5"></path>
              <path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"></path>
              <path d="M16 21h5v-5"></path>
            </svg>
          </button>
          <button class="btn-icon" id="closeLogsModal">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
      </div>
      <div class="modal-body" style="flex:1;overflow:hidden;display:flex;flex-direction:column">
        <div class="log-area" id="logsContent" style="flex:1;overflow:auto;height:100%">加载中...</div>
      </div>
    </div>
  </div>

  <script>
    // ── i18n ──────────────────────────────────────────────────────────────────
    const MESSAGES = {
      'zh-CN': { desktop: '桌面', ide: 'IDE', kanban: '看板', ai: 'AI',
                 online: '所有服务正常', partial: '部分服务异常', offline: '服务离线',
                 fullscreen: '全屏', exit: '退出全屏', refresh: '刷新',
                 theme_dark: '暗色', theme_light: '亮色', theme_system: '跟随系统',
                 proc_status: '进程状态', restart: '重启进程', show_log: '查看日志',
                 logs_title: '进程日志' },
      'en':    { desktop: 'Desktop', ide: 'IDE', kanban: 'Kanban', ai: 'AI',
                 online: 'All Systems Online', partial: 'Some Services Down', offline: 'Services Offline',
                 fullscreen: 'Fullscreen', exit: 'Exit', refresh: 'Refresh',
                 theme_dark: 'Dark', theme_light: 'Light', theme_system: 'System',
                 proc_status: 'Process Status', restart: 'Restart', show_log: 'Show Logs',
                 logs_title: 'Process Logs' }
    };

    const LANG_KEY  = 'webcode-lang';
    const THEME_KEY = 'webcode-theme';
    const THEME_ORDER = ['dark', 'light', 'system'];

    function getLang() {
      try { return localStorage.getItem(LANG_KEY) || 'zh-CN'; } catch(e) { return 'zh-CN'; }
    }
    function setLang(l) {
      try { localStorage.setItem(LANG_KEY, l); } catch(e) {}
    }
    function t(key) {
      return (MESSAGES[getLang()] || MESSAGES['zh-CN'])[key] || key;
    }
    function getTheme() {
      try { return localStorage.getItem(THEME_KEY) || 'dark'; } catch(e) { return 'dark'; }
    }
    function setTheme(th) {
      try { localStorage.setItem(THEME_KEY, th); } catch(e) {}
      document.documentElement.setAttribute('data-theme', th);
    }

    // ── Theme icons ───────────────────────────────────────────────────────────
    const THEME_ICONS = {
      dark:   '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg>',
      light:  '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"></circle><path d="M12 2v2"></path><path d="M12 20v2"></path><path d="m4.93 4.93 1.41 1.41"></path><path d="m17.66 17.66 1.41 1.41"></path><path d="M2 12h2"></path><path d="M20 12h2"></path><path d="m6.34 17.66-1.41 1.41"></path><path d="m19.07 4.93-1.41 1.41"></path></svg>',
      system: '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>'
    };
    const LANG_ICON = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>';

    // ── Apply translations ────────────────────────────────────────────────────
    function applyTranslations() {
      document.querySelectorAll('[data-i18n]').forEach(el => {
        el.textContent = t(el.getAttribute('data-i18n'));
      });
      document.querySelectorAll('[data-i18n-title]').forEach(el => {
        el.title = t(el.getAttribute('data-i18n-title'));
      });
      document.documentElement.lang = getLang();
      updateThemeBtn();
      updateLangBtn();
    }

    function updateThemeBtn() {
      const theme = getTheme();
      const btn = document.getElementById('themeCycleBtn');
      btn.innerHTML = THEME_ICONS[theme] + '<span>\u00a0' + t('theme_' + theme) + '</span>';
    }

    function updateLangBtn() {
      const btn = document.getElementById('langCycleBtn');
      const label = getLang() === 'zh-CN' ? '中文' : 'EN';
      btn.innerHTML = LANG_ICON + '<span>\u00a0' + label + '</span>';
    }

    // ── Utility functions ───────────────────────────────────────────────────────
    function escHtml(str) {
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    // ── Tab switching ─────────────────────────────────────────────────────────
    const IFRAME_IDS = {
      desktop: 'frame-desktop',
      ide:     'frame-ide',
      kanban:  'frame-kanban',
      ai:      'frame-ai'
    };

    let currentTab = 'desktop';

    document.querySelectorAll('.tab-btn').forEach(tab => {
      tab.addEventListener('click', () => {
        const tabName = tab.dataset.tab;
        if (tabName === currentTab) return;
        document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        Object.values(IFRAME_IDS).forEach(id => document.getElementById(id).classList.remove('visible'));
        document.getElementById(IFRAME_IDS[tabName]).classList.add('visible');
        currentTab = tabName;
      });
    });

    // ── Refresh ───────────────────────────────────────────────────────────────
    document.getElementById('btn-refresh').addEventListener('click', () => {
      const iframe = document.getElementById(IFRAME_IDS[currentTab]);
      if (iframe) { showLoading(); iframe.src = iframe.src; setTimeout(hideLoading, 1500); }
    });

    const loadingOverlay = document.getElementById('loadingOverlay');
    function showLoading() { loadingOverlay.classList.remove('hidden'); }
    function hideLoading() { loadingOverlay.classList.add('hidden'); }
    document.querySelectorAll('.iframe-area iframe').forEach(fr => fr.addEventListener('load', hideLoading));

    // ── Theme cycle ───────────────────────────────────────────────────────────
    document.getElementById('themeCycleBtn').addEventListener('click', () => {
      const cur = getTheme();
      const next = THEME_ORDER[(THEME_ORDER.indexOf(cur) + 1) % THEME_ORDER.length];
      setTheme(next);
      updateThemeBtn();
    });

    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
      if (getTheme() === 'system') document.documentElement.setAttribute('data-theme', 'system');
    });

    // ── Language cycle ────────────────────────────────────────────────────────
    document.getElementById('langCycleBtn').addEventListener('click', () => {
      setLang(getLang() === 'zh-CN' ? 'en' : 'zh-CN');
      applyTranslations();
    });

    // ── Fullscreen ────────────────────────────────────────────────────────────
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    fullscreenBtn.addEventListener('click', () => {
      if (!document.fullscreenElement) document.documentElement.requestFullscreen();
      else document.exitFullscreen();
    });

    document.addEventListener('fullscreenchange', () => {
      const isFs = !!document.fullscreenElement;
      const fsIcon = `<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><path d="${isFs ? 'M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3' : 'M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3'}"></path></svg>`;
      fullscreenBtn.innerHTML = fsIcon + `<span data-i18n="${isFs ? 'exit' : 'fullscreen'}">${t(isFs ? 'exit' : 'fullscreen')}</span>`;
    });

    // ── Process status ────────────────────────────────────────────────────────
    const RESTART_ICON = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 21H3v-5"/></svg>`;
    const LOG_ICON     = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="8" y1="8" x2="16" y2="8"/><line x1="8" y1="12" x2="16" y2="12"/><line x1="8" y1="16" x2="12" y2="16"/></svg>`;

    let pollTimer = null;
    let lastServices = [];

    function dotClass(state) {
      if (state === 'RUNNING')  return 'dot-green';
      if (state === 'STARTING') return 'dot-yellow';
      return 'dot-red';
    }

    function renderProcessGrid(services) {
      const grid = document.getElementById('processGrid');
      grid.innerHTML = '';
      if (!services.length) {
        const msg = document.createElement('div');
        msg.style.cssText = 'color:var(--text-muted);font-size:13px;padding:8px 0';
        msg.textContent = t('offline');
        grid.appendChild(msg);
        return;
      }
      services.forEach(svc => {
        const card = document.createElement('div');
        card.className = 'svc-card';

        const nameEl = document.createElement('div');
        nameEl.className = 'svc-name';
        nameEl.textContent = svc.name;

        const stateEl = document.createElement('div');
        stateEl.className = 'svc-state';
        const dotEl = document.createElement('span');
        dotEl.className = 'dot ' + dotClass(svc.state);
        stateEl.appendChild(dotEl);
        stateEl.appendChild(document.createTextNode(svc.state.toLowerCase()));

        const actions = document.createElement('div');
        actions.className = 'svc-actions';

        // Restart button
        const restartBtn = document.createElement('button');
        restartBtn.className = 'svc-restart-btn';
        restartBtn.title = t('restart');
        restartBtn.innerHTML = RESTART_ICON;

        // Log toggle button
        const logBtn = document.createElement('button');
        logBtn.className = 'svc-log-btn';
        logBtn.title = t('show_log');
        logBtn.innerHTML = LOG_ICON;
        logBtn.dataset.process = svc.name;

        restartBtn.addEventListener('click', e => {
          e.stopPropagation();
          restartProcess(restartBtn, svc.name);
        });

        logBtn.addEventListener('click', e => {
          e.stopPropagation();
          openLogsModal(svc.name);
        });

        actions.appendChild(restartBtn);
        actions.appendChild(logBtn);
        card.appendChild(nameEl);
        card.appendChild(stateEl);
        card.appendChild(actions);
        grid.appendChild(card);
      });
    }

    function updateStatusDot(services) {
      const dot  = document.getElementById('status-dot');
      const text = document.getElementById('status-text');
      if (!services.length) {
        dot.className = 'dot dot-gray'; text.textContent = t('offline'); return;
      }
      const anyStarting = services.some(s => s.state === 'STARTING');
      const anyBad      = services.some(s => !['RUNNING','STARTING'].includes(s.state));
      if (anyStarting) {
        dot.className = 'dot dot-yellow'; text.textContent = t('partial');
      } else if (anyBad) {
        dot.className = 'dot dot-red'; text.textContent = t('partial');
      } else {
        dot.className = 'dot dot-green'; text.textContent = t('online');
      }
    }

    async function fetchStatus() {
      try {
        const r = await fetch('/api/status', { credentials: 'include' });
        const services = await r.json();
        lastServices = services;
        updateStatusDot(services);
        // Re-render grid whenever status modal is visible
        if (!statusModal.classList.contains('hidden')) {
          renderProcessGrid(services);
        }
      } catch(e) {
        updateStatusDot([]);
      }
    }

    function startPolling() {
      fetchStatus();
      pollTimer = setInterval(fetchStatus, 5000);
    }

    // ── Status modal open / close ─────────────────────────────────────────────
    const statusModal = document.getElementById('statusModal');

    document.getElementById('statusPill').addEventListener('click', () => {
      document.getElementById('modalTitle').textContent = t('proc_status');
      renderProcessGrid(lastServices);
      statusModal.classList.remove('hidden');
    });

    document.getElementById('closeModal').addEventListener('click', () => {
      statusModal.classList.add('hidden');
    });

    statusModal.addEventListener('click', e => {
      if (e.target === statusModal) statusModal.classList.add('hidden');
    });

    document.getElementById('modalRefreshBtn').addEventListener('click', async () => {
      const r = await fetch('/api/status', { credentials: 'include' });
      const services = await r.json();
      lastServices = services;
      updateStatusDot(services);
      renderProcessGrid(services);
    });

    // ── Restart process ───────────────────────────────────────────────────────
    async function restartProcess(btn, name) {
      btn.disabled = true;
      btn.style.background = 'var(--accent)';
      btn.style.color = '#fff';
      try {
        const r = await fetch(`/api/restart/${encodeURIComponent(name)}`, {
          method: 'POST',
          credentials: 'include'
        });
        const data = await r.json();
        btn.style.background = data.ok ? 'var(--success)' : '#e05252';
      } catch (err) {
        btn.style.background = '#e05252';
        console.error('Restart failed:', err);
      }
      setTimeout(() => {
        btn.disabled = false;
        btn.style.background = '';
        btn.style.color = '';
        fetchStatus();
      }, 1500);
    }

    // ── Logs modal ─────────────────────────────────────────────────────────────
    let currentLogProcess = null;
    const logsModal = document.getElementById('logsModal');

    function openLogsModal(processName) {
      currentLogProcess = processName;
      document.getElementById('logsModalTitle').textContent = `${t('logs_title')} - ${processName}`;
      logsModal.classList.remove('hidden');
      loadLogs();
    }

    async function loadLogs() {
      if (!currentLogProcess) return;
      const contentEl = document.getElementById('logsContent');
      contentEl.innerHTML = '<div style="color:var(--text-muted)">加载中...</div>';

      try {
        const r = await fetch(`/api/logs/${encodeURIComponent(currentLogProcess)}`, { credentials: 'include' });
        const text = await r.text();

        // Format logs: highlight [ERROR] lines and stderr header
        const lines = text.split('\n');
        const formatted = lines.map(line => {
          // stderr separator
          if (line.trim() === '=== stderr ===') {
            return '<div class="log-stderr-header">' + escHtml(line) + '</div>';
          }
          // [ERROR] prefixed lines
          if (line.startsWith('[ERROR]')) {
            return '<div class="log-line-error">' + escHtml(line) + '</div>';
          }
          return escHtml(line) + '<br>';
        }).join('');

        contentEl.innerHTML = formatted || '<div style="color:var(--text-muted)">(无日志输出)</div>';
        contentEl.scrollTop = contentEl.scrollHeight;
      } catch(e) {
        contentEl.textContent = 'Error fetching logs: ' + e.message;
      }
    }

    document.getElementById('closeLogsModal').addEventListener('click', () => {
      logsModal.classList.add('hidden');
      currentLogProcess = null;
    });

    logsModal.addEventListener('click', e => {
      if (e.target === logsModal) {
        logsModal.classList.add('hidden');
        currentLogProcess = null;
      }
    });

    document.getElementById('logsRefreshBtn').addEventListener('click', () => {
      loadLogs();
    });

    // ── Keyboard shortcuts ────────────────────────────────────────────────────
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') {
        statusModal.classList.add('hidden');
        logsModal.classList.add('hidden');
        currentLogProcess = null;
      }
    });

    // ── Init ──────────────────────────────────────────────────────────────────
    applyTranslations();
    startPolling();
    showLoading();
  </script>
</body>
</html>
