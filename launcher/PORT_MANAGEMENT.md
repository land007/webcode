# 端口管理功能说明

## 功能概述

Launcher 现已支持智能端口管理，可以自动检测端口冲突并分配可用端口，无需手动干预。

## 端口配置

### 默认端口

| 服务 | 默认端口 | 说明 |
|------|---------|------|
| Theia IDE | 20001 | IDE 开发环境 |
| Vibe Kanban | 20002 | 看板应用 |
| OpenClaw AI | 20003 | AI 助手 |
| noVNC | 20004 | Web VNC 客户端 |
| TigerVNC | 20005 | VNC 协议端口 |

### 端口架构

```
┌─────────────────────────────────────────────────────────┐
│                      用户浏览器                          │
│               访问 localhost:20001-20005                 │
└─────────────────────┬───────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────┐
│                   Caddy (Basic Auth)                     │
│              监听 20001-20004，代理到内部端口              │
└─────────────────────┬───────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────┐
│                    应用容器内部                           │
│  Theia:10001  Kanban:10002  OpenClaw:10003  noVNC:10004  │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│                 Launcher 桌面应用                        │
│   代理端口 11001-11004 → 内部端口 10001-10004 (无 Auth)   │
└─────────────────────────────────────────────────────────┘
```

## 使用方法

### 1. 向导模式配置

首次启动时，在"高级选项"中可以：

1. **手动配置端口**
   - 在"端口配置"区域输入所需的端口号
   - 点击"🔍 检测端口冲突"按钮
   - 查看每个端口的可用性状态（✓ 可用 / ✗ 被占用）

2. **自动检测和修复**
   - 系统在启动前自动检测所有端口
   - 如果发现冲突，自动寻找可用端口（从原端口 +100 开始）
   - 自动更新 `docker-compose.yml` 和配置文件
   - 显示端口调整日志

### 2. 工作区模式配置

在已配置环境中：

1. **查看和修改端口**
   - 进入"状态"标签页
   - 在"配置"区域找到"端口配置"
   - 修改各服务的端口号

2. **检测和修复冲突**
   - 点击"🔍 检测端口冲突"按钮
   - 如果发现冲突，提示是否自动修复
   - 确认后自动调整端口并更新表单
   - 点击"保存配置"使更改生效

### 3. 命令行手动检测

```bash
# 检测特定端口
nc -z localhost 20001
echo $?  # 0 表示被占用，1 表示可用

# 或使用 lsof
lsof -i :20001
```

## 自动修复机制

### 检测时机

- **启动前检测**：每次启动容器前自动检测
- **手动检测**：用户点击"检测端口冲突"按钮时

### 修复策略

1. 检测到端口冲突时，从 `原端口 + 100` 开始寻找可用端口
2. 最多尝试 100 个端口
3. 找到可用端口后，自动：
   - 更新配置文件 `config.json`
   - 更新 `docker-compose.yml` 的端口映射
   - 记录调整日志

### 示例日志

```
检测到端口冲突，正在自动修复...
端口已自动调整：
  Theia IDE: 20001 → 20101
  Vibe Kanban: 20002 → 20102

```

## 配置文件

### config.json 结构

```json
{
  "AUTH_USER": "admin",
  "AUTH_PASSWORD": "changeme",
  "PORT_THEIA": 20001,
  "PORT_KANBAN": 20002,
  "PORT_OPENCLAW": 20003,
  "PORT_NOVNC": 20004,
  "PORT_VNC": 20005,
  ...
}
```

### docker-compose.yml 端口映射

```yaml
ports:
  - "20001:20001"  # Theia IDE (宿主机:容器)
  - "20002:20002"  # Vibe Kanban
  - "20003:20003"  # OpenClaw
  - "20004:20004"  # noVNC
  - "20005:10005"  # TigerVNC (直连)
```

## 故障排除

### 端口仍被占用

如果自动修复失败：

1. **检查占用进程**
   ```bash
   lsof -i :20001
   ```

2. **停止占用进程**
   ```bash
   kill -9 <PID>
   ```

3. **手动指定其他端口**
   - 在配置表单中输入未被占用的端口
   - 保存配置并重启

### 无法找到可用端口

如果连续 100 个端口都被占用：

1. 检查是否有其他 Docker 容器占用大量端口
2. 检查系统端口范围限制
3. 考虑使用更大的端口号（如 30000+）

## 技术细节

### 端口检测原理

使用 Node.js `net` 模块尝试绑定端口：

```javascript
function isPortAvailable(port) {
  return new Promise((resolve) => {
    const server = net.createServer();
    server.once('error', (err) => {
      if (err.code === 'EADDRINUSE') {
        resolve(false);  // 端口被占用
      }
    });
    server.once('listening', () => {
      server.close();
      resolve(true);   // 端口可用
    });
    server.listen(port, '127.0.0.1');
  });
}
```

### 配置持久化

端口配置保存在：
- **macOS**: `~/Library/Application Support/webcode-launcher/config.json`
- **Windows**: `%APPDATA%\webcode-launcher\config.json`
- **Linux**: `~/.config/webcode-launcher/config.json`

## 最佳实践

1. **使用默认端口**：除非有特殊需求，建议使用默认端口配置
2. **定期检测**：修改配置后建议先检测端口再保存
3. **记录端口变更**：如果修改了默认端口，建议记录新端口号
4. **重启服务**：修改端口配置后需要重启容器才能生效
