<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>webcode</title>
  <link rel="stylesheet" href="src/style.css">
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• WIZARD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="wizard">
  <div class="wizard-card">
    <div class="wizard-header">
      <h1 data-i18n="title">webcode å¯åŠ¨å™¨</h1>
      <div class="lang-toggle">
        <button class="lang-btn active" data-lang="zh-CN">ä¸­æ–‡</button>
        <button class="lang-btn" data-lang="en">EN</button>
      </div>
    </div>
    <p class="subtitle" data-i18n="subtitle">æµè§ˆå™¨å¯è®¿é—®çš„å¼€å‘ç¯å¢ƒï¼Œç”± Docker é©±åŠ¨</p>

    <!-- Step dots -->
    <div class="step-indicator" id="step-dots"></div>

    <!-- Step 1: Docker check -->
    <div id="step-1">
      <p class="text-muted text-sm" style="margin-bottom:16px" data-i18n="step1_detecting">æ­£åœ¨æ£€æµ‹è¿è¡Œç¯å¢ƒâ€¦</p>
      <div id="check-docker-installed" class="check-row">
        <span class="icon">ğŸ³</span>
        <span class="label" data-i18n="docker_installed">Docker å·²å®‰è£…</span>
        <span class="badge badge-checking" data-i18n="badge_checking">æ£€æµ‹ä¸­</span>
      </div>
      <div id="check-docker-running" class="check-row">
        <span class="icon">â–¶</span>
        <span class="label" data-i18n="docker_running">Docker æ­£åœ¨è¿è¡Œ</span>
        <span class="badge badge-checking" data-i18n="badge_checking">æ£€æµ‹ä¸­</span>
      </div>
      <div id="docker-help" style="display:none; margin-top:12px; font-size:12px; color:var(--text-muted)">
        <span data-i18n="docker_help_prefix">è¯·å…ˆå®‰è£…å¹¶å¯åŠ¨</span>
        <a class="link" id="docker-dl-link">Docker Desktop</a><span data-i18n="docker_help_suffix">ï¼Œç„¶ååˆ·æ–°æ£€æµ‹ã€‚</span>
      </div>
      <div class="action-row">
        <button class="btn-secondary btn-sm" id="btn-recheck" data-i18n="btn_recheck">é‡æ–°æ£€æµ‹</button>
        <button class="btn-primary" id="btn-step1-next" disabled data-i18n="btn_step1_next">ä¸‹ä¸€æ­¥</button>
      </div>
    </div>

    <!-- Step 2: Config -->
    <div id="step-2" style="display:none">
      <div class="form-group">
        <label data-i18n="label_run_mode">è¿è¡Œæ¨¡å¼</label>
        <div class="toggle-row">
          <button class="toggle-btn active" data-mode="desktop" id="mode-desktop" data-i18n="mode_desktop">ğŸ–¥ Desktopï¼ˆå®Œæ•´æ¡Œé¢ï¼‰</button>
          <button class="toggle-btn" data-mode="lite" id="mode-lite" data-i18n="mode_lite">âš¡ Liteï¼ˆä»… IDE + çœ‹æ¿ï¼‰</button>
        </div>
      </div>
      <div class="form-group">
        <label data-i18n="label_auth_password">Basic Auth å¯†ç </label>
        <input type="password" id="cfg-auth-password" placeholder="changeme">
      </div>
      <div id="vnc-group" class="form-group">
        <label data-i18n="label_vnc_password">VNC å¯†ç </label>
        <input type="password" id="cfg-vnc-password" placeholder="changeme">
      </div>
      <div class="form-group">
        <label data-i18n="label_openclaw_token">OpenClaw Token</label>
        <input type="text" id="cfg-openclaw-token" placeholder="changeme">
      </div>
      <details>
        <summary data-i18n="summary_advanced">é«˜çº§é€‰é¡¹</summary>
        <div class="config-grid" style="margin-top:10px">
          <div class="form-group">
            <label data-i18n="label_auth_user">Basic Auth ç”¨æˆ·å</label>
            <input type="text" id="cfg-auth-user" placeholder="admin">
          </div>
          <div class="form-group">
            <label data-i18n="label_vnc_resolution">VNC åˆ†è¾¨ç‡</label>
            <input type="text" id="cfg-vnc-resolution" placeholder="1920x1080">
          </div>
          <div class="form-group">
            <label data-i18n="label_git_name">Git ç”¨æˆ·å</label>
            <input type="text" id="cfg-git-name" data-i18n-placeholder="ph_optional" placeholder="ï¼ˆå¯é€‰ï¼‰">
          </div>
          <div class="form-group">
            <label data-i18n="label_git_email">Git é‚®ç®±</label>
            <input type="text" id="cfg-git-email" data-i18n-placeholder="ph_optional" placeholder="ï¼ˆå¯é€‰ï¼‰">
          </div>
        </div>
        <div class="form-group">
          <label data-i18n="label_cf_token">Cloudflare Tunnel Tokenï¼ˆå¯é€‰ï¼‰</label>
          <input type="text" id="cfg-cf-token" placeholder="">
        </div>
        <div class="form-group">
          <label data-i18n="label_port_config">ç«¯å£é…ç½®ï¼ˆè‡ªåŠ¨æ£€æµ‹å†²çªï¼‰</label>
          <div class="port-grid" id="port-grid">
            <div class="port-item">
              <span class="port-label">Theia IDE</span>
              <input type="number" id="cfg-port-theia" class="port-input" placeholder="20001">
              <span class="port-status" id="port-status-theia"></span>
            </div>
            <div class="port-item">
              <span class="port-label">Vibe Kanban</span>
              <input type="number" id="cfg-port-kanban" class="port-input" placeholder="20002">
              <span class="port-status" id="port-status-kanban"></span>
            </div>
            <div class="port-item">
              <span class="port-label">OpenClaw AI</span>
              <input type="number" id="cfg-port-openclaw" class="port-input" placeholder="20003">
              <span class="port-status" id="port-status-openclaw"></span>
            </div>
            <div class="port-item">
              <span class="port-label">noVNC</span>
              <input type="number" id="cfg-port-novnc" class="port-input" placeholder="20004">
              <span class="port-status" id="port-status-novnc"></span>
            </div>
            <div class="port-item">
              <span class="port-label">TigerVNC</span>
              <input type="number" id="cfg-port-vnc" class="port-input" placeholder="20005">
              <span class="port-status" id="port-status-vnc"></span>
            </div>
          </div>
          <button class="btn-secondary btn-sm" id="btn-check-ports" style="margin-top:8px" data-i18n="btn_check_ports">ğŸ” æ£€æµ‹ç«¯å£å†²çª</button>
        </div>
      </details>
      <div class="action-row">
        <button class="btn-secondary btn-sm" id="btn-step2-back" data-i18n="btn_step2_back">ä¸Šä¸€æ­¥</button>
        <button class="btn-primary" id="btn-step2-next" data-i18n="btn_step2_next">ä¸‹ä¸€æ­¥ï¼šå¯åŠ¨å®¹å™¨</button>
      </div>
    </div>

    <!-- Step 3: Launch -->
    <div id="step-3" style="display:none">
      <p class="text-muted text-sm" style="margin-bottom:12px" data-i18n="step3_desc">æ­£åœ¨å¯åŠ¨ webcode å®¹å™¨ï¼Œé¦–æ¬¡è¿è¡Œå°†æ‹‰å–é•œåƒï¼ˆçº¦ 2â€“5 åˆ†é’Ÿï¼‰â€¦</p>
      <div class="log-area" id="launch-log" style="height:240px"></div>
      <div class="action-row">
        <button class="btn-secondary btn-sm" id="btn-step3-back" data-i18n="btn_step3_back">è¿”å›é…ç½®</button>
        <button class="btn-primary" id="btn-step3-next" disabled data-i18n="btn_step3_next">è¿›å…¥å·¥ä½œåŒº â†’</button>
      </div>
    </div>

    <!-- Step 4: Ready (re-launch) -->
    <div id="step-4" style="display:none">
      <p class="text-muted text-sm" style="margin-bottom:16px" data-i18n="step4_desc">é…ç½®å·²åŠ è½½ï¼Œå®¹å™¨å½“å‰æœªè¿è¡Œã€‚</p>
      <div class="action-row" style="justify-content:flex-start; flex-wrap:wrap; gap:10px">
        <button class="btn-primary" id="btn-step4-start" data-i18n="btn_step4_start">â–¶ å¯åŠ¨å®¹å™¨</button>
        <button class="btn-secondary btn-sm" id="btn-step4-config" data-i18n="btn_step4_config">ä¿®æ”¹é…ç½®</button>
        <button class="btn-secondary btn-sm" id="btn-step4-enter" data-i18n="btn_step4_enter">ç›´æ¥è¿›å…¥å·¥ä½œåŒº</button>
      </div>
      <div class="log-area mt-3" id="relaunch-log" style="height:200px; display:none"></div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• WORKSPACE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="workspace">
  <!-- Top bar -->
  <div class="topbar">
    <button class="tab-btn" id="tab-status" data-tab="status" data-i18n="tab_status">â— çŠ¶æ€</button>
    <button class="tab-btn" id="tab-vnc"    data-tab="vnc"    data-i18n="tab_vnc">ğŸ–¥ æ¡Œé¢</button>
    <button class="tab-btn" id="tab-ide"    data-tab="ide"    data-i18n="tab_ide">ğŸ’» IDE</button>
    <button class="tab-btn" id="tab-kanban" data-tab="kanban" data-i18n="tab_kanban">ğŸ“‹ çœ‹æ¿</button>
    <button class="tab-btn" id="tab-ai"     data-tab="ai"     data-i18n="tab_ai">ğŸ¤– AI</button>
    <span class="topbar-spacer"></span>
    <div class="tab-actions" id="tab-actions" style="display:none">
      <button class="btn-icon" id="btn-refresh"      data-i18n-title="title_refresh"      title="åˆ·æ–°">ğŸ”„</button>
      <button class="btn-icon" id="btn-open-browser" data-i18n-title="title_open_browser" title="åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€">ğŸŒ</button>
    </div>
    <div class="status-pill">
      <span class="dot dot-gray" id="status-dot"></span>
      <span id="status-text" data-i18n="status_detecting">æ£€æµ‹ä¸­â€¦</span>
    </div>
    <div class="lang-toggle" style="margin-right:6px">
      <button class="lang-btn active" data-lang="zh-CN">ä¸­æ–‡</button>
      <button class="lang-btn" data-lang="en">EN</button>
    </div>
    <div class="topbar-actions">
      <button class="btn-secondary btn-sm" id="btn-restart" data-i18n="btn_restart">é‡å¯</button>
      <button class="btn-secondary btn-sm" id="btn-stop"    data-i18n="btn_stop">åœæ­¢</button>
    </div>
  </div>

  <!-- Content area -->
  <div class="iframe-area" id="iframe-area">
    <!-- Status panel (not an iframe) -->
    <div id="panel-status">
      <div>
        <h3 style="font-size:15px; font-weight:600; margin-bottom:12px" data-i18n="h_container_status">å®¹å™¨çŠ¶æ€</h3>
        <div class="status-grid" id="status-grid">
          <div class="svc-card">
            <div class="svc-name">webcode</div>
            <div class="svc-state"><span class="dot dot-gray"></span> <span id="main-state" data-i18n="state_unknown">æœªçŸ¥</span></div>
          </div>
        </div>
      </div>

      <!-- Config section -->
      <div class="config-section">
        <h3 data-i18n="h_config">é…ç½®</h3>
        <div class="config-grid">
          <div class="form-group">
            <label data-i18n="label_run_mode_ws">è¿è¡Œæ¨¡å¼</label>
            <div class="toggle-row">
              <button class="toggle-btn" data-mode="desktop" id="ws-mode-desktop" data-i18n="mode_desktop_short">ğŸ–¥ Desktop</button>
              <button class="toggle-btn" data-mode="lite"    id="ws-mode-lite"    data-i18n="mode_lite_short">âš¡ Lite</button>
            </div>
          </div>
          <div class="form-group">
            <label data-i18n="label_auth_password">Basic Auth å¯†ç </label>
            <input type="password" id="ws-auth-password">
          </div>
          <div class="form-group">
            <label data-i18n="label_vnc_password">VNC å¯†ç </label>
            <input type="password" id="ws-vnc-password">
          </div>
          <div class="form-group">
            <label data-i18n="label_openclaw_token">OpenClaw Token</label>
            <input type="text" id="ws-openclaw-token">
          </div>
          <div class="form-group">
            <label data-i18n="label_auth_user">Basic Auth ç”¨æˆ·å</label>
            <input type="text" id="ws-auth-user">
          </div>
          <div class="form-group">
            <label data-i18n="label_vnc_resolution">VNC åˆ†è¾¨ç‡</label>
            <input type="text" id="ws-vnc-resolution">
          </div>
          <div class="form-group">
            <label data-i18n="label_git_name">Git ç”¨æˆ·å</label>
            <input type="text" id="ws-git-name">
          </div>
          <div class="form-group">
            <label data-i18n="label_git_email">Git é‚®ç®±</label>
            <input type="text" id="ws-git-email">
          </div>
        </div>
        <div class="form-group">
          <label data-i18n="label_cf_token">Cloudflare Tunnel Tokenï¼ˆå¯é€‰ï¼‰</label>
          <input type="text" id="ws-cf-token">
        </div>
        <div class="form-group">
          <label data-i18n="label_port_config_ws">ç«¯å£é…ç½®</label>
          <div class="port-grid" id="ws-port-grid">
            <div class="port-item">
              <span class="port-label">Theia IDE</span>
              <input type="number" id="ws-port-theia" class="port-input">
            </div>
            <div class="port-item">
              <span class="port-label">Vibe Kanban</span>
              <input type="number" id="ws-port-kanban" class="port-input">
            </div>
            <div class="port-item">
              <span class="port-label">OpenClaw AI</span>
              <input type="number" id="ws-port-openclaw" class="port-input">
            </div>
            <div class="port-item">
              <span class="port-label">noVNC</span>
              <input type="number" id="ws-port-novnc" class="port-input">
            </div>
            <div class="port-item">
              <span class="port-label">TigerVNC</span>
              <input type="number" id="ws-port-vnc" class="port-input">
            </div>
          </div>
          <button class="btn-secondary btn-sm" id="ws-btn-check-ports" style="margin-top:8px" data-i18n="btn_check_ports">ğŸ” æ£€æµ‹ç«¯å£å†²çª</button>
        </div>
        <div class="action-row" style="margin-top:0">
          <button class="btn-secondary btn-sm" id="btn-save-config"  data-i18n="btn_save_config">ä¿å­˜é…ç½®</button>
          <button class="btn-primary btn-sm"   id="btn-save-restart" data-i18n="btn_save_restart">ä¿å­˜å¹¶é‡å¯å®¹å™¨</button>
        </div>
      </div>

      <!-- Logs -->
      <div>
        <h3 style="font-size:14px; font-weight:600; margin-bottom:8px" data-i18n="h_container_logs">å®¹å™¨æ—¥å¿—</h3>
        <div class="log-area" id="ws-log" style="height:260px"></div>
      </div>
    </div>

    <!-- iframes (lazy â€“ src set when first activated) -->
    <iframe id="iframe-ide"    sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-modals allow-downloads"></iframe>
    <iframe id="iframe-kanban" sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-modals"></iframe>
    <iframe id="iframe-vnc"    sandbox="allow-scripts allow-same-origin allow-forms allow-popups"></iframe>
    <iframe id="iframe-ai"     sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-modals"></iframe>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCRIPTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- æ—©æœŸè„šæœ¬ï¼šåœ¨é¡µé¢ä¸Šæ˜¾ç¤º JS é”™è¯¯ï¼ˆä¸ä¾èµ– DevToolsï¼‰ -->
<script>
window.onerror = function(msg, src, line, col, err) {
  var d = document.getElementById('_err_overlay');
  if (!d) {
    d = document.createElement('div');
    d.id = '_err_overlay';
    d.style.cssText = 'position:fixed;top:0;left:0;right:0;z-index:9999;' +
      'background:#1a0000;color:#ff8080;padding:10px 14px;' +
      'font:11px/1.6 monospace;max-height:50vh;overflow:auto;' +
      'border-bottom:2px solid #c00;word-break:break-all';
    document.body.appendChild(d);
  }
  var text = (src || '') + ':' + line + '\n' + msg;
  if (err && err.stack) text += '\n' + err.stack;
  var pre = document.createElement('pre');
  pre.style.margin = '0 0 8px';
  pre.textContent = text;
  d.appendChild(pre);
  return false;
};
</script>

<script>
// â”€â”€â”€ Load modules (with visible error if require fails) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let app, readConfig, writeConfig, configExists, ensureComposeFile;
let t, setLang, getLang;

(function loadModules() {
  try {
    app = require('./src/app.js');
    ({ readConfig, writeConfig, configExists, ensureComposeFile } = require('./src/config.js'));
    ({ t, setLang, getLang } = require('./src/i18n.js'));
  } catch (err) {
    var d = document.getElementById('_err_overlay');
    if (!d) {
      d = document.createElement('div');
      d.id = '_err_overlay';
      d.style.cssText = 'position:fixed;top:0;left:0;right:0;z-index:9999;' +
        'background:#1a0000;color:#ff8080;padding:16px;font:12px/1.6 monospace;' +
        'max-height:60vh;overflow:auto;border-bottom:2px solid #c00';
      document.body.appendChild(d);
    }
    var pre = document.createElement('pre');
    pre.style.margin = '0';
    pre.textContent = 'âš  æ¨¡å—åŠ è½½å¤±è´¥\n' + (err.stack || err.message);
    d.appendChild(pre);
  }
})();

if (!t) throw new Error('i18n module failed to load');

// â”€â”€â”€ applyTranslationsï¼šåœ¨é¡µé¢ä¸Šä¸‹æ–‡ä¸­è¿è¡Œï¼Œç¡®ä¿èƒ½è®¿é—® document â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function applyTranslations() {
  document.querySelectorAll('[data-i18n]').forEach(function(el) {
    el.textContent = t(el.getAttribute('data-i18n'));
  });
  document.querySelectorAll('[data-i18n-title]').forEach(function(el) {
    el.title = t(el.getAttribute('data-i18n-title'));
  });
  document.querySelectorAll('[data-i18n-placeholder]').forEach(function(el) {
    el.placeholder = t(el.getAttribute('data-i18n-placeholder'));
  });
  // åŒæ­¥è¯­è¨€æŒ‰é’®æ¿€æ´»çŠ¶æ€
  var lang = getLang();
  document.querySelectorAll('.lang-btn').forEach(function(btn) {
    btn.classList.toggle('active', btn.getAttribute('data-lang') === lang);
  });
  document.documentElement.lang = lang;
}

// â”€â”€â”€ Language switcherï¼ˆäº‹ä»¶å§”æ‰˜ï¼ŒæŒ‚åœ¨ document ä¸Šæœ€å¯é ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

document.addEventListener('click', function(e) {
  var btn = e.target.closest('.lang-btn');
  if (!btn) return;
  setLang(btn.getAttribute('data-lang'));
  applyTranslations();
});

// â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let currentStep = 1;
let currentTab  = 'status';
let cfg = readConfig();
let proxyStarted = false;
let logsProc = null;

function setStep(n) {
  for (let i = 1; i <= 4; i++) {
    document.getElementById('step-' + i).style.display = (i === n) ? '' : 'none';
  }
  currentStep = n;
  renderStepDots(n);
}

function renderStepDots(active) {
  const dots = document.getElementById('step-dots');
  dots.innerHTML = '';
  for (let i = 1; i <= 3; i++) {
    const d = document.createElement('div');
    d.className = 'step-dot' +
      (i < active ? ' done' : (i === active ? ' active' : ''));
    dots.appendChild(d);
  }
}

function showWizard(step) {
  document.getElementById('wizard').style.display = '';
  document.getElementById('workspace').style.display = 'none';
  setStep(step);
}

function showWorkspace() {
  document.getElementById('wizard').style.display = 'none';
  document.getElementById('workspace').style.display = 'flex';
  activateTab('status');
  loadConfigIntoWorkspaceForm();
  startStatusPolling();
  startLogStream();
  if (!proxyStarted) {
    app.startProxies(cfg);
    proxyStarted = true;
  }
}

// â”€â”€â”€ Step 1: Docker check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function runDockerCheck() {
  setCheckState('check-docker-installed', 'checking', t('badge_checking'));
  setCheckState('check-docker-running',   'checking', t('badge_checking'));
  document.getElementById('docker-help').style.display = 'none';
  document.getElementById('btn-step1-next').disabled = true;

  app.checkDocker((result) => {
    if (result.installed) {
      setCheckState('check-docker-installed', 'ok', result.version);
    } else {
      setCheckState('check-docker-installed', 'fail', t('dyn_not_found'));
      setCheckState('check-docker-running',   'fail', 'â€”');
      document.getElementById('docker-help').style.display = '';
      return;
    }
    if (result.running) {
      setCheckState('check-docker-running', 'ok', t('dyn_running'));
      document.getElementById('btn-step1-next').disabled = false;
    } else {
      setCheckState('check-docker-running', 'fail', t('dyn_not_running'));
      document.getElementById('docker-help').style.display = '';
    }
  });
}

function setCheckState(id, state, text) {
  const row  = document.getElementById(id);
  const badge = row.querySelector('.badge');
  badge.textContent = text;
  badge.className = 'badge ' + (state === 'ok' ? 'badge-ok' : state === 'fail' ? 'badge-fail' : 'badge-checking');
}

document.getElementById('btn-recheck').addEventListener('click', runDockerCheck);

document.getElementById('btn-step1-next').addEventListener('click', () => {
  loadConfigIntoWizardForm();
  setStep(2);
});

// Docker Desktop download link
document.getElementById('docker-dl-link').addEventListener('click', () => {
  nw.Shell.openExternal('https://www.docker.com/products/docker-desktop/');
});

// â”€â”€â”€ Step 2: Config form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let selectedMode = cfg.MODE || 'desktop';

document.querySelectorAll('[data-mode]').forEach(btn => {
  btn.addEventListener('click', () => {
    selectedMode = btn.dataset.mode;
    // update active state for sibling buttons sharing the same parent
    btn.closest('.toggle-row').querySelectorAll('.toggle-btn').forEach(b => {
      b.classList.toggle('active', b === btn);
    });
    if (btn.closest('#step-2')) {
      document.getElementById('vnc-group').style.display =
        selectedMode === 'desktop' ? '' : 'none';
    }
  });
});

function loadConfigIntoWizardForm() {
  document.getElementById('cfg-auth-password').value  = cfg.AUTH_PASSWORD || '';
  document.getElementById('cfg-vnc-password').value   = cfg.VNC_PASSWORD  || '';
  document.getElementById('cfg-openclaw-token').value = cfg.OPENCLAW_TOKEN || '';
  document.getElementById('cfg-auth-user').value      = cfg.AUTH_USER || 'admin';
  document.getElementById('cfg-vnc-resolution').value = cfg.VNC_RESOLUTION || '1920x1080';
  document.getElementById('cfg-git-name').value       = cfg.GIT_USER_NAME || '';
  document.getElementById('cfg-git-email').value      = cfg.GIT_USER_EMAIL || '';
  document.getElementById('cfg-cf-token').value       = cfg.CF_TUNNEL_TOKEN || '';

  // ç«¯å£é…ç½®
  document.getElementById('cfg-port-theia').value    = cfg.PORT_THEIA    || 20001;
  document.getElementById('cfg-port-kanban').value   = cfg.PORT_KANBAN   || 20002;
  document.getElementById('cfg-port-openclaw').value = cfg.PORT_OPENCLAW || 20003;
  document.getElementById('cfg-port-novnc').value    = cfg.PORT_NOVNC    || 20004;
  document.getElementById('cfg-port-vnc').value      = cfg.PORT_VNC      || 20005;

  selectedMode = cfg.MODE || 'desktop';
  document.getElementById('mode-desktop').classList.toggle('active', selectedMode === 'desktop');
  document.getElementById('mode-lite').classList.toggle('active', selectedMode === 'lite');
  document.getElementById('vnc-group').style.display = selectedMode === 'desktop' ? '' : 'none';
}

function collectWizardForm() {
  cfg.AUTH_PASSWORD  = document.getElementById('cfg-auth-password').value  || 'changeme';
  cfg.VNC_PASSWORD   = document.getElementById('cfg-vnc-password').value   || 'changeme';
  cfg.OPENCLAW_TOKEN = document.getElementById('cfg-openclaw-token').value || 'changeme';
  cfg.AUTH_USER      = document.getElementById('cfg-auth-user').value      || 'admin';
  cfg.VNC_RESOLUTION = document.getElementById('cfg-vnc-resolution').value || '1920x1080';
  cfg.GIT_USER_NAME  = document.getElementById('cfg-git-name').value  || '';
  cfg.GIT_USER_EMAIL = document.getElementById('cfg-git-email').value || '';
  cfg.CF_TUNNEL_TOKEN= document.getElementById('cfg-cf-token').value  || '';
  cfg.MODE = selectedMode;

  // ç«¯å£é…ç½®
  cfg.PORT_THEIA    = parseInt(document.getElementById('cfg-port-theia').value)    || 20001;
  cfg.PORT_KANBAN   = parseInt(document.getElementById('cfg-port-kanban').value)   || 20002;
  cfg.PORT_OPENCLAW = parseInt(document.getElementById('cfg-port-openclaw').value) || 20003;
  cfg.PORT_NOVNC    = parseInt(document.getElementById('cfg-port-novnc').value)    || 20004;
  cfg.PORT_VNC      = parseInt(document.getElementById('cfg-port-vnc').value)      || 20005;

  writeConfig(cfg);
}

document.getElementById('btn-step2-back').addEventListener('click', () => setStep(1));

// ç«¯å£æ£€æµ‹æŒ‰é’®
document.getElementById('btn-check-ports').addEventListener('click', async () => {
  const ports = {
    theia: parseInt(document.getElementById('cfg-port-theia').value) || 20001,
    kanban: parseInt(document.getElementById('cfg-port-kanban').value) || 20002,
    openclaw: parseInt(document.getElementById('cfg-port-openclaw').value) || 20003,
    novnc: parseInt(document.getElementById('cfg-port-novnc').value) || 20004,
    vnc: parseInt(document.getElementById('cfg-port-vnc').value) || 20005
  };

  // æ˜¾ç¤ºæ£€æµ‹ä¸­çŠ¶æ€
  for (const key of Object.keys(ports)) {
    const statusEl = document.getElementById(`port-status-${key}`);
    if (statusEl) {
      statusEl.textContent = 'â³';
      statusEl.className = 'port-status checking';
    }
  }

  const results = await app.checkPorts(ports);

  for (const [key, result] of Object.entries(results)) {
    const statusEl = document.getElementById(`port-status-${key}`);
    if (statusEl) {
      if (result.available) {
        statusEl.textContent = 'âœ“';
        statusEl.className = 'port-status ok';
      } else {
        statusEl.textContent = 'âœ—';
        statusEl.className = 'port-status error';
      }
    }
  }
});

document.getElementById('btn-step2-next').addEventListener('click', () => {
  collectWizardForm();
  startLaunch();
});

// â”€â”€â”€ Step 3: Launch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function appendLog(id, text) {
  const el = document.getElementById(id);
  el.textContent += text;
  el.scrollTop = el.scrollHeight;
}

function startLaunch(logId, nextBtn, backBtn) {
  logId   = logId   || 'launch-log';
  nextBtn = nextBtn || 'btn-step3-next';
  backBtn = backBtn || 'btn-step3-back';

  setStep(3);
  document.getElementById(logId).textContent = '';
  document.getElementById(nextBtn).disabled = true;
  document.getElementById(backBtn).disabled = true;

  ensureComposeFile();

  app.dockerUp(cfg,
    (data) => appendLog(logId, data),
    (code) => {
      document.getElementById(backBtn).disabled = false;
      if (code === 0) {
        appendLog(logId, t('dyn_launch_ok'));
        document.getElementById(nextBtn).disabled = false;
      } else {
        appendLog(logId, t('dyn_launch_fail', { code }));
      }
    }
  );
}

document.getElementById('btn-step3-back').addEventListener('click', () => setStep(2));
document.getElementById('btn-step3-next').addEventListener('click', () => {
  showWorkspace();
});

// â”€â”€â”€ Step 4: Re-launch (config exists, container not running) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

document.getElementById('btn-step4-start').addEventListener('click', () => {
  document.getElementById('relaunch-log').style.display = '';
  document.getElementById('relaunch-log').textContent = '';
  document.getElementById('btn-step4-start').disabled = true;

  app.dockerUp(cfg,
    (data) => appendLog('relaunch-log', data),
    (code) => {
      document.getElementById('btn-step4-start').disabled = false;
      if (code === 0) {
        appendLog('relaunch-log', t('dyn_relaunch_ok'));
        showWorkspace();
      } else {
        appendLog('relaunch-log', t('dyn_launch_fail', { code }));
      }
    }
  );
});

document.getElementById('btn-step4-config').addEventListener('click', () => {
  loadConfigIntoWizardForm();
  setStep(2);
});

document.getElementById('btn-step4-enter').addEventListener('click', () => {
  showWorkspace();
});

// â”€â”€â”€ Workspace: tab switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const IFRAME_IDS = { ide: 'iframe-ide', kanban: 'iframe-kanban', vnc: 'iframe-vnc', ai: 'iframe-ai' };
const iframeLoaded = {};

function iframeUrl(tab) {
  switch (tab) {
    case 'ide':    return 'http://localhost:11001';
    case 'kanban': return 'http://localhost:11002';
    case 'vnc':    return `http://localhost:11004/?autoconnect=true&resize=remote&password=${encodeURIComponent(cfg.VNC_PASSWORD)}`;
    case 'ai':     return 'http://localhost:11003/';
  }
}

function activateTab(tab) {
  currentTab = tab;

  // Update tab buttons
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.tab === tab);
  });

  // Show/hide tab action buttons
  const tabActions = document.getElementById('tab-actions');
  tabActions.style.display = (tab === 'status') ? 'none' : 'flex';

  // Show/hide status panel vs iframes
  const panel = document.getElementById('panel-status');
  panel.classList.toggle('visible', tab === 'status');

  Object.keys(IFRAME_IDS).forEach(t => {
    const fr = document.getElementById(IFRAME_IDS[t]);
    fr.classList.toggle('visible', t === tab);
    if (t === tab && !iframeLoaded[t]) {
      fr.src = iframeUrl(t);
      iframeLoaded[t] = true;
    }
  });
}

document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => activateTab(btn.dataset.tab));
});

// Refresh button
document.getElementById('btn-refresh').addEventListener('click', () => {
  if (currentTab === 'status') return;
  const iframe = document.getElementById(IFRAME_IDS[currentTab]);
  iframeLoaded[currentTab] = false;
  iframe.src = iframeUrl(currentTab);
});

// Open in browser button
document.getElementById('btn-open-browser').addEventListener('click', () => {
  if (currentTab === 'status') return;
  const url = iframeUrl(currentTab);
  nw.Shell.openExternal(url);
});

// â”€â”€â”€ Workspace: status polling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function startStatusPolling() {
  app.startPolling(cfg, (containers) => {
    updateStatusUI(containers);
  });
}

function containerRunning(containers) {
  if (!containers || containers.length === 0) return false;
  return containers.some(c => (c.State || c.status || '').toLowerCase().includes('running'));
}

function updateStatusUI(containers) {
  const running = containerRunning(containers);
  const dot  = document.getElementById('status-dot');
  const text = document.getElementById('status-text');

  if (running) {
    dot.className = 'dot dot-green';
    text.textContent = t('dyn_running');
  } else {
    dot.className = 'dot dot-gray';
    text.textContent = t('dyn_stopped');
  }

  // Status grid
  const grid = document.getElementById('status-grid');
  if (containers.length === 0) {
    grid.innerHTML = `<div class="svc-card"><div class="svc-name">webcode</div><div class="svc-state"><span class="dot dot-gray"></span> ${t('dyn_not_running')}</div></div>`;
    return;
  }
  grid.innerHTML = containers.map(c => {
    const state = (c.State || c.Status || 'unknown').toLowerCase();
    const dotClass = state.includes('running') ? 'dot-green' :
                     state.includes('starting') ? 'dot-yellow' : 'dot-red';
    return `<div class="svc-card">
      <div class="svc-name">${escHtml(c.Service || c.Name || 'webcode')}</div>
      <div class="svc-state"><span class="dot ${dotClass}"></span> ${escHtml(state)}</div>
    </div>`;
  }).join('');
}

function escHtml(s) {
  return String(s)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// â”€â”€â”€ Workspace: live logs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function startLogStream() {
  if (logsProc) { try { logsProc.kill(); } catch(e) {} }
  const el = document.getElementById('ws-log');
  el.textContent = '';
  logsProc = app.dockerLogs(cfg, (data) => {
    el.textContent += data;
    el.scrollTop = el.scrollHeight;
  });
}

// â”€â”€â”€ Workspace: start / stop buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

document.getElementById('btn-restart').addEventListener('click', () => {
  if (!confirm(t('dyn_confirm_restart'))) return;
  app.dockerDown(cfg, null, () => {
    app.dockerUp(cfg, null, () => {
      iframeLoaded['ide'] = iframeLoaded['kanban'] = iframeLoaded['vnc'] = iframeLoaded['ai'] = false;
      if (currentTab !== 'status') activateTab(currentTab);
      startLogStream();
    });
  });
});

document.getElementById('btn-stop').addEventListener('click', () => {
  if (!confirm(t('dyn_confirm_stop'))) return;
  app.dockerDown(cfg, null, null);
});

// â”€â”€â”€ Workspace: config form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let wsMode = cfg.MODE || 'desktop';

document.querySelectorAll('#panel-status [data-mode]').forEach(btn => {
  btn.addEventListener('click', () => {
    wsMode = btn.dataset.mode;
    document.getElementById('ws-mode-desktop').classList.toggle('active', wsMode === 'desktop');
    document.getElementById('ws-mode-lite').classList.toggle('active', wsMode === 'lite');
  });
});

function loadConfigIntoWorkspaceForm() {
  document.getElementById('ws-auth-password').value  = cfg.AUTH_PASSWORD || '';
  document.getElementById('ws-vnc-password').value   = cfg.VNC_PASSWORD  || '';
  document.getElementById('ws-openclaw-token').value = cfg.OPENCLAW_TOKEN || '';
  document.getElementById('ws-auth-user').value      = cfg.AUTH_USER || 'admin';
  document.getElementById('ws-vnc-resolution').value = cfg.VNC_RESOLUTION || '1920x1080';
  document.getElementById('ws-git-name').value       = cfg.GIT_USER_NAME || '';
  document.getElementById('ws-git-email').value      = cfg.GIT_USER_EMAIL || '';
  document.getElementById('ws-cf-token').value       = cfg.CF_TUNNEL_TOKEN || '';

  // ç«¯å£é…ç½®
  document.getElementById('ws-port-theia').value    = cfg.PORT_THEIA    || 20001;
  document.getElementById('ws-port-kanban').value   = cfg.PORT_KANBAN   || 20002;
  document.getElementById('ws-port-openclaw').value = cfg.PORT_OPENCLAW || 20003;
  document.getElementById('ws-port-novnc').value    = cfg.PORT_NOVNC    || 20004;
  document.getElementById('ws-port-vnc').value      = cfg.PORT_VNC      || 20005;

  wsMode = cfg.MODE || 'desktop';
  document.getElementById('ws-mode-desktop').classList.toggle('active', wsMode === 'desktop');
  document.getElementById('ws-mode-lite').classList.toggle('active', wsMode === 'lite');
}

function collectWorkspaceForm() {
  cfg.AUTH_PASSWORD  = document.getElementById('ws-auth-password').value  || 'changeme';
  cfg.VNC_PASSWORD   = document.getElementById('ws-vnc-password').value   || 'changeme';
  cfg.OPENCLAW_TOKEN = document.getElementById('ws-openclaw-token').value || 'changeme';
  cfg.AUTH_USER      = document.getElementById('ws-auth-user').value      || 'admin';
  cfg.VNC_RESOLUTION = document.getElementById('ws-vnc-resolution').value || '1920x1080';
  cfg.GIT_USER_NAME  = document.getElementById('ws-git-name').value  || '';
  cfg.GIT_USER_EMAIL = document.getElementById('ws-git-email').value || '';
  cfg.CF_TUNNEL_TOKEN= document.getElementById('ws-cf-token').value  || '';
  cfg.MODE = wsMode;

  // ç«¯å£é…ç½®
  cfg.PORT_THEIA    = parseInt(document.getElementById('ws-port-theia').value)    || 20001;
  cfg.PORT_KANBAN   = parseInt(document.getElementById('ws-port-kanban').value)   || 20002;
  cfg.PORT_OPENCLAW = parseInt(document.getElementById('ws-port-openclaw').value) || 20003;
  cfg.PORT_NOVNC    = parseInt(document.getElementById('ws-port-novnc').value)    || 20004;
  cfg.PORT_VNC      = parseInt(document.getElementById('ws-port-vnc').value)      || 20005;

  writeConfig(cfg);
}

// å·¥ä½œåŒºç«¯å£æ£€æµ‹æŒ‰é’®
document.getElementById('ws-btn-check-ports').addEventListener('click', async () => {
  const ports = {
    theia: parseInt(document.getElementById('ws-port-theia').value) || 20001,
    kanban: parseInt(document.getElementById('ws-port-kanban').value) || 20002,
    openclaw: parseInt(document.getElementById('ws-port-openclaw').value) || 20003,
    novnc: parseInt(document.getElementById('ws-port-novnc').value) || 20004,
    vnc: parseInt(document.getElementById('ws-port-vnc').value) || 20005
  };

  const results = await app.checkPorts(ports);

  let hasConflicts = false;
  for (const [key, result] of Object.entries(results)) {
    if (!result.available) {
      hasConflicts = true;
      break;
    }
  }

  if (hasConflicts) {
    const detail = Object.entries(results)
      .filter(([_, r]) => !r.available)
      .map(([_, r]) => t('dyn_port_occupied', { name: r.name, port: r.port }))
      .join('\n');
    if (confirm(t('dyn_port_conflict') + '\n' + detail)) {
      const fixedPorts = await app.autoFixPorts(ports);

      // æ›´æ–°è¡¨å•
      document.getElementById('ws-port-theia').value    = fixedPorts.theia;
      document.getElementById('ws-port-kanban').value   = fixedPorts.kanban;
      document.getElementById('ws-port-openclaw').value = fixedPorts.openclaw;
      document.getElementById('ws-port-novnc').value    = fixedPorts.novnc;
      document.getElementById('ws-port-vnc').value      = fixedPorts.vnc;

      alert(t('dyn_port_fixed'));
    }
  } else {
    alert(t('dyn_port_ok'));
  }
});

document.getElementById('btn-save-config').addEventListener('click', () => {
  collectWorkspaceForm();
  // Restart proxies with new credentials
  app.startProxies(cfg);
  // Reset iframes so they reload with new auth
  Object.keys(iframeLoaded).forEach(k => iframeLoaded[k] = false);
  alert(t('dyn_config_saved'));
});

document.getElementById('btn-save-restart').addEventListener('click', () => {
  collectWorkspaceForm();
  app.startProxies(cfg);
  Object.keys(iframeLoaded).forEach(k => iframeLoaded[k] = false);
  app.dockerDown(cfg, null, () => {
    app.dockerUp(cfg, (data) => {
      document.getElementById('ws-log').textContent += data;
      document.getElementById('ws-log').scrollTop = document.getElementById('ws-log').scrollHeight;
    }, () => {
      if (currentTab !== 'status') activateTab(currentTab);
      startLogStream();
    });
  });
});

// â”€â”€â”€ Boot logic â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function boot() {
  // Apply translations to all annotated elements
  applyTranslations();

  if (!configExists()) {
    // First run: wizard from step 1
    showWizard(1);
    runDockerCheck();
  } else {
    // Config exists: check if container is running
    ensureComposeFile();
    app.dockerPs(cfg, (err, containers) => {
      if (!err && containerRunning(containers)) {
        // Already running â†’ go straight to workspace
        showWorkspace();
      } else {
        // Not running â†’ step 4
        showWizard(4);
      }
    });
  }
}

boot();
</script>
</body>
</html>
