<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>webcode</title>
  <!-- ä¸»é¢˜åˆå§‹åŒ–ï¼šåœ¨ CSS åŠ è½½å‰è®¾ç½® data-themeï¼Œé˜²æ­¢é¡µé¢é—ªçƒ -->
  <script>(function(){
    var t = safeLocalStorage.getItem('webcode-theme', 'dark');
    document.documentElement.setAttribute('data-theme', t);
  })();</script>
  <link rel="stylesheet" href="src/style.css">
</head>
<body>

<div id="app-layout">

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SIDEBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="sidebar" class="sidebar-collapsed">
  <div class="sidebar-header">
    <button class="sidebar-toggle" id="sidebar-toggle" title="åˆ‡æ¢ä¾§è¾¹æ ">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
    </button>
    <span class="sidebar-title" data-i18n="sidebar_title">å®ä¾‹</span>
  </div>
  <div class="instance-list" id="instance-list"></div>
  <div class="sidebar-footer">
    <button class="sidebar-add-btn" id="sidebar-add-btn">
      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      <span class="sidebar-add-label" data-i18n="btn_add_instance">æ–°å®ä¾‹</span>
    </button>
  </div>
</div>

<div id="main-content">

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• WIZARD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="wizard">
  <div class="wizard-card">
    <div class="wizard-header">
      <h1 data-i18n="title">webcode å¯åŠ¨å™¨</h1>
      <div class="header-controls">
        <button class="theme-cycle-btn" id="theme-cycle-btn-wizard" title="åˆ‡æ¢ä¸»é¢˜">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg>
          <span>æš—è‰²</span>
        </button>
        <button class="lang-cycle-btn"  id="lang-cycle-btn-wizard">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" x2="22" y1="12" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
          <span>EN</span>
        </button>
      </div>
    </div>
    <p class="subtitle" data-i18n="subtitle">æµè§ˆå™¨å¯è®¿é—®çš„å¼€å‘ç¯å¢ƒï¼Œç”± Docker é©±åŠ¨</p>

    <!-- Step dots -->
    <div class="step-indicator" id="step-dots"></div>

    <!-- Step 1: Docker check -->
    <div id="step-1">
      <p class="text-muted text-sm" style="margin-bottom:16px" data-i18n="step1_detecting">æ­£åœ¨æ£€æµ‹è¿è¡Œç¯å¢ƒâ€¦</p>
      <div id="check-docker-installed" class="check-row">
        <span class="icon">ğŸ³</span>
        <span class="label" data-i18n="docker_installed">Docker å·²å®‰è£…</span>
        <span class="badge badge-checking" data-i18n="badge_checking">æ£€æµ‹ä¸­</span>
      </div>
      <div id="check-docker-running" class="check-row">
        <span class="icon">â–¶</span>
        <span class="label" data-i18n="docker_running">Docker æ­£åœ¨è¿è¡Œ</span>
        <span class="badge badge-checking" data-i18n="badge_checking">æ£€æµ‹ä¸­</span>
      </div>
      <div id="docker-help" style="display:none; margin-top:16px; padding:12px 14px;
           border-left:3px solid var(--accent); background:var(--card-bg);
           border-radius:6px; font-size:12px; line-height:1.7">
        <div id="docker-help-mac" style="display:none">
          <strong data-i18n="docker_help_mac_title">macOSï¼šå®‰è£… Docker Desktop</strong>
          <ol style="margin:8px 0 8px 16px; padding:0">
            <li><a class="link" id="docker-dl-link" data-i18n="docker_help_mac_dl">ä¸‹è½½ Docker Desktop for Mac</a></li>
            <li data-i18n="docker_help_mac_step2">æ‰“å¼€ .dmgï¼Œå°† Docker æ‹–å…¥åº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹</li>
            <li data-i18n="docker_help_mac_step3">å¯åŠ¨ Docker Desktopï¼Œç­‰å¾…èœå•æ å›¾æ ‡ç¨³å®š</li>
          </ol>
        </div>
        <div id="docker-help-win" style="display:none">
          <strong data-i18n="docker_help_win_title">Windowsï¼šå®‰è£… Docker Desktop</strong>
          <ol style="margin:8px 0 8px 16px; padding:0">
            <li><a class="link" id="docker-dl-link-win" data-i18n="docker_help_win_dl">ä¸‹è½½ Docker Desktop for Windows</a></li>
            <li data-i18n="docker_help_win_step2">è¿è¡Œå®‰è£…ç¨‹åºï¼Œå¯ç”¨ WSL2 åç«¯</li>
            <li data-i18n="docker_help_win_step3">å®‰è£…å®Œæˆé‡å¯åï¼Œå¯åŠ¨ Docker Desktop</li>
          </ol>
        </div>
        <div id="docker-help-notrunning" style="display:none">
          <strong data-i18n="docker_help_notrunning_title">Docker å·²å®‰è£…ä½†æœªè¿è¡Œ</strong>
          <p style="margin:6px 0" data-i18n="docker_help_notrunning_body">è¯·æ‰“å¼€ Docker Desktopï¼Œç­‰å¾…å›¾æ ‡ç¨³å®šåé‡æ–°æ£€æµ‹ã€‚</p>
        </div>
      </div>
      <div class="action-row">
        <button class="btn-secondary btn-sm" id="btn-recheck" data-i18n="btn_recheck">é‡æ–°æ£€æµ‹</button>
        <button class="btn-primary" id="btn-step1-next" disabled data-i18n="btn_step1_next">ä¸‹ä¸€æ­¥</button>
      </div>
    </div>

    <!-- Step 2: Config -->
    <div id="step-2" style="display:none">
      <div class="adv-block">
        <div class="adv-block-title" data-i18n="adv_title_run_mode">è¿è¡Œæ¨¡å¼</div>
        <div class="adv-inline-row">
          <div style="flex:1">
            <div class="toggle-row">
              <button class="toggle-btn active" data-mode="desktop" id="mode-desktop">
                <span class="btn-icon" data-icon="modeDesktop"></span>
                <span data-i18n="mode_desktop_short">Desktop</span>
              </button>
              <button class="toggle-btn" data-mode="lite" id="mode-lite">
                <span class="btn-icon" data-icon="modeLite"></span>
                <span data-i18n="mode_lite_short">Lite</span>
              </button>
            </div>
          </div>
          <div class="form-group" style="flex:1;margin-bottom:0">
            <label data-i18n="label_vnc_resolution">VNC åˆ†è¾¨ç‡</label>
            <input type="text" id="cfg-vnc-resolution" placeholder="1920x1080" list="vnc-resolution-list">
          </div>
        </div>
      </div>
      <div class="adv-block">
        <div class="adv-block-title" data-i18n="adv_title_auth">è®¿é—®è®¤è¯</div>
        <div class="config-grid">
          <div class="form-group">
            <label data-i18n="label_auth_user">Basic Auth ç”¨æˆ·å</label>
            <input type="text" id="cfg-auth-user" placeholder="admin">
          </div>
          <div class="form-group">
            <label data-i18n="label_auth_password">Basic Auth å¯†ç </label>
            <div class="input-with-eye">
              <input type="password" id="cfg-auth-password" placeholder="changeme">
              <button type="button" class="eye-toggle" data-target="cfg-auth-password" tabindex="-1"></button>
            </div>
          </div>
          <div id="vnc-group" class="form-group">
            <label data-i18n="label_vnc_password">VNC å¯†ç </label>
            <div class="input-with-eye">
              <input type="password" id="cfg-vnc-password" placeholder="changeme">
              <button type="button" class="eye-toggle" data-target="cfg-vnc-password" tabindex="-1"></button>
            </div>
          </div>
          <div class="form-group">
            <label data-i18n="label_openclaw_token">OpenClaw Token</label>
            <div class="input-with-eye">
              <input type="password" id="cfg-openclaw-token" placeholder="changeme">
              <button type="button" class="eye-toggle" data-target="cfg-openclaw-token" tabindex="-1"></button>
            </div>
          </div>
        </div>
      </div>
      <details>
        <summary data-i18n="summary_advanced">é«˜çº§é€‰é¡¹</summary>
        <div class="adv-block" style="margin-top:10px">
          <div class="adv-block-title" data-i18n="adv_title_git">Git é…ç½®</div>
          <div class="config-grid">
            <div class="form-group">
              <label data-i18n="label_git_name">Git ç”¨æˆ·å</label>
              <input type="text" id="cfg-git-name" data-i18n-placeholder="ph_optional" placeholder="ï¼ˆå¯é€‰ï¼‰">
            </div>
            <div class="form-group">
              <label data-i18n="label_git_email">Git é‚®ç®±</label>
              <input type="text" id="cfg-git-email" data-i18n-placeholder="ph_optional" placeholder="ï¼ˆå¯é€‰ï¼‰">
            </div>
          </div>
        </div>
        <div class="adv-block">
          <div class="adv-block-title" data-i18n="adv_title_cloudflare">Cloudflare Tunnel</div>
          <div class="form-group">
            <label data-i18n="label_cf_token">Cloudflare Tunnel Tokenï¼ˆå¯é€‰ï¼‰</label>
            <input type="text" id="cfg-cf-token" placeholder="">
            <p class="help-text" style="font-size:11px; color:var(--text-muted); margin-top:4px">
              <span data-i18n="cf_help_text">å¦‚ä½•è·å– Tokenï¼Ÿ</span>
              <a class="link" id="cf-help-link-wizard" data-i18n="cf_help_link">Cloudflare Zero Trust æ§åˆ¶å°</a><span data-i18n="cf_help_steps"> â†’ Networks â†’ Tunnels â†’ åˆ›å»º Tunnel â†’ å¤åˆ¶ token</span>
            </p>
          </div>
        </div>
        <div class="adv-block">
          <div class="adv-block-title" data-i18n="adv_title_ports">ç«¯å£é…ç½®</div>
          <div class="port-grid" id="port-grid">
            <div class="port-item">
              <span class="port-label">Theia IDE</span>
              <input type="number" id="cfg-port-theia" class="port-input" placeholder="20001">
              <span class="port-status" id="port-status-theia"></span>
            </div>
            <div class="port-item">
              <span class="port-label">Vibe Kanban</span>
              <input type="number" id="cfg-port-kanban" class="port-input" placeholder="20002">
              <span class="port-status" id="port-status-kanban"></span>
            </div>
            <div class="port-item">
              <span class="port-label">OpenClaw AI</span>
              <input type="number" id="cfg-port-openclaw" class="port-input" placeholder="20003">
              <span class="port-status" id="port-status-openclaw"></span>
            </div>
            <div class="port-item">
              <span class="port-label">noVNC</span>
              <input type="number" id="cfg-port-novnc" class="port-input" placeholder="20004">
              <span class="port-status" id="port-status-novnc"></span>
            </div>
            <div class="port-item">
              <span class="port-label">TigerVNC</span>
              <input type="number" id="cfg-port-vnc" class="port-input" placeholder="20005">
              <span class="port-status" id="port-status-vnc"></span>
            </div>
            <div class="port-item">
              <span class="port-label">Audio WebSocket</span>
              <input type="number" id="cfg-port-audio" class="port-input" placeholder="(disabled, uses /audio path)" disabled style="opacity:0.5">
              <span class="port-status" id="port-status-audio">âœ“ Uses /audio on port 20004</span>
            </div>
          </div>
          <button class="btn-secondary btn-sm" id="btn-check-ports" style="margin-top:8px">
            <span class="btn-icon" data-icon="checkPorts"></span>
            <span data-i18n="btn_check_ports">æ£€æµ‹ç«¯å£å†²çª</span>
          </button>
          <hr class="adv-divider">
          <div class="adv-sub-row">
            <span class="adv-sub-title" data-i18n="adv_sub_custom_ports">è‡ªå®šä¹‰ç«¯å£æ˜ å°„</span>
            <button class="btn-secondary btn-sm" id="btn-add-port-map" data-i18n="btn_add_port_map">+ æ·»åŠ ç«¯å£</button>
          </div>
          <div id="port-map-list"></div>
          <div id="custom-port-status" style="font-size:11px;margin-top:4px"></div>
        </div>
        <div class="adv-block">
          <div class="adv-block-title" data-i18n="adv_title_volumes">ç›®å½•æŒ‚è½½</div>
          <div id="named-vols-display" class="named-vols-block"></div>
          <hr class="adv-divider">
          <div class="adv-sub-row">
            <span class="adv-sub-title" data-i18n="adv_sub_custom_volumes">è‡ªå®šä¹‰ç›®å½•æŒ‚è½½</span>
            <button class="btn-secondary btn-sm" id="btn-add-volume" data-i18n="btn_add_volume">+ æ·»åŠ </button>
          </div>
          <div id="volume-list"></div>
        </div>
      </details>
      <div class="action-row">
        <button class="btn-secondary btn-sm" id="btn-step2-back" data-i18n="btn_step2_back">ä¸Šä¸€æ­¥</button>
        <button class="btn-primary" id="btn-step2-next" data-i18n="btn_step2_next">ä¸‹ä¸€æ­¥ï¼šå¯åŠ¨å®¹å™¨</button>
      </div>
    </div>

    <!-- Step 3: Launch -->
    <div id="step-3" style="display:none">
      <p class="text-muted text-sm" style="margin-bottom:12px" data-i18n="step3_desc">æ­£åœ¨å¯åŠ¨ webcode å®¹å™¨ï¼Œé¦–æ¬¡è¿è¡Œå°†æ‹‰å–é•œåƒï¼ˆçº¦ 2â€“5 åˆ†é’Ÿï¼‰â€¦</p>
      <div class="log-area" id="launch-log" style="height:240px"></div>
      <div class="action-row">
        <button class="btn-secondary btn-sm" id="btn-step3-back" data-i18n="btn_step3_back">è¿”å›é…ç½®</button>
        <button class="btn-primary" id="btn-step3-next" disabled data-i18n="btn_step3_next">è¿›å…¥å·¥ä½œåŒº â†’</button>
      </div>
    </div>

    <!-- Step 4: Ready (re-launch) -->
    <div id="step-4" style="display:none">
      <p class="text-muted text-sm" style="margin-bottom:16px" data-i18n="step4_desc">é…ç½®å·²åŠ è½½ï¼Œå®¹å™¨å½“å‰æœªè¿è¡Œã€‚</p>
      <div class="action-row" style="justify-content:flex-start; flex-wrap:wrap; gap:10px">
        <button class="btn-primary" id="btn-step4-start">
          <span class="btn-icon" data-icon="playArrow"></span>
          <span data-i18n="btn_step4_start">å¯åŠ¨å®¹å™¨</span>
        </button>
        <button class="btn-secondary btn-sm" id="btn-step4-config" data-i18n="btn_step4_config">ä¿®æ”¹é…ç½®</button>
        <button class="btn-secondary btn-sm" id="btn-step4-enter" data-i18n="btn_step4_view_status">æŸ¥çœ‹çŠ¶æ€</button>
      </div>
      <div class="log-area mt-3" id="relaunch-log" style="height:200px; display:none"></div>
      <div class="text-muted text-sm" style="margin-top:12px">
        <span data-i18n="step4_docker_trouble">Docker æœªè¿è¡Œæˆ–é‡åˆ°é—®é¢˜ï¼Ÿ</span>
        <a href="#" id="link-redetect-docker" data-i18n="step4_redetect">[é‡æ–°æ£€æµ‹]</a>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• WORKSPACE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="workspace">
  <!-- Top bar -->
  <div class="topbar">
    <button class="tab-btn" id="tab-status" data-tab="status">
      <span class="tab-icon" data-icon="tabStatus"></span>
      <span data-i18n="tab_status">çŠ¶æ€</span>
    </button>
    <button class="tab-btn" id="tab-vnc"    data-tab="vnc">
      <span class="tab-icon" data-icon="tabVnc"></span>
      <span data-i18n="tab_vnc">æ¡Œé¢</span>
    </button>
    <button class="tab-btn" id="tab-ide"    data-tab="ide">
      <span class="tab-icon" data-icon="tabIde"></span>
      <span data-i18n="tab_ide">IDE</span>
    </button>
    <button class="tab-btn" id="tab-kanban" data-tab="kanban">
      <span class="tab-icon" data-icon="tabKanban"></span>
      <span data-i18n="tab_kanban">çœ‹æ¿</span>
    </button>
    <button class="tab-btn" id="tab-ai"     data-tab="ai">
      <span class="tab-icon" data-icon="tabAi"></span>
      <span data-i18n="tab_ai">AI</span>
    </button>
    <span class="topbar-spacer"></span>
    <div class="tab-actions" id="tab-actions" style="display:none">
      <button class="btn-icon" id="btn-refresh"      data-i18n-title="title_refresh"      title="åˆ·æ–°">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"></path><path d="M16 21h5v-5"></path></svg>
      </button>
      <button class="btn-icon" id="btn-open-browser" data-i18n-title="title_open_browser" title="åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
      </button>
    </div>
    <div class="status-pill">
      <span class="dot dot-gray" id="status-dot"></span>
      <span id="status-text" data-i18n="status_detecting">æ£€æµ‹ä¸­â€¦</span>
    </div>
    <div id="update-banner" class="update-banner" style="display:none" onclick="showUpdateModal()">
      <div class="update-banner-content">
        <span class="update-banner-icon">ğŸ“¦</span>
        <span class="update-banner-text">æœ‰æ–°ç‰ˆæœ¬å¯ç”¨</span>
        <span class="update-banner-hint">ç‚¹å‡»æŸ¥çœ‹</span>
      </div>
    </div>
    <button class="theme-cycle-btn" id="theme-cycle-btn-ws" title="åˆ‡æ¢ä¸»é¢˜" style="margin-right:4px">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg>
      <span>æš—è‰²</span>
    </button>
    <button class="lang-cycle-btn"  id="lang-cycle-btn-ws" style="margin-right:6px">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" x2="22" y1="12" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
      <span>EN</span>
    </button>
    <div class="topbar-actions">
      <button class="btn-secondary btn-sm" id="btn-restart">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path><path d="M8 21H3v-5"></path></svg>
        <span data-i18n="btn_restart">é‡å¯</span>
      </button>
      <button class="btn-secondary btn-sm" id="btn-stop">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>
        <span data-i18n="btn_stop">åœæ­¢</span>
      </button>
    </div>
  </div>

  <!-- Content area -->
  <div class="iframe-area" id="iframe-area">
    <!-- Status panel (not an iframe) -->
    <div id="panel-status">
      <!-- é¡¶éƒ¨ï¼šå®¹å™¨çŠ¶æ€ï¼ˆå·¦ï¼‰+ è¿›ç¨‹çŠ¶æ€ï¼ˆå³ï¼‰å¹¶æ’ -->
      <div class="status-top-row">
        <div class="status-top-left">
          <h3 class="status-section-title" data-i18n="h_container_status">å®¹å™¨çŠ¶æ€</h3>
          <div class="status-grid" id="status-grid">
            <div class="svc-card">
              <div class="svc-name">webcode</div>
              <div class="svc-state"><span class="dot dot-gray"></span> <span id="main-state" data-i18n="state_unknown">æœªçŸ¥</span></div>
            </div>
          </div>
        </div>
        <div id="supervisor-section" class="status-top-right" style="display:none">
          <h3 class="status-section-title" data-i18n="h_supervisor_status">è¿›ç¨‹çŠ¶æ€</h3>
          <div class="status-grid" id="supervisor-grid"></div>
        </div>
      </div>

      <!-- Config section -->
      <div class="config-section">
        <h3 data-i18n="h_config">é…ç½®</h3>
        <div class="adv-block">
          <div class="adv-block-title" data-i18n="adv_title_run_mode">è¿è¡Œæ¨¡å¼</div>
          <div class="adv-inline-row">
            <div style="flex:1">
              <div class="toggle-row">
                <button class="toggle-btn" data-mode="desktop" id="ws-mode-desktop">
                  <span class="btn-icon" data-icon="modeDesktop"></span>
                  <span data-i18n="mode_desktop_short">Desktop</span>
                </button>
                <button class="toggle-btn" data-mode="lite" id="ws-mode-lite">
                  <span class="btn-icon" data-icon="modeLite"></span>
                  <span data-i18n="mode_lite_short">Lite</span>
                </button>
              </div>
            </div>
            <div class="form-group" style="flex:1;margin-bottom:0">
              <label data-i18n="label_vnc_resolution">VNC åˆ†è¾¨ç‡</label>
              <input type="text" id="ws-vnc-resolution" list="vnc-resolution-list">
            </div>
          </div>
        </div>
        <div class="adv-block">
          <div class="adv-block-title" data-i18n="adv_title_auth">è®¿é—®è®¤è¯</div>
          <div class="config-grid">
            <div class="form-group">
              <label data-i18n="label_auth_user">Basic Auth ç”¨æˆ·å</label>
              <input type="text" id="ws-auth-user">
            </div>
            <div class="form-group">
              <label data-i18n="label_auth_password">Basic Auth å¯†ç </label>
              <div class="input-with-eye">
                <input type="password" id="ws-auth-password">
                <button type="button" class="eye-toggle" data-target="ws-auth-password" tabindex="-1"></button>
              </div>
            </div>
            <div class="form-group">
              <label data-i18n="label_vnc_password">VNC å¯†ç </label>
              <div class="input-with-eye">
                <input type="password" id="ws-vnc-password">
                <button type="button" class="eye-toggle" data-target="ws-vnc-password" tabindex="-1"></button>
              </div>
            </div>
            <div class="form-group">
              <label data-i18n="label_openclaw_token">OpenClaw Token</label>
              <div class="input-with-eye">
                <input type="password" id="ws-openclaw-token">
                <button type="button" class="eye-toggle" data-target="ws-openclaw-token" tabindex="-1"></button>
              </div>
            </div>
          </div>
        </div>
        <div class="adv-block">
          <div class="adv-block-title" data-i18n="adv_title_git">Git é…ç½®</div>
          <div class="config-grid">
            <div class="form-group">
              <label data-i18n="label_git_name">Git ç”¨æˆ·å</label>
              <input type="text" id="ws-git-name">
            </div>
            <div class="form-group">
              <label data-i18n="label_git_email">Git é‚®ç®±</label>
              <input type="text" id="ws-git-email">
            </div>
          </div>
        </div>
        <div class="adv-block">
          <div class="adv-block-title" data-i18n="adv_title_cloudflare">Cloudflare Tunnel</div>
          <div class="form-group">
            <label data-i18n="label_cf_token">Cloudflare Tunnel Tokenï¼ˆå¯é€‰ï¼‰</label>
            <input type="text" id="ws-cf-token">
            <p class="help-text" style="font-size:11px; color:var(--text-muted); margin-top:4px">
              <span data-i18n="cf_help_text">å¦‚ä½•è·å– Tokenï¼Ÿ</span>
              <a class="link" id="cf-help-link-ws" data-i18n="cf_help_link">Cloudflare Zero Trust æ§åˆ¶å°</a><span data-i18n="cf_help_steps"> â†’ Networks â†’ Tunnels â†’ åˆ›å»º Tunnel â†’ å¤åˆ¶ token</span>
            </p>
          </div>
        </div>
        <div class="adv-block">
          <div class="adv-block-title" data-i18n="adv_title_ports">ç«¯å£é…ç½®</div>
          <div class="port-grid" id="ws-port-grid">
            <div class="port-item">
              <span class="port-label">Theia IDE</span>
              <input type="number" id="ws-port-theia" class="port-input">
            </div>
            <div class="port-item">
              <span class="port-label">Vibe Kanban</span>
              <input type="number" id="ws-port-kanban" class="port-input">
            </div>
            <div class="port-item">
              <span class="port-label">OpenClaw AI</span>
              <input type="number" id="ws-port-openclaw" class="port-input">
            </div>
            <div class="port-item">
              <span class="port-label">noVNC</span>
              <input type="number" id="ws-port-novnc" class="port-input">
            </div>
            <div class="port-item">
              <span class="port-label">TigerVNC</span>
              <input type="number" id="ws-port-vnc" class="port-input">
            </div>
            <div class="port-item">
              <span class="port-label">Audio WebSocket</span>
              <input type="number" id="ws-port-audio" class="port-input">
            </div>
          </div>
          <button class="btn-secondary btn-sm" id="ws-btn-check-ports" style="margin-top:8px">
            <span class="btn-icon" data-icon="checkPorts"></span>
            <span data-i18n="btn_check_ports">æ£€æµ‹ç«¯å£å†²çª</span>
          </button>
          <hr class="adv-divider">
          <div class="adv-sub-row">
            <span class="adv-sub-title" data-i18n="adv_sub_custom_ports">è‡ªå®šä¹‰ç«¯å£æ˜ å°„</span>
            <button class="btn-secondary btn-sm" id="ws-btn-add-port-map" data-i18n="btn_add_port_map">+ æ·»åŠ ç«¯å£</button>
          </div>
          <div id="ws-port-map-list"></div>
          <div id="ws-custom-port-status" style="font-size:11px;margin-top:4px"></div>
        </div>
        <div class="adv-block">
          <div class="adv-block-title" data-i18n="adv_title_volumes">ç›®å½•æŒ‚è½½</div>
          <div id="ws-named-vols-display" class="named-vols-block"></div>
          <hr class="adv-divider">
          <div class="adv-sub-row">
            <span class="adv-sub-title" data-i18n="adv_sub_custom_volumes">è‡ªå®šä¹‰ç›®å½•æŒ‚è½½</span>
            <button class="btn-secondary btn-sm" id="ws-btn-add-volume" data-i18n="btn_add_volume">+ æ·»åŠ </button>
          </div>
          <div id="ws-volume-list"></div>
        </div>
        <div class="action-row" style="margin-top:0">
          <button class="btn-secondary btn-sm" id="btn-save-config" style="display:flex;align-items:center;gap:5px">
            <span class="btn-icon" data-icon="save"></span>
            <span data-i18n="btn_save_config">ä¿å­˜é…ç½®</span>
          </button>
          <button class="btn-primary btn-sm" id="btn-save-restart" style="display:flex;align-items:center;gap:5px">
            <span class="btn-icon" data-icon="restart"></span>
            <span data-i18n="btn_save_restart">ä¿å­˜å¹¶é‡å¯å®¹å™¨</span>
          </button>
        </div>
      </div>

      <!-- Logs -->
      <div>
        <h3 style="font-size:14px; font-weight:600; margin-bottom:8px" data-i18n="h_container_logs">å®¹å™¨æ—¥å¿—</h3>
        <div class="log-area" id="ws-log" style="height:260px"></div>
      </div>
    </div>

    <!-- Container not running overlay (shown for non-status tabs when container stopped) -->
    <div id="container-stopped-overlay" style="display:none">
      <div class="overlay-card">
        <div class="overlay-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="9" y1="9" x2="15" y2="15"></line>
            <line x1="15" y1="9" x2="9" y2="15"></line>
          </svg>
        </div>
        <h3 data-i18n="overlay_stopped_title">å®¹å™¨æœªè¿è¡Œ</h3>
        <p class="text-muted" data-i18n="overlay_stopped_desc">å®¹å™¨å½“å‰æœªè¿è¡Œï¼Œæ— æ³•è®¿é—®æ­¤åŠŸèƒ½ã€‚</p>
        <div class="overlay-actions">
          <button class="btn-secondary" id="overlay-btn-start">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path>
              <path d="M21 3v5h-5"></path>
            </svg>
            <span data-i18n="btn_start_container">å¯åŠ¨å®¹å™¨</span>
          </button>
          <button class="btn-secondary btn-sm" id="overlay-btn-status" data-i18n="btn_view_status">æŸ¥çœ‹çŠ¶æ€</button>
        </div>
      </div>
    </div>

    <!-- iframes (lazy â€“ src set when first activated) -->
    <iframe id="iframe-ide"
      sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-modals allow-downloads"
      allow="clipboard-read; clipboard-write; fullscreen"></iframe>

    <iframe id="iframe-kanban"
      sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-modals"
      allow="clipboard-read; clipboard-write"></iframe>

    <iframe id="iframe-vnc"
      sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-pointer-lock"
      allow="autoplay; fullscreen; clipboard-read; clipboard-write; pointer-lock"></iframe>

    <iframe id="iframe-ai"
      sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-modals"
      allow="clipboard-read; clipboard-write"></iframe>
  </div>
</div>

</div><!-- #main-content -->
</div><!-- #app-layout -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ADD-INSTANCE MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="add-instance-modal">
  <div class="modal-card">
    <h3 data-i18n="modal_add_instance_title">æ·»åŠ å®ä¾‹</h3>
    <div class="form-group" style="margin-bottom:0">
      <label data-i18n="label_instance_name">å®ä¾‹åç§°</label>
      <input type="text" id="new-instance-name" data-i18n-placeholder="ph_instance_name" placeholder="æˆ‘çš„é¡¹ç›®">
    </div>
    <div class="action-row" style="margin-top:0">
      <button class="btn-secondary btn-sm" id="modal-cancel" data-i18n="btn_cancel">å–æ¶ˆ</button>
      <button class="btn-primary btn-sm"   id="modal-confirm" data-i18n="btn_confirm">ç¡®å®š</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• UPDATE PROGRESS PANEL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="update-progress-panel" style="display:none;position:fixed;top:60px;right:20px;z-index:20000;width:320px;background:var(--surface);border:1px solid var(--border);border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.3);padding:16px;">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
    <h3 style="font-size:14px;font-weight:600;margin:0;display:flex;align-items:center;gap:8px;">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="checking-icon" style="animation:spin 1s linear infinite"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/></svg>
      <span data-i18n="update_checking">æ£€æŸ¥æ›´æ–°ä¸­...</span>
    </h3>
    <button id="btn-cancel-update-check" style="background:none;border:none;color:var(--text-muted);cursor:pointer;padding:4px;border-radius:4px;" title="å–æ¶ˆ">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
    </button>
  </div>
  <div style="font-size:12px;color:var(--text-muted);line-height:1.6;">
    <div class="check-step" data-step="container-local">
      <span class="step-icon">â—‹</span>
      <span class="step-text">æ£€æŸ¥æœ¬åœ°å®¹å™¨ç‰ˆæœ¬...</span>
    </div>
    <div class="check-step" data-step="container-remote">
      <span class="step-icon">â—‹</span>
      <span class="step-text">æ£€æŸ¥è¿œç¨‹å®¹å™¨ç‰ˆæœ¬...</span>
    </div>
    <div class="check-step" data-step="launcher">
      <span class="step-icon">â—‹</span>
      <span class="step-text" data-i18n="update_checking_launcher">æ­£åœ¨æ£€æŸ¥å¯åŠ¨å™¨æ›´æ–°...</span>
    </div>
    <div class="check-step" data-step="complete">
      <span class="step-icon">â—‹</span>
      <span class="step-text">å®Œæˆæ£€æŸ¥</span>
    </div>
  </div>
  <div style="font-size:11px;color:var(--text-muted);margin-top:10px;text-align:center;">
    å¦‚æ£€æŸ¥æ—¶é—´è¿‡é•¿å¯ç‚¹å‡»å³ä¸Šè§’å–æ¶ˆ
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• UPDATE MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="update-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);z-index:10000;align-items:center;justify-content:center">
  <div class="modal-card">
    <h3 data-i18n="modal_update_title">æœ‰æ–°ç‰ˆæœ¬å¯ç”¨</h3>
    <div class="update-info">
      <p id="update-desc"></p>
      <p class="update-versions" id="update-versions" style="display:none">
        <span class="text-muted">Current: </span><span id="current-version">-</span><br>
        <span class="text-muted">Latest: </span><span id="latest-version">-</span>
      </p>
    </div>
    <div id="update-progress" class="update-progress" style="display:none">
      <div class="progress-bar"><div class="progress-fill"></div></div>
      <p class="progress-text" id="update-progress-text" data-i18n="update_downloading">æ­£åœ¨ä¸‹è½½é•œåƒ...</p>
    </div>
    <div id="update-result" style="display:none;margin:12px 0"></div>
    <div id="launcher-update-section" class="launcher-update-section" style="display:none">
      <a class="launcher-update-link" id="launcher-update-link" href="#" onclick="return false;">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
        <span data-i18n="launcher_update_link">ä¸‹è½½æœ€æ–°å¯åŠ¨å™¨</span>
      </a>
    </div>
    <div class="action-row" style="margin-top:0">
      <button id="btn-update-cancel" class="btn-secondary btn-sm" data-i18n="btn_update_later">ç¨åæé†’</button>
      <button id="btn-update-confirm" class="btn-primary btn-sm" data-i18n="btn_update_now">ç«‹å³æ›´æ–°</button>
    </div>
  </div>
</div>

<!-- Process Logs Modal -->
<div id="process-logs-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);z-index:10000;align-items:center;justify-content:center">
  <div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:20px;width:90vw;max-width:800px;max-height:80vh;display:flex;flex-direction:column">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
      <h3 id="process-logs-title" style="font-size:16px;font-weight:600;margin:0">è¿›ç¨‹æ—¥å¿—</h3>
      <button id="close-logs-modal" style="background:none;border:none;color:var(--text-muted);cursor:pointer;padding:4px">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
      </button>
    </div>
    <div id="process-logs-content" class="log-area" style="flex:1;overflow:auto;font-family:monospace;font-size:12px;line-height:1.6;white-space:pre-wrap;word-break:break-all"></div>
    <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
      <button class="btn-primary btn-sm" id="close-logs-btn">å…³é—­</button>
    </div>
  </div>
</div>

<!-- å®¿ä¸»æœºè·¯å¾„ï¼šå»ºè®®é€‰å·²æœ‰å‘½åå·åç§° -->
<datalist id="host-paths-list">
  <option value="dna-data">
  <option value="projects">
  <option value="vibe-kanban-data">
  <option value="theia-data">
  <option value="user-data">
  <option value="openclaw-data">
  <option value="chrome-data">
  <option value="gitconfig">
  <option value="recordings">
</datalist>

<!-- å®¹å™¨è·¯å¾„ï¼šå»ºè®®å¸¸ç”¨å®¹å™¨å†…è·¯å¾„ -->
<datalist id="container-paths-list">
  <option value="/home/ubuntu/projects">
  <option value="/home/ubuntu/dna">
  <option value="/home/ubuntu/.theia">
  <option value="/home/ubuntu/.local/share/vibe-kanban">
  <option value="/home/ubuntu/.local/share">
  <option value="/home/ubuntu/.openclaw">
  <option value="/home/ubuntu/.config">
  <option value="/home/ubuntu/.gitconfig-vol">
  <option value="/home/ubuntu/recordings">
</datalist>

<!-- VNC åˆ†è¾¨ç‡é¢„è®¾ -->
<datalist id="vnc-resolution-list">
  <option value="1280x720">
  <option value="1366x768">
  <option value="1440x900">
  <option value="1600x900">
  <option value="1920x1080">
  <option value="2560x1440">
  <option value="3840x2160">
</datalist>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCRIPTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- æ—©æœŸè„šæœ¬ï¼šåœ¨é¡µé¢ä¸Šæ˜¾ç¤º JS é”™è¯¯ï¼ˆä¸ä¾èµ– DevToolsï¼‰ -->
<script>
// â”€â”€â”€ Safe localStorage wrapper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// In NW.js environment, localStorage may not be available in all contexts
var safeLocalStorage = {
  getItem: function(key, defaultValue) {
    try {
      if (typeof localStorage !== 'undefined' && localStorage.getItem) {
        var value = localStorage.getItem(key);
        return value !== null ? value : defaultValue;
      }
    } catch (e) {
      console.warn('localStorage.getItem failed:', e);
    }
    return defaultValue;
  },
  setItem: function(key, value) {
    try {
      if (typeof localStorage !== 'undefined' && localStorage.setItem) {
        localStorage.setItem(key, value);
        return true;
      }
    } catch (e) {
      console.warn('localStorage.setItem failed:', e);
    }
    return false;
  }
};

window.onerror = function(msg, src, line, col, err) {
  var d = document.getElementById('_err_overlay');
  if (!d) {
    d = document.createElement('div');
    d.id = '_err_overlay';
    d.style.cssText = 'position:fixed;top:0;left:0;right:0;z-index:9999;' +
      'background:#1a0000;color:#ff8080;padding:10px 14px;' +
      'font:11px/1.6 monospace;max-height:50vh;overflow:auto;' +
      'border-bottom:2px solid #c00;word-break:break-all';
    document.body.appendChild(d);
  }
  var text = (src || '') + ':' + line + '\n' + msg;
  if (err && err.stack) text += '\n' + err.stack;
  var pre = document.createElement('pre');
  pre.style.margin = '0 0 8px';
  pre.textContent = text;
  d.appendChild(pre);
  return false;
};
</script>

<script>
// â”€â”€â”€ Load modules (with visible error if require fails) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let app, readConfig, writeConfig, configExists, ensureComposeFile;
let readGlobalConfig, writeGlobalConfig, listInstances, createInstance, removeInstance;
let readInstanceConfig, writeInstanceConfig, ensureInstanceComposeFile, migrateFromSingleInstance;
let getInstanceConfigPath, getInstanceWorkDir, DEFAULT_CONFIG;
let t, setLang, getLang;
let icons;

(function loadModules() {
  try {
    app = require('./src/app.js');
    ({
      readConfig, writeConfig, configExists, ensureComposeFile,
      readGlobalConfig, writeGlobalConfig, listInstances, createInstance, removeInstance,
      readInstanceConfig, writeInstanceConfig, ensureInstanceComposeFile, migrateFromSingleInstance,
      getInstanceConfigPath, getInstanceWorkDir, DEFAULT_CONFIG
    } = require('./src/config.js'));
    ({ t, setLang, getLang } = require('./src/i18n.js'));
    icons = require('./src/icons.js');
  } catch (err) {
    var d = document.getElementById('_err_overlay');
    if (!d) {
      d = document.createElement('div');
      d.id = '_err_overlay';
      d.style.cssText = 'position:fixed;top:0;left:0;right:0;z-index:9999;' +
        'background:#1a0000;color:#ff8080;padding:16px;font:12px/1.6 monospace;' +
        'max-height:60vh;overflow:auto;border-bottom:2px solid #c00';
      document.body.appendChild(d);
    }
    var pre = document.createElement('pre');
    pre.style.margin = '0';
    pre.textContent = 'âš  æ¨¡å—åŠ è½½å¤±è´¥\n' + (err.stack || err.message);
    d.appendChild(pre);
  }
})();

if (!t) throw new Error('i18n module failed to load');

// â”€â”€â”€ Theme constantsï¼ˆåœ¨ applyTranslations ä¹‹å‰å£°æ˜ï¼Œé¿å… TDZï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const THEME_KEY   = 'webcode-theme';
const THEME_ORDER = ['dark', 'light', 'system'];
const THEME_I18N  = { dark: 'theme_dark', light: 'theme_light', system: 'theme_system' };

// â”€â”€â”€ applyTranslationsï¼šåœ¨é¡µé¢ä¸Šä¸‹æ–‡ä¸­è¿è¡Œï¼Œç¡®ä¿èƒ½è®¿é—® document â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// è¾…åŠ©å‡½æ•°ï¼šæ›´æ–°ä¸»é¢˜æŒ‰é’®çš„ SVG å›¾æ ‡å’Œæ–‡å­—
function updateThemeButtons(theme) {
  var iconHtml = theme === 'dark' ? icons.themeDark :
                  theme === 'light' ? icons.themeLight :
                  icons.themeSystem;
  var label = t(THEME_I18N[theme] || 'theme_dark');

  document.querySelectorAll('.theme-cycle-btn').forEach(function(btn) {
    // åˆ›å»ºä¸´æ—¶å®¹å™¨æ¥è§£æ SVG
    var temp = document.createElement('div');
    temp.innerHTML = iconHtml;
    var svgIcon = temp.firstChild;

    // æ¸…ç©ºæŒ‰é’®å¹¶é‡æ–°æ„å»º
    btn.innerHTML = '';
    if (svgIcon && svgIcon.nodeType === 1) { // ç¡®ä¿æ˜¯å…ƒç´ èŠ‚ç‚¹
      btn.appendChild(svgIcon.cloneNode(true));
    }
    var textSpan = document.createElement('span');
    textSpan.textContent = '\u00a0' + label;
    btn.appendChild(textSpan);
  });
}

// è¾…åŠ©å‡½æ•°ï¼šæ›´æ–°è¯­è¨€æŒ‰é’®çš„ SVG å›¾æ ‡å’Œæ–‡å­—
function updateLangButtons() {
  var lang = getLang();
  var langLabel = lang === 'zh-CN' ? 'ä¸­æ–‡' : 'EN';

  document.querySelectorAll('.lang-cycle-btn').forEach(function(btn) {
    // åˆ›å»ºä¸´æ—¶å®¹å™¨æ¥è§£æ SVG
    var temp = document.createElement('div');
    temp.innerHTML = icons.language;
    var svgIcon = temp.firstChild;

    // æ¸…ç©ºæŒ‰é’®å¹¶é‡æ–°æ„å»º
    btn.innerHTML = '';
    if (svgIcon && svgIcon.nodeType === 1) {
      btn.appendChild(svgIcon.cloneNode(true));
    }
    var textSpan = document.createElement('span');
    textSpan.textContent = '\u00a0' + langLabel;
    btn.appendChild(textSpan);
  });
}

// è¾…åŠ©å‡½æ•°ï¼šæ¸²æŸ“æ ‡ç­¾é¡µå›¾æ ‡
function renderTabIcons() {
  document.querySelectorAll('.tab-icon, .btn-icon').forEach(function(el) {
    var iconKey = el.getAttribute('data-icon');
    if (icons[iconKey]) {
      el.innerHTML = icons[iconKey];
    }
  });
}

function applyTranslations() {
  document.querySelectorAll('[data-i18n]').forEach(function(el) {
    el.textContent = t(el.getAttribute('data-i18n'));
  });
  document.querySelectorAll('[data-i18n-title]').forEach(function(el) {
    el.title = t(el.getAttribute('data-i18n-title'));
  });
  document.querySelectorAll('[data-i18n-placeholder]').forEach(function(el) {
    el.placeholder = t(el.getAttribute('data-i18n-placeholder'));
  });

  document.documentElement.lang = getLang();

  // æ›´æ–°ä¸»é¢˜æŒ‰é’®å’Œè¯­è¨€æŒ‰é’®
  var currentTheme = safeLocalStorage.getItem(THEME_KEY, 'dark');
  updateThemeButtons(currentTheme);
  updateLangButtons();
}

// â”€â”€â”€ Theme â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function effectiveThemeName(theme) {
  if (theme === 'system') {
    return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
  }
  return theme;
}

function syncTheiaTheme(theme) {
  if (typeof app === 'undefined' || !app.setTheiaTheme) return;
  var effective = effectiveThemeName(theme);
  var theiaTheme = effective === 'dark' ? 'dark' : 'light';
  app.setTheiaTheme(cfg, theiaTheme, function(code) {
    // Theia è‡ªåŠ¨æ£€æµ‹ settings.json å˜åŒ–å¹¶åº”ç”¨ä¸»é¢˜ï¼Œæ— éœ€åˆ·æ–°
    if (code !== 0) {
      console.warn('Failed to update Theia theme, exit code:', code);
    }
  });
  // åŒæ­¥æ¡Œé¢ä¸»é¢˜
  if (app.setDesktopTheme) {
    app.setDesktopTheme(cfg, effective, function(code) {
      console.log('Desktop theme switched to ' + effective + (code === 0 ? ' (success)' : ' (failed)'));
    });
  }
}

function applyTheme(theme) {
  document.documentElement.setAttribute('data-theme', theme);
  safeLocalStorage.setItem(THEME_KEY, theme);
  // ä½¿ç”¨ç»Ÿä¸€çš„è¾…åŠ©å‡½æ•°æ›´æ–°ä¸»é¢˜æŒ‰é’®
  updateThemeButtons(theme);
  // åŒæ­¥ Theia ä¸»é¢˜
  syncTheiaTheme(theme);
}

// ç›‘å¬ç³»ç»Ÿä¸»é¢˜å˜åŒ–ï¼Œå½“é€‰æ‹©"ç³»ç»Ÿ"æ—¶å®æ—¶å“åº”
window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function() {
  if ((safeLocalStorage.getItem(THEME_KEY, 'dark')) === 'system') {
    applyTheme('system');
  }
});

// ä¸»é¢˜å¾ªç¯æŒ‰é’®ç‚¹å‡»
document.addEventListener('click', function(e) {
  var btn = e.target.closest('.theme-cycle-btn');
  if (!btn) return;
  var current = safeLocalStorage.getItem(THEME_KEY, 'dark');
  var idx = THEME_ORDER.indexOf(current);
  var next = THEME_ORDER[(idx + 1) % THEME_ORDER.length];
  applyTheme(next);
});

// â”€â”€â”€ Language switcherï¼ˆè¯­è¨€å¾ªç¯æŒ‰é’®ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

document.addEventListener('click', function(e) {
  var btn = e.target.closest('.lang-cycle-btn');
  if (!btn) return;
  var newLang = getLang() === 'zh-CN' ? 'en' : 'zh-CN';
  setLang(newLang);
  applyTranslations();

  // è¯­è¨€åˆ‡æ¢åé‡æ–°æ¸²æŸ“åŠ¨æ€å†…å®¹ï¼ˆç«¯å£æ˜ å°„å’Œç›®å½•æŒ‚è½½åˆ—è¡¨ï¼‰
  cfg = readInstanceConfig(activeInstanceId) || cfg;
  // é‡æ–°æ¸²æŸ“å‘å¯¼ä¸­çš„åˆ—è¡¨
  if (typeof renderVolumeList === 'function' && typeof renderPortMapList === 'function') {
    renderVolumeList('volume-list', cfg.CUSTOM_VOLUMES || []);
    renderPortMapList('port-map-list', cfg.CUSTOM_PORTS || []);
  }
  // é‡æ–°æ¸²æŸ“å·¥ä½œåŒºä¸­çš„åˆ—è¡¨
  if (typeof renderNamedVolumes === 'function') {
    renderNamedVolumes('named-vols-display');
  }
  // å·¥ä½œåŒºåˆ—è¡¨
  if (document.getElementById('ws-volume-list') && document.getElementById('ws-port-map-list')) {
    renderVolumeList('ws-volume-list', cfg.CUSTOM_VOLUMES || []);
    renderPortMapList('ws-port-map-list', cfg.CUSTOM_PORTS || []);
    renderNamedVolumes('ws-named-vols-display');
  }

  // è¯­è¨€åˆ‡æ¢åé‡æ–°åŠ è½½ Theiaï¼ˆå¸¦æ–° locale å‚æ•°ï¼‰
  // å½“å‰åœ¨ IDE æ ‡ç­¾é¡µï¼šç«‹å³åˆ·æ–°ï¼›å¦åˆ™æ ‡è®°ä¸‹æ¬¡æ¿€æ´»æ—¶é‡è½½
  if (typeof iframeLoaded !== 'undefined') {
    iframeLoaded['ide'] = false;
    if (typeof currentTab !== 'undefined' && currentTab === 'ide') {
      document.getElementById('iframe-ide').src = iframeUrl('ide');
      iframeLoaded['ide'] = true;
    }
  }
});

// â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let currentStep = 1;
let currentTab  = 'status';
let globalCfg, activeInstanceId, cfg;
let proxyStarted = false;
let logsProc = null;

function setStep(n) {
  for (let i = 1; i <= 4; i++) {
    document.getElementById('step-' + i).style.display = (i === n) ? '' : 'none';
  }
  currentStep = n;
  renderStepDots(n);
}

function renderStepDots(active) {
  const dots = document.getElementById('step-dots');
  dots.innerHTML = '';
  for (let i = 1; i <= 3; i++) {
    const d = document.createElement('div');
    d.className = 'step-dot' +
      (i < active ? ' done' : (i === active ? ' active' : ''));
    dots.appendChild(d);
  }
}

function showWizard(step) {
  document.getElementById('wizard').style.display = '';
  document.getElementById('workspace').style.display = 'none';
  setStep(step);
}

function applyModeToTabs(mode) {
  var vncTab = document.getElementById('tab-vnc');
  if (mode === 'lite') {
    vncTab.style.display = 'none';
    if (currentTab === 'vnc') activateTab('status');
  } else {
    vncTab.style.display = '';
  }
}

function showWorkspace() {
  document.getElementById('wizard').style.display = 'none';
  document.getElementById('workspace').style.display = 'flex';
  loadConfigIntoWorkspaceForm();
  applyModeToTabs(cfg.MODE || 'desktop');
  activateTab('status');
  startStatusPolling();
  startLogStream();
  // è¿›å…¥å·¥ä½œåŒºæ—¶åŒæ­¥ Theia ä¸»é¢˜ï¼ˆå†™å…¥ settings.jsonï¼Œä¸‹æ¬¡æ‰“å¼€ IDE è‡ªåŠ¨ç”Ÿæ•ˆï¼‰
  syncTheiaTheme(safeLocalStorage.getItem(THEME_KEY, 'dark'));
  if (!proxyStarted) {
    app.startProxies(cfg);
    proxyStarted = true;
  }
}

// â”€â”€â”€ Step 1: Docker check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function showDockerHelp(installed) {
  document.getElementById('docker-help').style.display = '';
  const isMac = typeof process !== 'undefined' && process.platform === 'darwin';
  const isWin = typeof process !== 'undefined' && process.platform === 'win32';
  document.getElementById('docker-help-mac').style.display =
    (!installed && isMac) ? '' : 'none';
  document.getElementById('docker-help-win').style.display =
    (!installed && isWin) ? '' : 'none';
  document.getElementById('docker-help-notrunning').style.display =
    installed ? '' : 'none';
}

function runDockerCheck() {
  setCheckState('check-docker-installed', 'checking', t('badge_checking'));
  setCheckState('check-docker-running',   'checking', t('badge_checking'));
  document.getElementById('docker-help').style.display = 'none';
  document.getElementById('btn-step1-next').disabled = true;

  app.checkDocker((result) => {
    if (result.installed) {
      setCheckState('check-docker-installed', 'ok', result.version);
    } else {
      setCheckState('check-docker-installed', 'fail', t('dyn_not_found'));
      setCheckState('check-docker-running',   'fail', 'â€”');
      showDockerHelp(false);
      return;
    }
    if (result.running) {
      setCheckState('check-docker-running', 'ok', t('dyn_running'));
      document.getElementById('btn-step1-next').disabled = false;
    } else {
      setCheckState('check-docker-running', 'fail', t('dyn_not_running'));
      showDockerHelp(true);
    }
  });
}

function setCheckState(id, state, text) {
  const row  = document.getElementById(id);
  const badge = row.querySelector('.badge');
  badge.textContent = text;
  badge.className = 'badge ' + (state === 'ok' ? 'badge-ok' : state === 'fail' ? 'badge-fail' : 'badge-checking');
}

document.getElementById('btn-recheck').addEventListener('click', runDockerCheck);

document.getElementById('btn-step1-next').addEventListener('click', () => {
  loadConfigIntoWizardForm();
  setStep(2);
});

// Docker Desktop download links
['docker-dl-link', 'docker-dl-link-win'].forEach(id => {
  const el = document.getElementById(id);
  if (el) el.addEventListener('click', () => {
    nw.Shell.openExternal('https://www.docker.com/products/docker-desktop/');
  });
});

// â”€â”€â”€ Volume list helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const NAMED_VOLUMES = [
  { name: 'projects',          container: '/home/ubuntu/projects' },
  { name: 'dna-data',          container: '/home/ubuntu/dna' },
  { name: 'theia-data',        container: '/home/ubuntu/.theia' },
  { name: 'vibe-kanban-data',  container: '/home/ubuntu/.local/share/vibe-kanban' },
  { name: 'user-data',         container: '/home/ubuntu/.local/share' },
  { name: 'openclaw-data',     container: '/home/ubuntu/.openclaw' },
  { name: 'chrome-data',       container: '/home/ubuntu/.config' },
  { name: 'gitconfig',         container: '/home/ubuntu/.gitconfig-vol' },
  { name: 'recordings',        container: '/home/ubuntu/recordings' },
];

function renderNamedVolumes(containerId) {
  const el = document.getElementById(containerId);
  if (!el) return;
  el.innerHTML = NAMED_VOLUMES.map(function(v) {
    return '<div class="named-vol-row">' +
      '<span class="named-vol-name">' + escHtml(v.name) + '</span>' +
      '<span class="named-vol-arrow">â†’</span>' +
      '<span class="named-vol-path">' + escHtml(v.container) + '</span>' +
      '<button class="btn-secondary btn-sm" style="flex-shrink:0;padding:3px 7px;font-size:11px" data-vol-clear="' + escHtml(v.name) + '">' + t('btn_clear_vol') + '</button>' +
      '</div>';
  }).join('');
}

function renderVolumeList(containerId, volumes) {
  const container = document.getElementById(containerId);
  container.innerHTML = '';
  (volumes || []).forEach(function(v, i) {
    const row = document.createElement('div');
    row.className = 'volume-row';
    row.style.cssText = 'display:flex;gap:6px;margin-bottom:5px;align-items:center';
    row.innerHTML =
      '<span class="port-map-label">' + t('label_host') + '</span>' +
      '<div style="flex:1;display:flex;gap:4px">' +
        '<input type="text" class="vol-host" list="host-paths-list" placeholder="' + t('ph_host_path') + '" value="' + escHtml(v.host || '') + '" style="flex:1">' +
        '<button class="btn-secondary btn-sm vol-pick-btn" title="' + t('btn_pick_dir') + '" style="flex-shrink:0;padding:4px 8px">ğŸ“‚</button>' +
        '<input type="file" nwdirectory style="display:none" class="vol-dir-picker">' +
      '</div>' +
      '<span style="color:var(--text-muted);font-size:13px;flex-shrink:0">â†’</span>' +
      '<span class="port-map-label">' + t('label_container') + '</span>' +
      '<input type="text" class="vol-container" list="container-paths-list" placeholder="' + t('ph_container_path') + '" value="' + escHtml(v.container || '') + '" style="flex:1">' +
      '<button class="btn-secondary btn-sm" style="flex-shrink:0;padding:4px 8px" data-vol-del="' + i + '">âœ•</button>';
    container.appendChild(row);

    // ğŸ“‚ æŒ‰é’®è§¦å‘æ–‡ä»¶å¤¹é€‰æ‹©ï¼Œé€‰ä¸­åå¡«å…¥ host input
    const hostInput = row.querySelector('.vol-host');
    const pickBtn   = row.querySelector('.vol-pick-btn');
    const dirPicker = row.querySelector('.vol-dir-picker');
    pickBtn.addEventListener('click', function() { dirPicker.click(); });
    dirPicker.addEventListener('change', function() {
      if (dirPicker.files && dirPicker.files[0]) {
        hostInput.value = dirPicker.files[0].path;
      }
    });
  });
}

function collectVolumeList(containerId) {
  const rows = document.getElementById(containerId).querySelectorAll('.volume-row');
  const result = [];
  rows.forEach(function(row) {
    const host = row.querySelector('.vol-host').value.trim();
    const container = row.querySelector('.vol-container').value.trim();
    if (host || container) result.push({ host: host, container: container });
  });
  return result;
}

// â”€â”€â”€ Port map list helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderPortMapList(containerId, ports) {
  var container = document.getElementById(containerId);
  container.innerHTML = '';
  if (!ports || ports.length === 0) return;

  ports.forEach(function(p, i) {
    var row = document.createElement('div');
    row.className = 'volume-row';
    row.style.cssText = 'display:flex;gap:6px;margin-bottom:5px;align-items:center';
    row.innerHTML =
      '<span class="port-map-label">' + t('label_host') + '</span>' +
      '<input type="number" class="port-map-host" placeholder="8080" ' +
        'value="' + escHtml(p.host || '') + '" style="flex:1;min-width:0">' +
      '<span style="color:var(--text-muted);font-size:13px;flex-shrink:0">â†’</span>' +
      '<span class="port-map-label">' + t('label_container') + '</span>' +
      '<input type="number" class="port-map-container" placeholder="3000" ' +
        'value="' + escHtml(p.container || '') + '" style="flex:1;min-width:0">' +
      '<button class="btn-secondary btn-sm" style="flex-shrink:0;padding:4px 8px" ' +
        'data-port-del="' + i + '">âœ•</button>';
    container.appendChild(row);
  });
}

function collectPortMapList(containerId) {
  var rows = document.getElementById(containerId).querySelectorAll('.volume-row');
  var result = [];
  rows.forEach(function(row) {
    var host      = row.querySelector('.port-map-host').value.trim();
    var container = row.querySelector('.port-map-container').value.trim();
    if (host || container) result.push({ host: host, container: container });
  });
  return result;
}

// Port map add/delete event delegation (wizard)
document.addEventListener('click', function(e) {
  if (e.target.id === 'btn-add-port-map') {
    var ports = collectPortMapList('port-map-list');
    ports.push({ host: '', container: '' });
    renderPortMapList('port-map-list', ports);
    return;
  }
  var delBtn = e.target.closest('[data-port-del]');
  if (delBtn && document.getElementById('port-map-list').contains(delBtn)) {
    var idx = parseInt(delBtn.getAttribute('data-port-del'), 10);
    var ports = collectPortMapList('port-map-list');
    ports.splice(idx, 1);
    renderPortMapList('port-map-list', ports);
  }
});

// Port map add/delete event delegation (workspace)
document.addEventListener('click', function(e) {
  if (e.target.id === 'ws-btn-add-port-map') {
    var ports = collectPortMapList('ws-port-map-list');
    ports.push({ host: '', container: '' });
    renderPortMapList('ws-port-map-list', ports);
    return;
  }
  var delBtn = e.target.closest('[data-port-del]');
  if (delBtn && document.getElementById('ws-port-map-list').contains(delBtn)) {
    var idx = parseInt(delBtn.getAttribute('data-port-del'), 10);
    var ports = collectPortMapList('ws-port-map-list');
    ports.splice(idx, 1);
    renderPortMapList('ws-port-map-list', ports);
  }
});

// Volume add/delete event delegation (wizard)
document.addEventListener('click', function(e) {
  if (e.target.id === 'btn-add-volume') {
    const vols = collectVolumeList('volume-list');
    vols.push({ host: '', container: '' });
    renderVolumeList('volume-list', vols);
    return;
  }
  var delBtn = e.target.closest('[data-vol-del]');
  if (delBtn && document.getElementById('volume-list').contains(delBtn)) {
    const idx = parseInt(delBtn.getAttribute('data-vol-del'), 10);
    const vols = collectVolumeList('volume-list');
    vols.splice(idx, 1);
    renderVolumeList('volume-list', vols);
  }
});

// Volume add/delete event delegation (workspace)
document.addEventListener('click', function(e) {
  if (e.target.id === 'ws-btn-add-volume') {
    const vols = collectVolumeList('ws-volume-list');
    vols.push({ host: '', container: '' });
    renderVolumeList('ws-volume-list', vols);
    return;
  }
  var delBtn = e.target.closest('[data-vol-del]');
  if (delBtn && document.getElementById('ws-volume-list').contains(delBtn)) {
    const idx = parseInt(delBtn.getAttribute('data-vol-del'), 10);
    const vols = collectVolumeList('ws-volume-list');
    vols.splice(idx, 1);
    renderVolumeList('ws-volume-list', vols);
  }
});

// â”€â”€â”€ Named volume clear â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

document.addEventListener('click', function(e) {
  const clearBtn = e.target.closest('[data-vol-clear]');
  if (!clearBtn) return;
  const volName = clearBtn.getAttribute('data-vol-clear');
  if (!confirm(t('dyn_confirm_clear_vol', { name: volName }))) return;
  clearBtn.disabled = true;
  const origText = clearBtn.textContent;
  // Step 1: stop container
  clearBtn.textContent = t('dyn_stopping');
  app.dockerDown(cfg, null, function() {
    // Step 2: remove volume
    clearBtn.textContent = 'â€¦';
    app.dockerVolumeRm(volName, function(code, out) {
      clearBtn.disabled = false;
      clearBtn.textContent = origText;
      alert(code === 0 ? 'âœ“ ' + out : 'âœ— ' + out);
    });
  });
});

// â”€â”€â”€ Step 2: Config form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let selectedMode = (cfg && cfg.MODE) || 'desktop';

document.querySelectorAll('[data-mode]').forEach(btn => {
  btn.addEventListener('click', () => {
    selectedMode = btn.dataset.mode;
    // update active state for sibling buttons sharing the same parent
    btn.closest('.toggle-row').querySelectorAll('.toggle-btn').forEach(b => {
      b.classList.toggle('active', b === btn);
    });
    if (btn.closest('#step-2')) {
      document.getElementById('vnc-group').style.display =
        selectedMode === 'desktop' ? '' : 'none';
    }
  });
});

function loadConfigIntoWizardForm() {
  document.getElementById('cfg-auth-password').value  = cfg.AUTH_PASSWORD || '';
  document.getElementById('cfg-vnc-password').value   = cfg.VNC_PASSWORD  || '';
  document.getElementById('cfg-openclaw-token').value = cfg.OPENCLAW_TOKEN || '';
  document.getElementById('cfg-auth-user').value      = cfg.AUTH_USER || 'admin';
  document.getElementById('cfg-vnc-resolution').value = cfg.VNC_RESOLUTION || '1920x1080';
  document.getElementById('cfg-git-name').value       = cfg.GIT_USER_NAME || '';
  document.getElementById('cfg-git-email').value      = cfg.GIT_USER_EMAIL || '';
  document.getElementById('cfg-cf-token').value       = cfg.CF_TUNNEL_TOKEN || '';

  // ç«¯å£é…ç½®
  document.getElementById('cfg-port-theia').value    = cfg.PORT_THEIA    || 20001;
  document.getElementById('cfg-port-kanban').value   = cfg.PORT_KANBAN   || 20002;
  document.getElementById('cfg-port-openclaw').value = cfg.PORT_OPENCLAW || 20003;
  document.getElementById('cfg-port-novnc').value    = cfg.PORT_NOVNC    || 20004;
  document.getElementById('cfg-port-vnc').value      = cfg.PORT_VNC      || 20005;
  // Audio now uses /audio path on port 20004, no separate port needed

  selectedMode = cfg.MODE || 'desktop';
  document.getElementById('mode-desktop').classList.toggle('active', selectedMode === 'desktop');
  document.getElementById('mode-lite').classList.toggle('active', selectedMode === 'lite');
  document.getElementById('vnc-group').style.display = selectedMode === 'desktop' ? '' : 'none';

  renderNamedVolumes('named-vols-display');
  renderVolumeList('volume-list', cfg.CUSTOM_VOLUMES || []);
  renderPortMapList('port-map-list', cfg.CUSTOM_PORTS || []);
}

function collectWizardForm() {
  cfg.AUTH_PASSWORD  = document.getElementById('cfg-auth-password').value  || 'changeme';
  cfg.VNC_PASSWORD   = document.getElementById('cfg-vnc-password').value   || 'changeme';
  cfg.OPENCLAW_TOKEN = document.getElementById('cfg-openclaw-token').value || 'changeme';
  cfg.AUTH_USER      = document.getElementById('cfg-auth-user').value      || 'admin';
  cfg.VNC_RESOLUTION = document.getElementById('cfg-vnc-resolution').value || '1920x1080';
  cfg.GIT_USER_NAME  = document.getElementById('cfg-git-name').value  || '';
  cfg.GIT_USER_EMAIL = document.getElementById('cfg-git-email').value || '';
  cfg.CF_TUNNEL_TOKEN= document.getElementById('cfg-cf-token').value  || '';
  cfg.MODE = selectedMode;

  // ç«¯å£é…ç½®
  cfg.PORT_THEIA    = parseInt(document.getElementById('cfg-port-theia').value)    || 20001;
  cfg.PORT_KANBAN   = parseInt(document.getElementById('cfg-port-kanban').value)   || 20002;
  cfg.PORT_OPENCLAW = parseInt(document.getElementById('cfg-port-openclaw').value) || 20003;
  cfg.PORT_NOVNC    = parseInt(document.getElementById('cfg-port-novnc').value)    || 20004;
  cfg.PORT_VNC      = parseInt(document.getElementById('cfg-port-vnc').value)      || 20005;
  // Audio uses /audio path on PORT_NOVNC, no separate PORT_AUDIO needed

  cfg.CUSTOM_VOLUMES = collectVolumeList('volume-list');
  cfg.CUSTOM_PORTS = collectPortMapList('port-map-list');

  writeInstanceConfig(activeInstanceId, cfg);
}

document.getElementById('btn-step2-back').addEventListener('click', () => setStep(1));

// ç«¯å£æ£€æµ‹æŒ‰é’®
document.getElementById('btn-check-ports').addEventListener('click', async () => {
  const ports = {
    theia: parseInt(document.getElementById('cfg-port-theia').value) || 20001,
    kanban: parseInt(document.getElementById('cfg-port-kanban').value) || 20002,
    openclaw: parseInt(document.getElementById('cfg-port-openclaw').value) || 20003,
    novnc: parseInt(document.getElementById('cfg-port-novnc').value) || 20004,
    vnc: parseInt(document.getElementById('cfg-port-vnc').value) || 20005
    // Audio uses /audio path on novnc port, not checked separately
  };

  // è¿½åŠ è‡ªå®šä¹‰ç«¯å£æ˜ å°„çš„å®¿ä¸»æœºç«¯å£
  const customList = collectPortMapList('port-map-list');
  customList.forEach(function(p, i) {
    const n = parseInt(p.host);
    if (n > 0) ports['custom_' + i] = n;
  });

  // æ˜¾ç¤ºæ£€æµ‹ä¸­çŠ¶æ€
  for (const key of Object.keys(ports)) {
    const statusEl = document.getElementById(`port-status-${key}`);
    if (statusEl) {
      statusEl.textContent = 'â³';
      statusEl.className = 'port-status checking';
    }
  }
  document.getElementById('custom-port-status').textContent = '';

  const results = await app.checkPorts(ports);

  const customConflicts = [];
  for (const [key, result] of Object.entries(results)) {
    const statusEl = document.getElementById(`port-status-${key}`);
    if (statusEl) {
      statusEl.textContent = result.available ? 'âœ“' : 'âœ—';
      statusEl.className = 'port-status ' + (result.available ? 'ok' : 'error');
    } else if (key.startsWith('custom_') && !result.available) {
      customConflicts.push(result.port);
    }
  }
  const statusDiv = document.getElementById('custom-port-status');
  if (customConflicts.length > 0) {
    statusDiv.style.color = 'var(--danger)';
    statusDiv.textContent = 'âœ— è‡ªå®šä¹‰ç«¯å£å†²çªï¼š' + customConflicts.join(', ');
  } else if (customList.some(p => parseInt(p.host) > 0)) {
    statusDiv.style.color = 'var(--success)';
    statusDiv.textContent = 'âœ“ è‡ªå®šä¹‰ç«¯å£å‡å¯ç”¨';
  }
});

document.getElementById('btn-step2-next').addEventListener('click', () => {
  collectWizardForm();
  startLaunch();
});

// â”€â”€â”€ Step 3: Launch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function appendLog(id, text) {
  const el = document.getElementById(id);
  el.textContent += text;
  el.scrollTop = el.scrollHeight;
}

function startLaunch(logId, nextBtn, backBtn) {
  logId   = logId   || 'launch-log';
  nextBtn = nextBtn || 'btn-step3-next';
  backBtn = backBtn || 'btn-step3-back';

  setStep(3);
  document.getElementById(logId).textContent = '';
  document.getElementById(nextBtn).disabled = true;
  document.getElementById(backBtn).disabled = true;

  ensureInstanceComposeFile(activeInstanceId);

  app.dockerUp(cfg,
    (data) => appendLog(logId, data),
    (code) => {
      document.getElementById(backBtn).disabled = false;
      if (code === 0) {
        appendLog(logId, t('dyn_launch_ok'));
        document.getElementById(nextBtn).disabled = false;
      } else {
        appendLog(logId, t('dyn_launch_fail', { code }));
      }
    }
  );
}

document.getElementById('btn-step3-back').addEventListener('click', () => setStep(2));
document.getElementById('btn-step3-next').addEventListener('click', () => {
  showWorkspace();
});

// â”€â”€â”€ Step 4: Re-launch (config exists, container not running) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

document.getElementById('btn-step4-start').addEventListener('click', () => {
  document.getElementById('relaunch-log').style.display = '';
  document.getElementById('relaunch-log').textContent = '';
  document.getElementById('btn-step4-start').disabled = true;

  app.dockerUp(cfg,
    (data) => appendLog('relaunch-log', data),
    (code) => {
      document.getElementById('btn-step4-start').disabled = false;
      if (code === 0) {
        appendLog('relaunch-log', t('dyn_relaunch_ok'));
        showWorkspace();
      } else {
        appendLog('relaunch-log', t('dyn_launch_fail', { code }));
      }
    }
  );
});

document.getElementById('btn-step4-config').addEventListener('click', () => {
  loadConfigIntoWizardForm();
  setStep(2);
});

document.getElementById('btn-step4-enter').addEventListener('click', () => {
  showWorkspace();
  activateTab('status'); // Force to status tab
});

// Step 4: Redetect Docker link
document.getElementById('link-redetect-docker').addEventListener('click', (e) => {
  e.preventDefault();
  showWizard(1);
  runDockerCheck();
});

// â”€â”€â”€ Workspace: tab switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// Track latest container status for overlay check
let lastKnownContainers = null;

const IFRAME_IDS = { ide: 'iframe-ide', kanban: 'iframe-kanban', vnc: 'iframe-vnc', ai: 'iframe-ai' };
const iframeLoaded = {};

function iframeUrl(tab) {
  // Pass locale to Theia so it loads in the correct language (requires NLS packages in the container)
  const theiaLocale = getLang() === 'zh-CN' ? 'zh-CN' : 'en';
  const ports = app.getPortsFromConfig ? app.getPortsFromConfig(cfg) : {
    theia: cfg.PORT_THEIA || 20001,
    kanban: cfg.PORT_KANBAN || 20002,
    openclaw: cfg.PORT_OPENCLAW || 20003,
    novnc: cfg.PORT_NOVNC || 20004
  };
  const proxyPort = (p) => p - 9000;
  switch (tab) {
    case 'ide':    return `http://localhost:${proxyPort(ports.theia)}/?locale=${theiaLocale}`;
    case 'kanban': return `http://localhost:${proxyPort(ports.kanban)}`;
    case 'vnc':    return `http://localhost:${proxyPort(ports.novnc)}/?autoconnect=true&resize=remote&password=${encodeURIComponent(cfg.VNC_PASSWORD)}`;
    case 'ai':     return `http://localhost:${proxyPort(ports.openclaw)}/`;
  }
}

function activateTab(tab) {
  currentTab = tab;

  // Check container status for non-status tabs
  if (tab !== 'status') {
    const overlay = document.getElementById('container-stopped-overlay');
    const running = lastKnownContainers && containerRunning(lastKnownContainers);

    if (!running) {
      overlay.classList.add('visible');
      // Hide all iframes when overlay is shown
      Object.values(IFRAME_IDS).forEach(id => {
        document.getElementById(id).classList.remove('visible');
      });
      // Update tab buttons
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tab);
      });
      // Hide tab actions for non-running state
      document.getElementById('tab-actions').style.display = 'none';
      // Hide status panel
      document.getElementById('panel-status').classList.remove('visible');
      return;
    } else {
      overlay.classList.remove('visible');
    }
  }

  // Update tab buttons
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.tab === tab);
  });

  // Show/hide tab action buttons
  const tabActions = document.getElementById('tab-actions');
  tabActions.style.display = (tab === 'status') ? 'none' : 'flex';

  // Show/hide status panel vs iframes
  const panel = document.getElementById('panel-status');
  panel.classList.toggle('visible', tab === 'status');

  Object.keys(IFRAME_IDS).forEach(t => {
    const fr = document.getElementById(IFRAME_IDS[t]);
    fr.classList.toggle('visible', t === tab);
    if (t === tab && !iframeLoaded[t]) {
      fr.src = iframeUrl(t);
      iframeLoaded[t] = true;
    }
  });
}

document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => activateTab(btn.dataset.tab));
});

// Refresh button
document.getElementById('btn-refresh').addEventListener('click', () => {
  if (currentTab === 'status') return;
  const iframe = document.getElementById(IFRAME_IDS[currentTab]);
  iframeLoaded[currentTab] = false;
  iframe.src = iframeUrl(currentTab);
});

// Open in browser button
document.getElementById('btn-open-browser').addEventListener('click', () => {
  if (currentTab === 'status') return;
  const url = iframeUrl(currentTab);
  nw.Shell.openExternal(url);
});

// â”€â”€â”€ Workspace: status polling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// Overlay: Start container button
document.getElementById('overlay-btn-start').addEventListener('click', () => {
  showWizard(4);
  // Trigger start logic
  const btn = document.getElementById('btn-step4-start');
  if (btn) btn.click();
});

// Overlay: View status button
document.getElementById('overlay-btn-status').addEventListener('click', () => {
  activateTab('status');
});

function startStatusPolling() {
  app.startPolling(cfg, (containers) => {
    updateStatusUI(containers);
  });
}

function containerRunning(containers) {
  if (!containers || containers.length === 0) return false;
  return containers.some(c => (c.State || c.status || '').toLowerCase().includes('running'));
}

// Get instance name from global config
function getInstanceNameForCurrent() {
  const global = globalCfg || {};
  const instances = global.instances || [];
  const current = instances.find(i => i.id === activeInstanceId);
  return current ? current.name : null;
}

function updateStatusUI(containers) {
  lastKnownContainers = containers; // Save for overlay check
  const running = containerRunning(containers);
  const dot  = document.getElementById('status-dot');
  const text = document.getElementById('status-text');

  if (running) {
    dot.className = 'dot dot-green';
    text.textContent = t('dyn_running');
  } else {
    dot.className = 'dot dot-gray';
    text.textContent = t('dyn_stopped');
  }

  // Status grid
  const grid = document.getElementById('status-grid');
  if (containers.length === 0) {
    // Try instance name first, fallback to service name
    const instanceName = getInstanceNameForCurrent();
    const displayName = instanceName || 'webcode';
    grid.innerHTML = `<div class="svc-card"><div class="svc-name">${escHtml(displayName)}</div><div class="svc-state"><span class="dot dot-gray"></span> ${t('dyn_not_running')}</div></div>`;
    document.getElementById('supervisor-section').style.display = 'none';
    return;
  }
  grid.innerHTML = containers.map(c => {
    const state = (c.State || c.Status || 'unknown').toLowerCase();
    const dotClass = state.includes('running') ? 'dot-green' :
                     state.includes('starting') ? 'dot-yellow' : 'dot-red';
    // Try instance name first, fallback to service name
    const instanceName = getInstanceNameForCurrent();
    const displayName = instanceName || (c.Service || c.Name || 'webcode');
    return `<div class="svc-card">
      <div class="svc-name">${escHtml(displayName)}</div>
      <div class="svc-state"><span class="dot ${dotClass}"></span> ${escHtml(state)}</div>
    </div>`;
  }).join('');

  // Fetch supervisor process status when container is running
  if (running) {
    app.supervisorStatus(cfg, function(err, services) {
      if (err || !services || services.length === 0) return;
      const section = document.getElementById('supervisor-section');
      const supGrid = document.getElementById('supervisor-grid');
      section.style.display = '';
      supGrid.innerHTML = services.map(function(svc) {
        const state = (svc.state || '').toUpperCase();
        const dotClass = state === 'RUNNING' ? 'dot-green' :
                         state === 'STARTING' ? 'dot-yellow' : 'dot-red';
        return `<div class="svc-card">
          <div class="svc-name">${escHtml(svc.name)}</div>
          <div class="svc-state"><span class="dot ${dotClass}"></span> ${escHtml(svc.state)}</div>
          <div class="svc-actions">
            <button class="svc-restart-btn" data-process="${escHtml(svc.name)}"
                    data-i18n-title="title_restart_process" title="é‡å¯è¿›ç¨‹">
              ${icons.processRestart}
            </button>
            <button class="svc-logs-btn" data-process="${escHtml(svc.name)}"
                    data-i18n-title="title_view_logs" title="æŸ¥çœ‹æ—¥å¿—">
              ${icons.processLogs}
            </button>
          </div>
        </div>`;
      }).join('');
    });
  } else {
    document.getElementById('supervisor-section').style.display = 'none';
  }
}

// â”€â”€â”€ Process logs modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let currentLogProcess = null;
let logPollTimer = null;

function startLogPolling(processName) {
  stopLogPolling();
  currentLogProcess = processName;
  function poll() {
    var content = document.getElementById('process-logs-content');
    if (!content || !currentLogProcess) return;
    var atBottom = content.scrollHeight - content.scrollTop - content.clientHeight < 60;
    app.supervisorProcessLog(cfg, processName, function(logs) {
      // Skip DOM update if user is selecting text inside the log area
      var sel = window.getSelection();
      if (sel && sel.toString().length > 0 && content.contains(sel.anchorNode)) return;

      if (!logs || !logs.trim()) {
        content.innerHTML = '<div style="color:var(--text-muted);padding:4px 0">(æš‚æ— æ—¥å¿—)</div>';
      } else {
        content.innerHTML = logs.split('\n').map(function(line) {
          if (!line.trim()) return '';
          if (line.trim() === '=== stderr ===') {
            return '<div class="log-stderr-header">================== stderr =====================</div>';
          }
          var isError = line.startsWith('[ERROR]');
          return '<div class="' + (isError ? 'log-error-line' : '') + '">' + escHtml(line) + '</div>';
        }).join('');
      }
      if (atBottom) content.scrollTop = content.scrollHeight;
    });
  }
  poll();
  logPollTimer = setInterval(poll, 2000);
}

function stopLogPolling() {
  if (logPollTimer) { clearInterval(logPollTimer); logPollTimer = null; }
  currentLogProcess = null;
}

function showProcessLogs(processName) {
  var modal   = document.getElementById('process-logs-modal');
  var title   = document.getElementById('process-logs-title');
  var content = document.getElementById('process-logs-content');
  title.textContent = t('dyn_logs_for_process', { name: processName });
  content.innerHTML = '<div style="color:var(--text-muted)">' + escHtml(t('dyn_loading_logs')) + '</div>';
  modal.style.display = 'flex';
  startLogPolling(processName);
}

// Close modal handlers
document.getElementById('close-logs-modal').addEventListener('click', function() {
  stopLogPolling();
  document.getElementById('process-logs-modal').style.display = 'none';
});

document.getElementById('close-logs-btn').addEventListener('click', function() {
  stopLogPolling();
  document.getElementById('process-logs-modal').style.display = 'none';
});

// Close on backdrop click
document.getElementById('process-logs-modal').addEventListener('click', function(e) {
  if (e.target === this) {
    stopLogPolling();
    this.style.display = 'none';
  }
});

// â”€â”€â”€ Process restart/logs button event delegation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

document.addEventListener('click', function(e) {
  // Handle restart button
  var restartBtn = e.target.closest('.svc-restart-btn');
  if (restartBtn) {
    var processName = restartBtn.getAttribute('data-process');
    if (!confirm(t('dyn_confirm_restart_process', { name: processName }))) return;

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    restartBtn.disabled = true;
    restartBtn.innerHTML = '<span class="loading-spinner" style="width:12px;height:12px;border-width:1.5px"></span>';

    app.supervisorRestart(cfg, processName, function(code) {
      restartBtn.disabled = false;
      restartBtn.innerHTML = icons.processRestart;
      if (code === 0) {
        // åˆ·æ–° supervisor çŠ¶æ€
        setTimeout(function() {
          app.supervisorStatus(cfg, function(err, services) {
            if (!err && services) {
              const supGrid = document.getElementById('supervisor-grid');
              if (supGrid) {
                supGrid.innerHTML = services.map(function(svc) {
                  const state = (svc.state || '').toUpperCase();
                  const dotClass = state === 'RUNNING' ? 'dot-green' :
                                   state === 'STARTING' ? 'dot-yellow' : 'dot-red';
                  return `<div class="svc-card">
                    <div class="svc-name">${escHtml(svc.name)}</div>
                    <div class="svc-state"><span class="dot ${dotClass}"></span> ${escHtml(svc.state)}</div>
                    <div class="svc-actions">
                      <button class="svc-restart-btn" data-process="${escHtml(svc.name)}"
                              data-i18n-title="title_restart_process" title="é‡å¯è¿›ç¨‹">
                        ${icons.processRestart}
                      </button>
                      <button class="svc-logs-btn" data-process="${escHtml(svc.name)}"
                              data-i18n-title="title_view_logs" title="æŸ¥çœ‹æ—¥å¿—">
                        ${icons.processLogs}
                      </button>
                    </div>
                  </div>`;
                }).join('');
              }
            }
          });
        }, 1000);
      } else {
        alert(t('dyn_restart_failed', { code: code }));
      }
    });
    return;
  }

  // Handle logs button
  var logsBtn = e.target.closest('.svc-logs-btn');
  if (logsBtn) {
    var processName = logsBtn.getAttribute('data-process');
    showProcessLogs(processName);
    return;
  }
});

function escHtml(s) {
  return String(s)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// â”€â”€â”€ Workspace: live logs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function startLogStream() {
  if (logsProc) { try { logsProc.kill(); } catch(e) {} }
  const el = document.getElementById('ws-log');
  el.textContent = '';
  logsProc = app.dockerLogs(cfg, (data) => {
    el.textContent += data;
    el.scrollTop = el.scrollHeight;
  });
}

// â”€â”€â”€ Workspace: start / stop buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

document.getElementById('btn-restart').addEventListener('click', () => {
  if (!confirm(t('dyn_confirm_restart'))) return;
  const btn = document.getElementById('btn-restart');
  const originalContent = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<span class="loading-spinner" style="width:14px;height:14px;border-width:1.5px"></span>\u00a0<span>' + t('dyn_restarting') + '</span>';
  app.dockerDown(cfg, null, () => {
    app.dockerUp(cfg, null, () => {
      iframeLoaded['ide'] = iframeLoaded['kanban'] = iframeLoaded['vnc'] = iframeLoaded['ai'] = false;
      if (currentTab !== 'status') activateTab(currentTab);
      startLogStream();
      btn.disabled = false;
      btn.innerHTML = originalContent;
    });
  });
});

document.getElementById('btn-stop').addEventListener('click', () => {
  if (!confirm(t('dyn_confirm_stop'))) return;
  const btn = document.getElementById('btn-stop');
  const originalContent = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<span class="loading-spinner" style="width:14px;height:14px;border-width:1.5px"></span>\u00a0<span>' + t('dyn_stopping') + '</span>';
  app.dockerDown(cfg, null, () => {
    btn.disabled = false;
    btn.innerHTML = originalContent;
  });
});

// â”€â”€â”€ Workspace: config form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let wsMode = (cfg && cfg.MODE) || 'desktop';

document.querySelectorAll('#panel-status [data-mode]').forEach(btn => {
  btn.addEventListener('click', () => {
    wsMode = btn.dataset.mode;
    document.getElementById('ws-mode-desktop').classList.toggle('active', wsMode === 'desktop');
    document.getElementById('ws-mode-lite').classList.toggle('active', wsMode === 'lite');
    applyModeToTabs(wsMode);
  });
});

function loadConfigIntoWorkspaceForm() {
  document.getElementById('ws-auth-password').value  = cfg.AUTH_PASSWORD || '';
  document.getElementById('ws-vnc-password').value   = cfg.VNC_PASSWORD  || '';
  document.getElementById('ws-openclaw-token').value = cfg.OPENCLAW_TOKEN || '';
  document.getElementById('ws-auth-user').value      = cfg.AUTH_USER || 'admin';
  document.getElementById('ws-vnc-resolution').value = cfg.VNC_RESOLUTION || '1920x1080';
  document.getElementById('ws-git-name').value       = cfg.GIT_USER_NAME || '';
  document.getElementById('ws-git-email').value      = cfg.GIT_USER_EMAIL || '';
  document.getElementById('ws-cf-token').value       = cfg.CF_TUNNEL_TOKEN || '';

  // ç«¯å£é…ç½®
  document.getElementById('ws-port-theia').value    = cfg.PORT_THEIA    || 20001;
  document.getElementById('ws-port-kanban').value   = cfg.PORT_KANBAN   || 20002;
  document.getElementById('ws-port-openclaw').value = cfg.PORT_OPENCLAW || 20003;
  document.getElementById('ws-port-novnc').value    = cfg.PORT_NOVNC    || 20004;
  document.getElementById('ws-port-vnc').value      = cfg.PORT_VNC      || 20005;
  // Audio uses /audio path on novnc port

  wsMode = cfg.MODE || 'desktop';
  document.getElementById('ws-mode-desktop').classList.toggle('active', wsMode === 'desktop');
  document.getElementById('ws-mode-lite').classList.toggle('active', wsMode === 'lite');

  renderNamedVolumes('ws-named-vols-display');
  renderVolumeList('ws-volume-list', cfg.CUSTOM_VOLUMES || []);
  renderPortMapList('ws-port-map-list', cfg.CUSTOM_PORTS || []);
}

function collectWorkspaceForm() {
  cfg.AUTH_PASSWORD  = document.getElementById('ws-auth-password').value  || 'changeme';
  cfg.VNC_PASSWORD   = document.getElementById('ws-vnc-password').value   || 'changeme';
  cfg.OPENCLAW_TOKEN = document.getElementById('ws-openclaw-token').value || 'changeme';
  cfg.AUTH_USER      = document.getElementById('ws-auth-user').value      || 'admin';
  cfg.VNC_RESOLUTION = document.getElementById('ws-vnc-resolution').value || '1920x1080';
  cfg.GIT_USER_NAME  = document.getElementById('ws-git-name').value  || '';
  cfg.GIT_USER_EMAIL = document.getElementById('ws-git-email').value || '';
  cfg.CF_TUNNEL_TOKEN= document.getElementById('ws-cf-token').value  || '';
  cfg.MODE = wsMode;

  // ç«¯å£é…ç½®
  cfg.PORT_THEIA    = parseInt(document.getElementById('ws-port-theia').value)    || 20001;
  cfg.PORT_KANBAN   = parseInt(document.getElementById('ws-port-kanban').value)   || 20002;
  cfg.PORT_OPENCLAW = parseInt(document.getElementById('ws-port-openclaw').value) || 20003;
  cfg.PORT_NOVNC    = parseInt(document.getElementById('ws-port-novnc').value)    || 20004;
  cfg.PORT_VNC      = parseInt(document.getElementById('ws-port-vnc').value)      || 20005;
  // Audio uses /audio path on novnc port, no separate port needed

  cfg.CUSTOM_VOLUMES = collectVolumeList('ws-volume-list');
  cfg.CUSTOM_PORTS = collectPortMapList('ws-port-map-list');

  writeInstanceConfig(activeInstanceId, cfg);
}

// å·¥ä½œåŒºç«¯å£æ£€æµ‹æŒ‰é’®
document.getElementById('ws-btn-check-ports').addEventListener('click', async () => {
  const ports = {
    theia: parseInt(document.getElementById('ws-port-theia').value) || 20001,
    kanban: parseInt(document.getElementById('ws-port-kanban').value) || 20002,
    openclaw: parseInt(document.getElementById('ws-port-openclaw').value) || 20003,
    novnc: parseInt(document.getElementById('ws-port-novnc').value) || 20004,
    vnc: parseInt(document.getElementById('ws-port-vnc').value) || 20005
    // Audio uses /audio path on novnc port
  };

  // è¿½åŠ è‡ªå®šä¹‰ç«¯å£æ˜ å°„çš„å®¿ä¸»æœºç«¯å£
  const customList = collectPortMapList('ws-port-map-list');
  customList.forEach(function(p, i) {
    const n = parseInt(p.host);
    if (n > 0) ports['custom_' + i] = n;
  });

  document.getElementById('ws-custom-port-status').textContent = '';
  const results = await app.checkPorts(ports);

  // åˆ†ç¦»æ ‡å‡†ç«¯å£å†²çªå’Œè‡ªå®šä¹‰ç«¯å£å†²çª
  const stdConflicts = [];
  const customConflicts = [];
  for (const [key, result] of Object.entries(results)) {
    if (!result.available) {
      if (key.startsWith('custom_')) customConflicts.push(result.port);
      else stdConflicts.push(result);
    }
  }

  const wsStatusDiv = document.getElementById('ws-custom-port-status');
  if (customConflicts.length > 0) {
    wsStatusDiv.style.color = 'var(--danger)';
    wsStatusDiv.textContent = 'âœ— è‡ªå®šä¹‰ç«¯å£å†²çªï¼š' + customConflicts.join(', ');
  } else if (customList.some(p => parseInt(p.host) > 0)) {
    wsStatusDiv.style.color = 'var(--success)';
    wsStatusDiv.textContent = 'âœ“ è‡ªå®šä¹‰ç«¯å£å‡å¯ç”¨';
  }

  if (stdConflicts.length > 0) {
    const detail = stdConflicts.map(r => t('dyn_port_occupied', { name: r.name, port: r.port })).join('\n');
    if (confirm(t('dyn_port_conflict') + '\n' + detail)) {
      // åªå¯¹æ ‡å‡†ç«¯å£åšè‡ªåŠ¨ä¿®å¤
      const stdPorts = {
        theia:    parseInt(document.getElementById('ws-port-theia').value)    || 20001,
        kanban:   parseInt(document.getElementById('ws-port-kanban').value)   || 20002,
        openclaw: parseInt(document.getElementById('ws-port-openclaw').value) || 20003,
        novnc:    parseInt(document.getElementById('ws-port-novnc').value)    || 20004,
        vnc:      parseInt(document.getElementById('ws-port-vnc').value)      || 20005
        // Audio uses /audio path on novnc port
      };
      const fixedPorts = await app.autoFixPorts(stdPorts);
      document.getElementById('ws-port-theia').value    = fixedPorts.theia;
      document.getElementById('ws-port-kanban').value   = fixedPorts.kanban;
      document.getElementById('ws-port-openclaw').value = fixedPorts.openclaw;
      document.getElementById('ws-port-novnc').value    = fixedPorts.novnc;
      document.getElementById('ws-port-vnc').value      = fixedPorts.vnc;
      alert(t('dyn_port_fixed'));
    }
  } else if (stdConflicts.length === 0 && customConflicts.length === 0) {
    alert(t('dyn_port_ok'));
  }
});

document.getElementById('btn-save-config').addEventListener('click', () => {
  collectWorkspaceForm();
  // Restart proxies with new credentials
  app.startProxies(cfg);
  // Reset iframes so they reload with new auth
  Object.keys(iframeLoaded).forEach(k => iframeLoaded[k] = false);
  alert(t('dyn_config_saved'));
});

document.getElementById('btn-save-restart').addEventListener('click', () => {
  const btn = document.getElementById('btn-save-restart');
  const originalContent = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<span class="loading-spinner" style="width:14px;height:14px;border-width:1.5px"></span>\u00a0<span>' + t('dyn_restarting') + '</span>';
  collectWorkspaceForm();
  app.startProxies(cfg);
  Object.keys(iframeLoaded).forEach(k => iframeLoaded[k] = false);
  app.dockerDown(cfg, null, () => {
    app.dockerUp(cfg, (data) => {
      document.getElementById('ws-log').textContent += data;
      document.getElementById('ws-log').scrollTop = document.getElementById('ws-log').scrollHeight;
    }, () => {
      btn.disabled = false;
      btn.innerHTML = originalContent;
      if (currentTab !== 'status') activateTab(currentTab);
      startLogStream();
    });
  });
});

// â”€â”€â”€ Cloudflare help links â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

['cf-help-link-wizard', 'cf-help-link-ws'].forEach(function(id) {
  var el = document.getElementById(id);
  if (el) el.addEventListener('click', function(e) {
    e.preventDefault();
    nw.Shell.openExternal('https://one.dash.cloudflare.com/');
  });
});

// â”€â”€â”€ Eye toggle (å¯†ç å¯è§æ€§åˆ‡æ¢) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// åˆå§‹åŒ–æ‰€æœ‰çœ¼ç›æŒ‰é’®å›¾æ ‡ï¼ˆé»˜è®¤æ˜¾ç¤º eyeOffï¼Œè¡¨ç¤ºå½“å‰æ˜¯å¯†ç æ¨¡å¼ï¼‰
function initEyeToggles() {
  document.querySelectorAll('.eye-toggle').forEach(function(btn) {
    btn.innerHTML = icons.eyeOff;
  });
}

document.addEventListener('click', function(e) {
  const btn = e.target.closest('.eye-toggle');
  if (!btn) return;
  const targetId = btn.getAttribute('data-target');
  const input = document.getElementById(targetId);
  if (!input) return;
  const nowVisible = input.type === 'password';
  input.type = nowVisible ? 'text' : 'password';
  btn.innerHTML = nowVisible ? icons.eye : icons.eyeOff;
});

// â”€â”€â”€ Multi-instance: init, sidebar, switch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function initInstances() {
  migrateFromSingleInstance();
  globalCfg = readGlobalConfig();

  if (!globalCfg) {
    // Fresh install: create global.json with one pending entry (no instance config yet)
    const id = 'inst-1';
    globalCfg = {
      version: 1,
      activeInstanceId: id,
      instances: [{ id, name: 'Default', createdAt: new Date().toISOString() }]
    };
    writeGlobalConfig(globalCfg);
    activeInstanceId = id;
    // cfg with multi-instance fields but no persisted config yet (wizard will create it)
    cfg = Object.assign({}, DEFAULT_CONFIG, {
      INSTANCE_ID:    id,
      PROJECT_NAME:   'webcode',
      CONTAINER_NAME: 'webcode',
      WORK_DIR:       getInstanceWorkDir(id)
    });
  } else {
    activeInstanceId = globalCfg.activeInstanceId || globalCfg.instances[0].id;
    cfg = readInstanceConfig(activeInstanceId);
    if (!cfg) {
      // Instance registered but config not yet created (shouldn't happen after migration)
      cfg = Object.assign({}, DEFAULT_CONFIG, {
        INSTANCE_ID:    activeInstanceId,
        PROJECT_NAME:   'webcode-' + activeInstanceId,
        CONTAINER_NAME: 'webcode-' + activeInstanceId,
        WORK_DIR:       getInstanceWorkDir(activeInstanceId)
      });
    }
  }
}

function renderSidebar() {
  const list = document.getElementById('instance-list');
  const instances = globalCfg ? (globalCfg.instances || []) : [];
  list.innerHTML = instances.map(function(inst) {
    const isActive = inst.id === activeInstanceId;
    const canRemove = instances.length > 1;
    return '<div class="instance-item' + (isActive ? ' active' : '') + '" data-instance-id="' + escHtml(inst.id) + '">' +
      '<span class="instance-status-dot dot dot-gray" id="dot-' + escHtml(inst.id) + '"></span>' +
      '<span class="instance-name">' + escHtml(inst.name) + '</span>' +
      (canRemove ? '<button class="instance-remove-btn" data-remove-id="' + escHtml(inst.id) + '" title="åˆ é™¤">âœ•</button>' : '') +
      '</div>';
  }).join('');
}

function switchToInstance(id) {
  if (id === activeInstanceId) return;

  app.stopProxies();
  app.stopPolling();
  if (logsProc) { try { logsProc.kill(); } catch(e) {} logsProc = null; }

  activeInstanceId = id;
  cfg = readInstanceConfig(id);
  if (!cfg) {
    cfg = Object.assign({}, DEFAULT_CONFIG, {
      INSTANCE_ID:    id,
      PROJECT_NAME:   'webcode-' + id,
      CONTAINER_NAME: 'webcode-' + id,
      WORK_DIR:       getInstanceWorkDir(id)
    });
  }

  globalCfg.activeInstanceId = id;
  writeGlobalConfig(globalCfg);

  proxyStarted = false;

  // Reset iframes
  Object.keys(iframeLoaded).forEach(function(k) { iframeLoaded[k] = false; });
  Object.keys(IFRAME_IDS).forEach(function(tab) {
    document.getElementById(IFRAME_IDS[tab]).src = '';
  });

  renderSidebar();
  refreshSidebarDots(); // ç«‹å³æ›´æ–°æ‰€æœ‰å®ä¾‹çŠ¶æ€ç‚¹ï¼Œæ— éœ€ç­‰å¾…è½®è¯¢å‘¨æœŸ

  app.dockerPs(cfg, function(err, containers) {
    if (!err && containerRunning(containers)) {
      showWorkspace();
    } else {
      ensureInstanceComposeFile(id);
      showWizard(4);
    }
  });
}

function handleCreateInstance(name) {
  const result = createInstance(name || t('btn_add_instance'));
  globalCfg = readGlobalConfig();
  renderSidebar();
  switchToInstance(result.id);
}

function handleRemoveInstance(id) {
  const instances = globalCfg.instances || [];
  if (instances.length <= 1) {
    alert(t('dyn_cannot_remove_last'));
    return;
  }
  const inst = instances.find(function(i) { return i.id === id; });
  if (!confirm(t('dyn_confirm_remove_instance', { name: inst ? inst.name : id }))) return;

  const wasActive = (id === activeInstanceId);
  removeInstance(id);
  globalCfg = readGlobalConfig();

  if (wasActive) {
    activeInstanceId = globalCfg.activeInstanceId;
    cfg = readInstanceConfig(activeInstanceId) || Object.assign({}, DEFAULT_CONFIG, {
      INSTANCE_ID: activeInstanceId,
      PROJECT_NAME: 'webcode-' + activeInstanceId,
      CONTAINER_NAME: 'webcode-' + activeInstanceId,
      WORK_DIR: getInstanceWorkDir(activeInstanceId)
    });
    proxyStarted = false;
    if (logsProc) { try { logsProc.kill(); } catch(e) {} logsProc = null; }
    renderSidebar();
    app.dockerPs(cfg, function(err, containers) {
      if (!err && containerRunning(containers)) {
        showWorkspace();
      } else {
        showWizard(4);
      }
    });
  } else {
    renderSidebar();
  }
}

let sidebarPollTimer = null;

function refreshSidebarDots() {
  const instances = globalCfg ? (globalCfg.instances || []) : [];
  instances.forEach(function(inst) {
    const instCfg = readInstanceConfig(inst.id);
    if (!instCfg) return;
    app.dockerPs(instCfg, function(err, containers) {
      const dot = document.getElementById('dot-' + inst.id);
      if (!dot) return;
      const running = containerRunning(containers);
      dot.className = 'instance-status-dot dot ' + (running ? 'dot-green' : 'dot-gray');
    });
  });
}

function startSidebarPolling() {
  if (sidebarPollTimer) clearInterval(sidebarPollTimer);
  refreshSidebarDots(); // ç«‹å³åˆ·æ–°ä¸€æ¬¡ï¼Œé¿å…ç­‰å¾…ç¬¬ä¸€ä¸ªå‘¨æœŸ
  sidebarPollTimer = setInterval(refreshSidebarDots, 10000);
}

// Sidebar toggle
document.getElementById('sidebar-toggle').addEventListener('click', function() {
  const sidebar = document.getElementById('sidebar');
  const isCollapsed = sidebar.classList.contains('sidebar-collapsed');
  sidebar.classList.toggle('sidebar-collapsed', !isCollapsed);
  sidebar.classList.toggle('sidebar-expanded', isCollapsed);
});

// Instance list click delegation
document.getElementById('instance-list').addEventListener('click', function(e) {
  const removeBtn = e.target.closest('[data-remove-id]');
  if (removeBtn) {
    e.stopPropagation();
    handleRemoveInstance(removeBtn.getAttribute('data-remove-id'));
    return;
  }
  const item = e.target.closest('[data-instance-id]');
  if (item) {
    switchToInstance(item.getAttribute('data-instance-id'));
  }
});

// Add instance button
document.getElementById('sidebar-add-btn').addEventListener('click', function() {
  document.getElementById('new-instance-name').value = '';
  document.getElementById('add-instance-modal').style.display = 'flex';
  setTimeout(function() { document.getElementById('new-instance-name').focus(); }, 50);
});

// Modal cancel
document.getElementById('modal-cancel').addEventListener('click', function() {
  document.getElementById('add-instance-modal').style.display = 'none';
});

// Modal confirm
document.getElementById('modal-confirm').addEventListener('click', function() {
  const name = document.getElementById('new-instance-name').value.trim() || 'New Instance';
  document.getElementById('add-instance-modal').style.display = 'none';
  handleCreateInstance(name);
});

// Modal: Enter key confirms, Escape cancels
document.getElementById('new-instance-name').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') document.getElementById('modal-confirm').click();
  if (e.key === 'Escape') document.getElementById('modal-cancel').click();
});

// Modal: click backdrop to cancel
document.getElementById('add-instance-modal').addEventListener('click', function(e) {
  if (e.target === this) document.getElementById('modal-cancel').click();
});

// â”€â”€â”€ Update feature â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let updateCheckTimer = null;
let updateInfo = null;
let updateCheckInProgress = false;

// â”€â”€â”€ Update checking â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function showUpdateProgressPanel() {
  const panel = document.getElementById('update-progress-panel');
  panel.style.display = 'block';

  // Reset all steps
  document.querySelectorAll('.check-step').forEach(function(step) {
    step.classList.remove('active', 'completed');
  });
}

function hideUpdateProgressPanel() {
  document.getElementById('update-progress-panel').style.display = 'none';
}

function updateCheckProgress(step) {
  // Mark previous steps as completed
  const steps = ['container-local', 'container-remote', 'launcher', 'complete'];
  const stepIndex = steps.indexOf(step);

  document.querySelectorAll('.check-step').forEach(function(el) {
    const elStep = el.getAttribute('data-step');
    const elIndex = steps.indexOf(elStep);

    el.classList.remove('active', 'completed');

    if (elIndex < stepIndex) {
      el.classList.add('completed');
    } else if (elIndex === stepIndex) {
      el.classList.add('active');
    }
  });
}

function checkForUpdates(options) {
  if (!cfg) return Promise.resolve();

  options = options || {};
  const silent = options.silent || false;

  if (!silent) {
    updateCheckInProgress = true;
    showUpdateProgressPanel();
  }

  const onProgress = function(step, status) {
    console.log('[Update Check] Step:', step, 'Status:', status);
    if (!silent) {
      updateCheckProgress(step);
    }
  };

  console.log('[Update Check] Starting...');
  return app.checkForUpdates(cfg, onProgress).then(function(result) {
    console.log('[Update Check] Complete:', result);
    updateInfo = result;

    if (!silent) {
      updateCheckInProgress = false;
      hideUpdateProgressPanel();

      // Check if cancelled
      if (result.cancelled) {
        return result;
      }

      // Show result based on updates
      if (result.containerUpdate || result.launcherUpdate) {
        showUpdateBadge();
        // Auto-open update modal
        setTimeout(function() {
          showUpdateModal();
        }, 300);
      } else {
        hideUpdateBadge();
        // Briefly show "no updates" message
        const statusText = document.getElementById('status-text');
        const originalText = statusText.textContent;
        statusText.textContent = t('update_latest');
        statusText.style.color = 'var(--success)';
        setTimeout(function() {
          statusText.textContent = originalText;
          statusText.style.color = '';
        }, 2000);
      }
    } else {
      // Silent mode - just update badge state
      if (result.containerUpdate || result.launcherUpdate) {
        showUpdateBadge();
      } else {
        hideUpdateBadge();
      }
    }

    return result;
  });
}

function showUpdateBadge() {
  const banner = document.getElementById('update-banner');
  if (!banner) return;

  if (updateInfo) {
    // Update banner text based on what's available
    const bannerText = banner.querySelector('.update-banner-text');
    if (bannerText) {
      if (updateInfo.containerUpdate && updateInfo.launcherUpdate) {
        bannerText.textContent = 'å®¹å™¨å’Œå¯åŠ¨å™¨éƒ½æœ‰æ–°ç‰ˆæœ¬';
      } else if (updateInfo.containerUpdate) {
        bannerText.textContent = 'å®¹å™¨æœ‰æ–°ç‰ˆæœ¬å¯ç”¨';
      } else {
        bannerText.textContent = 'å¯åŠ¨å™¨æœ‰æ–°ç‰ˆæœ¬å¯ç”¨';
      }
    }
    banner.style.display = 'block';
  }
}

function hideUpdateBadge() {
  const banner = document.getElementById('update-banner');
  if (banner) {
    banner.style.display = 'none';
  }
}

function showUpdateModal() {
  if (!updateInfo) return;

  const modal = document.getElementById('update-modal');
  const desc = document.getElementById('update-desc');
  const versions = document.getElementById('update-versions');
  const currentVer = document.getElementById('current-version');
  const latestVer = document.getElementById('latest-version');
  const progress = document.getElementById('update-progress');
  const result = document.getElementById('update-result');
  const launcherSection = document.getElementById('launcher-update-section');
  const confirmBtn = document.getElementById('btn-update-confirm');

  // Reset state
  progress.style.display = 'none';
  result.style.display = 'none';
  result.className = '';
  confirmBtn.disabled = false;

  // Set description
  if (updateInfo.containerUpdate && updateInfo.launcherUpdate) {
    desc.textContent = t('update_both_desc');
  } else if (updateInfo.containerUpdate) {
    desc.textContent = t('update_container_desc');
  } else {
    desc.textContent = t('update_launcher_desc');
  }

  // Set versions
  if (updateInfo.containerUpdate) {
    versions.style.display = 'block';
    currentVer.textContent = (updateInfo.localDigest || '').substring(0, 12) + '...';
    latestVer.textContent = (updateInfo.remoteDigest || '').substring(0, 12) + '...';
  } else {
    versions.style.display = 'none';
  }

  // Show/hide launcher update link
  if (updateInfo.launcherUpdate) {
    launcherSection.style.display = 'block';
  } else {
    launcherSection.style.display = 'none';
  }

  // Only enable container update button if there's a container update
  confirmBtn.style.display = updateInfo.containerUpdate ? 'inline-block' : 'none';

  modal.style.display = 'flex';
}

function hideUpdateModal() {
  document.getElementById('update-modal').style.display = 'none';
}

function performUpdate() {
  const progress = document.getElementById('update-progress');
  const progressText = document.getElementById('update-progress-text');
  const result = document.getElementById('update-result');
  const confirmBtn = document.getElementById('btn-update-confirm');
  const cancelBtn = document.getElementById('btn-update-cancel');

  progress.style.display = 'block';
  result.style.display = 'none';
  confirmBtn.disabled = true;
  cancelBtn.disabled = true;

  progressText.textContent = t('update_stopping');

  app.updateContainer(cfg, function(data) {
    // Update progress text based on data
    const text = data.toString().toLowerCase();
    if (text.includes('stopping') || text.includes('down')) {
      progressText.textContent = t('update_stopping');
    } else if (text.includes('pulling') || text.includes('download')) {
      progressText.textContent = t('update_downloading');
    } else if (text.includes('starting') || text.includes('create')) {
      progressText.textContent = t('update_starting');
    }
  }, function(code) {
    progress.style.display = 'none';
    result.style.display = 'block';

    if (code === 0) {
      result.className = 'update-success';
      result.textContent = t('update_success');
      hideUpdateBadge();
      updateInfo = null;

      // Refresh container status after a short delay
      setTimeout(function() {
        app.startPolling(cfg, function(containers) {
          updateContainerStatus(containers);
        });
      }, 2000);
    } else {
      result.className = 'update-error';
      result.textContent = t('update_failed', { error: 'exit ' + code });
      confirmBtn.disabled = false;
    }
    cancelBtn.disabled = false;
  });
}

// Update banner click - opens modal
// (Inline onclick handler used)

// Update modal buttons
document.getElementById('btn-update-confirm').addEventListener('click', function() {
  performUpdate();
});

document.getElementById('btn-update-cancel').addEventListener('click', function() {
  hideUpdateModal();
});

// Close modal on backdrop click
document.getElementById('update-modal').addEventListener('click', function(e) {
  if (e.target === this) {
    hideUpdateModal();
  }
});

// Launcher download link - open in external browser
document.getElementById('launcher-update-link').addEventListener('click', function(e) {
  e.preventDefault();

  const { exec } = require('child_process');
  const url = 'https://github.com/land007/webcode/releases/latest';

  // Detect platform and use appropriate command
  if (process.platform === 'darwin') {
    exec('open "' + url + '"');
  } else if (process.platform === 'win32') {
    exec('start "" "' + url + '"');
  } else {
    exec('xdg-open "' + url + '"');
  }
});

// Auto-check for updates every 10 minutes (only when container is running)
function startUpdatePolling() {
  if (updateCheckTimer) clearInterval(updateCheckTimer);

  // Check immediately when starting (silent mode)
  setTimeout(function() {
    app.dockerPs(cfg, function(err, containers) {
      if (!err && containerRunning(containers)) {
        checkForUpdates({ silent: true });
      }
    });
  }, 5000);

  updateCheckTimer = setInterval(function() {
    app.dockerPs(cfg, function(err, containers) {
      if (!err && containerRunning(containers)) {
        checkForUpdates({ silent: true });
      }
    });
  }, 10 * 60 * 1000); // 10 minutes
}

// â”€â”€â”€ Boot logic â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function boot() {
  // åˆå§‹åŒ–å¤šå®ä¾‹çŠ¶æ€
  initInstances();

  // åˆå§‹åŒ–ä¸»é¢˜ï¼ˆhead è„šæœ¬å·²è®¾ data-themeï¼Œè¿™é‡ŒåŒæ­¥æŒ‰é’®çŠ¶æ€ï¼‰
  applyTheme(safeLocalStorage.getItem(THEME_KEY, 'dark'));
  // æ¸²æŸ“æ ‡ç­¾é¡µå›¾æ ‡
  renderTabIcons();
  // åˆå§‹åŒ–çœ¼ç›å›¾æ ‡
  initEyeToggles();
  // Apply translations to all annotated elements
  applyTranslations();
  // æ¸²æŸ“ä¾§è¾¹æ 
  renderSidebar();

  const fs = require('fs');
  if (!fs.existsSync(getInstanceConfigPath(activeInstanceId))) {
    // First run for this instance: wizard from step 1
    showWizard(1);
    runDockerCheck();
  } else {
    // Config exists: check if container is running
    ensureInstanceComposeFile(activeInstanceId);
    app.dockerPs(cfg, (err, containers) => {
      if (!err && containerRunning(containers)) {
        // Already running â†’ go straight to workspace
        showWorkspace();
      } else {
        // Not running â†’ step 4
        showWizard(4);
      }
    });
  }

  startSidebarPolling();
  startUpdatePolling();
}

boot();
</script>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DEBUG PANEL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="debug-panel" style="display:none;position:fixed;bottom:0;left:0;right:0;height:200px;background:rgba(0,0,0,0.95);color:#0f0;font-family:monospace;font-size:12px;padding:10px;z-index:99999;overflow-y:auto;border-top:2px solid #0f0;">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
    <strong style="color:#ff0;">ğŸ› DEBUG LOG (Shift+F12 åˆ‡æ¢)</strong>
    <button onclick="toggleDebugPanel()" style="background:#333;color:#fff;border:1px solid #0f0;padding:4px 12px;cursor:pointer;border-radius:4px;">å…³é—­</button>
  </div>
  <div id="debug-log"></div>
</div>

<script>
// Debug logging to screen
var debugLog = [];
var originalConsoleLog = console.log;
var debugPanelVisible = false;

function addToDebugLog(message) {
  var timestamp = new Date().toLocaleTimeString();
  debugLog.push('[' + timestamp + '] ' + message);

  if (debugPanelVisible) {
    var logDiv = document.getElementById('debug-log');
    if (logDiv) {
      logDiv.innerHTML = debugLog.join('<br>');
      logDiv.scrollTop = logDiv.scrollHeight;
    }
  }
}

// Override console.log to also capture output
console.log = function() {
  var message = Array.prototype.slice.call(arguments).join(' ');
  originalConsoleLog.apply(console, arguments);
  addToDebugLog(message);
};

console.error = function() {
  var message = 'ERROR: ' + Array.prototype.slice.call(arguments).join(' ');
  originalConsoleError.apply(console, arguments);
  addToDebugLog(message);
};

console.warn = function() {
  var message = 'WARN: ' + Array.prototype.slice.call(arguments).join(' ');
  originalConsoleWarn.apply(console, arguments);
  addToDebugLog(message);
};

function toggleDebugPanel() {
  var panel = document.getElementById('debug-panel');
  if (panel) {
    debugPanelVisible = !debugPanelVisible;
    panel.style.display = debugPanelVisible ? 'block' : 'none';

    if (debugPanelVisible) {
      var logDiv = document.getElementById('debug-log');
      if (logDiv) {
        logDiv.innerHTML = debugLog.join('<br>');
        logDiv.scrollTop = logDiv.scrollHeight;
      }
    }
  }
}

// Keyboard shortcut to toggle debug panel
document.addEventListener('keydown', function(e) {
  if (e.shiftKey && e.key === 'F12') {
    e.preventDefault();
    toggleDebugPanel();
  }
});
</script>

</body>
</html>
