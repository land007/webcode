<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>webcode</title>
  <link rel="stylesheet" href="src/style.css">
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• WIZARD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="wizard">
  <div class="wizard-card">
    <h1>webcode å¯åŠ¨å™¨</h1>
    <p class="subtitle">æµè§ˆå™¨å¯è®¿é—®çš„å¼€å‘ç¯å¢ƒï¼Œç”± Docker é©±åŠ¨</p>

    <!-- Step dots -->
    <div class="step-indicator" id="step-dots"></div>

    <!-- Step 1: Docker check -->
    <div id="step-1">
      <p class="text-muted text-sm" style="margin-bottom:16px">æ­£åœ¨æ£€æµ‹è¿è¡Œç¯å¢ƒâ€¦</p>
      <div id="check-docker-installed" class="check-row">
        <span class="icon">ğŸ³</span>
        <span class="label">Docker å·²å®‰è£…</span>
        <span class="badge badge-checking">æ£€æµ‹ä¸­</span>
      </div>
      <div id="check-docker-running" class="check-row">
        <span class="icon">â–¶</span>
        <span class="label">Docker æ­£åœ¨è¿è¡Œ</span>
        <span class="badge badge-checking">æ£€æµ‹ä¸­</span>
      </div>
      <div id="docker-help" style="display:none; margin-top:12px; font-size:12px; color:var(--text-muted)">
        è¯·å…ˆå®‰è£…å¹¶å¯åŠ¨
        <a class="link" id="docker-dl-link">Docker Desktop</a>ï¼Œç„¶ååˆ·æ–°æ£€æµ‹ã€‚
      </div>
      <div class="action-row">
        <button class="btn-secondary btn-sm" id="btn-recheck">é‡æ–°æ£€æµ‹</button>
        <button class="btn-primary" id="btn-step1-next" disabled>ä¸‹ä¸€æ­¥</button>
      </div>
    </div>

    <!-- Step 2: Config -->
    <div id="step-2" style="display:none">
      <div class="form-group">
        <label>è¿è¡Œæ¨¡å¼</label>
        <div class="toggle-row">
          <button class="toggle-btn active" data-mode="desktop" id="mode-desktop">ğŸ–¥ Desktopï¼ˆå®Œæ•´æ¡Œé¢ï¼‰</button>
          <button class="toggle-btn" data-mode="lite" id="mode-lite">âš¡ Liteï¼ˆä»… IDE + çœ‹æ¿ï¼‰</button>
        </div>
      </div>
      <div class="form-group">
        <label>Basic Auth å¯†ç </label>
        <input type="password" id="cfg-auth-password" placeholder="changeme">
      </div>
      <div id="vnc-group" class="form-group">
        <label>VNC å¯†ç </label>
        <input type="password" id="cfg-vnc-password" placeholder="changeme">
      </div>
      <div class="form-group">
        <label>OpenClaw Token</label>
        <input type="text" id="cfg-openclaw-token" placeholder="changeme">
      </div>
      <details>
        <summary>é«˜çº§é€‰é¡¹</summary>
        <div class="config-grid" style="margin-top:10px">
          <div class="form-group">
            <label>Basic Auth ç”¨æˆ·å</label>
            <input type="text" id="cfg-auth-user" placeholder="admin">
          </div>
          <div class="form-group">
            <label>VNC åˆ†è¾¨ç‡</label>
            <input type="text" id="cfg-vnc-resolution" placeholder="1920x1080">
          </div>
          <div class="form-group">
            <label>Git ç”¨æˆ·å</label>
            <input type="text" id="cfg-git-name" placeholder="ï¼ˆå¯é€‰ï¼‰">
          </div>
          <div class="form-group">
            <label>Git é‚®ç®±</label>
            <input type="text" id="cfg-git-email" placeholder="ï¼ˆå¯é€‰ï¼‰">
          </div>
        </div>
        <div class="form-group">
          <label>Cloudflare Tunnel Tokenï¼ˆå¯é€‰ï¼‰</label>
          <input type="text" id="cfg-cf-token" placeholder="">
        </div>
      </details>
      <div class="action-row">
        <button class="btn-secondary btn-sm" id="btn-step2-back">ä¸Šä¸€æ­¥</button>
        <button class="btn-primary" id="btn-step2-next">ä¸‹ä¸€æ­¥ï¼šå¯åŠ¨å®¹å™¨</button>
      </div>
    </div>

    <!-- Step 3: Launch -->
    <div id="step-3" style="display:none">
      <p class="text-muted text-sm" style="margin-bottom:12px">æ­£åœ¨å¯åŠ¨ webcode å®¹å™¨ï¼Œé¦–æ¬¡è¿è¡Œå°†æ‹‰å–é•œåƒï¼ˆçº¦ 2â€“5 åˆ†é’Ÿï¼‰â€¦</p>
      <div class="log-area" id="launch-log" style="height:240px"></div>
      <div class="action-row">
        <button class="btn-secondary btn-sm" id="btn-step3-back">è¿”å›é…ç½®</button>
        <button class="btn-primary" id="btn-step3-next" disabled>è¿›å…¥å·¥ä½œåŒº â†’</button>
      </div>
    </div>

    <!-- Step 4: Ready (re-launch) -->
    <div id="step-4" style="display:none">
      <p class="text-muted text-sm" style="margin-bottom:16px">é…ç½®å·²åŠ è½½ï¼Œå®¹å™¨å½“å‰æœªè¿è¡Œã€‚</p>
      <div class="action-row" style="justify-content:flex-start; flex-wrap:wrap; gap:10px">
        <button class="btn-primary" id="btn-step4-start">â–¶ å¯åŠ¨å®¹å™¨</button>
        <button class="btn-secondary btn-sm" id="btn-step4-config">ä¿®æ”¹é…ç½®</button>
        <button class="btn-secondary btn-sm" id="btn-step4-enter">ç›´æ¥è¿›å…¥å·¥ä½œåŒº</button>
      </div>
      <div class="log-area mt-3" id="relaunch-log" style="height:200px; display:none"></div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• WORKSPACE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="workspace">
  <!-- Top bar -->
  <div class="topbar">
    <button class="tab-btn" id="tab-status" data-tab="status">â— çŠ¶æ€</button>
    <button class="tab-btn" id="tab-ide"    data-tab="ide">ğŸ’» IDE</button>
    <button class="tab-btn" id="tab-kanban" data-tab="kanban">ğŸ“‹ çœ‹æ¿</button>
    <button class="tab-btn" id="tab-vnc"    data-tab="vnc">ğŸ–¥ æ¡Œé¢</button>
    <button class="tab-btn" id="tab-ai"     data-tab="ai">ğŸ¤– AI</button>
    <span class="topbar-spacer"></span>
    <div class="status-pill">
      <span class="dot dot-gray" id="status-dot"></span>
      <span id="status-text">æ£€æµ‹ä¸­â€¦</span>
    </div>
    <div class="topbar-actions">
      <button class="btn-secondary btn-sm" id="btn-restart">é‡å¯</button>
      <button class="btn-secondary btn-sm" id="btn-stop">åœæ­¢</button>
    </div>
  </div>

  <!-- Content area -->
  <div class="iframe-area" id="iframe-area">
    <!-- Status panel (not an iframe) -->
    <div id="panel-status">
      <div>
        <h3 style="font-size:15px; font-weight:600; margin-bottom:12px">å®¹å™¨çŠ¶æ€</h3>
        <div class="status-grid" id="status-grid">
          <div class="svc-card">
            <div class="svc-name">webcode</div>
            <div class="svc-state"><span class="dot dot-gray"></span> <span id="main-state">æœªçŸ¥</span></div>
          </div>
        </div>
      </div>

      <!-- Config section -->
      <div class="config-section">
        <h3>é…ç½®</h3>
        <div class="config-grid">
          <div class="form-group">
            <label>è¿è¡Œæ¨¡å¼</label>
            <div class="toggle-row">
              <button class="toggle-btn" data-mode="desktop" id="ws-mode-desktop">ğŸ–¥ Desktop</button>
              <button class="toggle-btn" data-mode="lite"    id="ws-mode-lite">âš¡ Lite</button>
            </div>
          </div>
          <div class="form-group">
            <label>Basic Auth å¯†ç </label>
            <input type="password" id="ws-auth-password">
          </div>
          <div class="form-group">
            <label>VNC å¯†ç </label>
            <input type="password" id="ws-vnc-password">
          </div>
          <div class="form-group">
            <label>OpenClaw Token</label>
            <input type="text" id="ws-openclaw-token">
          </div>
          <div class="form-group">
            <label>Basic Auth ç”¨æˆ·å</label>
            <input type="text" id="ws-auth-user">
          </div>
          <div class="form-group">
            <label>VNC åˆ†è¾¨ç‡</label>
            <input type="text" id="ws-vnc-resolution">
          </div>
          <div class="form-group">
            <label>Git ç”¨æˆ·å</label>
            <input type="text" id="ws-git-name">
          </div>
          <div class="form-group">
            <label>Git é‚®ç®±</label>
            <input type="text" id="ws-git-email">
          </div>
        </div>
        <div class="form-group">
          <label>Cloudflare Tunnel Tokenï¼ˆå¯é€‰ï¼‰</label>
          <input type="text" id="ws-cf-token">
        </div>
        <div class="action-row" style="margin-top:0">
          <button class="btn-secondary btn-sm" id="btn-save-config">ä¿å­˜é…ç½®</button>
          <button class="btn-primary btn-sm"   id="btn-save-restart">ä¿å­˜å¹¶é‡å¯å®¹å™¨</button>
        </div>
      </div>

      <!-- Logs -->
      <div>
        <h3 style="font-size:14px; font-weight:600; margin-bottom:8px">å®¹å™¨æ—¥å¿—</h3>
        <div class="log-area" id="ws-log" style="height:260px"></div>
      </div>
    </div>

    <!-- iframes (lazy â€“ src set when first activated) -->
    <iframe id="iframe-ide"    sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-modals allow-downloads"></iframe>
    <iframe id="iframe-kanban" sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-modals"></iframe>
    <iframe id="iframe-vnc"    sandbox="allow-scripts allow-same-origin allow-forms allow-popups"></iframe>
    <iframe id="iframe-ai"     sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-modals"></iframe>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SCRIPTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
// Bring in Node modules via nw.js
const app = require('./src/app.js');
const { readConfig, writeConfig, configExists, ensureComposeFile } = require('./src/config.js');

// â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let currentStep = 1;
let currentTab  = 'status';
let cfg = readConfig();
let proxyStarted = false;
let logsProc = null;

function setStep(n) {
  for (let i = 1; i <= 4; i++) {
    document.getElementById('step-' + i).style.display = (i === n) ? '' : 'none';
  }
  currentStep = n;
  renderStepDots(n);
}

function renderStepDots(active) {
  const dots = document.getElementById('step-dots');
  dots.innerHTML = '';
  for (let i = 1; i <= 3; i++) {
    const d = document.createElement('div');
    d.className = 'step-dot' +
      (i < active ? ' done' : (i === active ? ' active' : ''));
    dots.appendChild(d);
  }
}

function showWizard(step) {
  document.getElementById('wizard').style.display = '';
  document.getElementById('workspace').style.display = 'none';
  setStep(step);
}

function showWorkspace() {
  document.getElementById('wizard').style.display = 'none';
  document.getElementById('workspace').style.display = 'flex';
  activateTab('status');
  loadConfigIntoWorkspaceForm();
  startStatusPolling();
  startLogStream();
  if (!proxyStarted) {
    app.startProxies(cfg);
    proxyStarted = true;
  }
}

// â”€â”€â”€ Step 1: Docker check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function runDockerCheck() {
  setCheckState('check-docker-installed', 'checking', 'æ£€æµ‹ä¸­');
  setCheckState('check-docker-running',   'checking', 'æ£€æµ‹ä¸­');
  document.getElementById('docker-help').style.display = 'none';
  document.getElementById('btn-step1-next').disabled = true;

  app.checkDocker((result) => {
    if (result.installed) {
      setCheckState('check-docker-installed', 'ok', result.version);
    } else {
      setCheckState('check-docker-installed', 'fail', 'æœªæ‰¾åˆ°');
      setCheckState('check-docker-running',   'fail', 'â€”');
      document.getElementById('docker-help').style.display = '';
      return;
    }
    if (result.running) {
      setCheckState('check-docker-running', 'ok', 'è¿è¡Œä¸­');
      document.getElementById('btn-step1-next').disabled = false;
    } else {
      setCheckState('check-docker-running', 'fail', 'æœªè¿è¡Œ');
      document.getElementById('docker-help').style.display = '';
    }
  });
}

function setCheckState(id, state, text) {
  const row  = document.getElementById(id);
  const badge = row.querySelector('.badge');
  badge.textContent = text;
  badge.className = 'badge ' + (state === 'ok' ? 'badge-ok' : state === 'fail' ? 'badge-fail' : 'badge-checking');
}

document.getElementById('btn-recheck').addEventListener('click', runDockerCheck);

document.getElementById('btn-step1-next').addEventListener('click', () => {
  loadConfigIntoWizardForm();
  setStep(2);
});

// Docker Desktop download link
document.getElementById('docker-dl-link').addEventListener('click', () => {
  nw.Shell.openExternal('https://www.docker.com/products/docker-desktop/');
});

// â”€â”€â”€ Step 2: Config form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let selectedMode = cfg.MODE || 'desktop';

document.querySelectorAll('[data-mode]').forEach(btn => {
  btn.addEventListener('click', () => {
    selectedMode = btn.dataset.mode;
    // update active state for sibling buttons sharing the same parent
    btn.closest('.toggle-row').querySelectorAll('.toggle-btn').forEach(b => {
      b.classList.toggle('active', b === btn);
    });
    if (btn.closest('#step-2')) {
      document.getElementById('vnc-group').style.display =
        selectedMode === 'desktop' ? '' : 'none';
    }
  });
});

function loadConfigIntoWizardForm() {
  document.getElementById('cfg-auth-password').value  = cfg.AUTH_PASSWORD || '';
  document.getElementById('cfg-vnc-password').value   = cfg.VNC_PASSWORD  || '';
  document.getElementById('cfg-openclaw-token').value = cfg.OPENCLAW_TOKEN || '';
  document.getElementById('cfg-auth-user').value      = cfg.AUTH_USER || 'admin';
  document.getElementById('cfg-vnc-resolution').value = cfg.VNC_RESOLUTION || '1920x1080';
  document.getElementById('cfg-git-name').value       = cfg.GIT_USER_NAME || '';
  document.getElementById('cfg-git-email').value      = cfg.GIT_USER_EMAIL || '';
  document.getElementById('cfg-cf-token').value       = cfg.CF_TUNNEL_TOKEN || '';

  selectedMode = cfg.MODE || 'desktop';
  document.getElementById('mode-desktop').classList.toggle('active', selectedMode === 'desktop');
  document.getElementById('mode-lite').classList.toggle('active', selectedMode === 'lite');
  document.getElementById('vnc-group').style.display = selectedMode === 'desktop' ? '' : 'none';
}

function collectWizardForm() {
  cfg.AUTH_PASSWORD  = document.getElementById('cfg-auth-password').value  || 'changeme';
  cfg.VNC_PASSWORD   = document.getElementById('cfg-vnc-password').value   || 'changeme';
  cfg.OPENCLAW_TOKEN = document.getElementById('cfg-openclaw-token').value || 'changeme';
  cfg.AUTH_USER      = document.getElementById('cfg-auth-user').value      || 'admin';
  cfg.VNC_RESOLUTION = document.getElementById('cfg-vnc-resolution').value || '1920x1080';
  cfg.GIT_USER_NAME  = document.getElementById('cfg-git-name').value  || '';
  cfg.GIT_USER_EMAIL = document.getElementById('cfg-git-email').value || '';
  cfg.CF_TUNNEL_TOKEN= document.getElementById('cfg-cf-token').value  || '';
  cfg.MODE = selectedMode;
  writeConfig(cfg);
}

document.getElementById('btn-step2-back').addEventListener('click', () => setStep(1));
document.getElementById('btn-step2-next').addEventListener('click', () => {
  collectWizardForm();
  startLaunch();
});

// â”€â”€â”€ Step 3: Launch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function appendLog(id, text) {
  const el = document.getElementById(id);
  el.textContent += text;
  el.scrollTop = el.scrollHeight;
}

function startLaunch(logId, nextBtn, backBtn) {
  logId   = logId   || 'launch-log';
  nextBtn = nextBtn || 'btn-step3-next';
  backBtn = backBtn || 'btn-step3-back';

  setStep(3);
  document.getElementById(logId).textContent = '';
  document.getElementById(nextBtn).disabled = true;
  document.getElementById(backBtn).disabled = true;

  ensureComposeFile();

  app.dockerUp(cfg,
    (data) => appendLog(logId, data),
    (code) => {
      document.getElementById(backBtn).disabled = false;
      if (code === 0) {
        appendLog(logId, '\nâœ“ å®¹å™¨å¯åŠ¨æˆåŠŸï¼\n');
        document.getElementById(nextBtn).disabled = false;
      } else {
        appendLog(logId, `\nâœ— å¯åŠ¨å¤±è´¥ï¼ˆexit ${code}ï¼‰\n`);
      }
    }
  );
}

document.getElementById('btn-step3-back').addEventListener('click', () => setStep(2));
document.getElementById('btn-step3-next').addEventListener('click', () => {
  showWorkspace();
});

// â”€â”€â”€ Step 4: Re-launch (config exists, container not running) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

document.getElementById('btn-step4-start').addEventListener('click', () => {
  document.getElementById('relaunch-log').style.display = '';
  document.getElementById('relaunch-log').textContent = '';
  document.getElementById('btn-step4-start').disabled = true;

  app.dockerUp(cfg,
    (data) => appendLog('relaunch-log', data),
    (code) => {
      document.getElementById('btn-step4-start').disabled = false;
      if (code === 0) {
        appendLog('relaunch-log', '\nâœ“ å¯åŠ¨æˆåŠŸï¼\n');
        showWorkspace();
      } else {
        appendLog('relaunch-log', `\nâœ— å¯åŠ¨å¤±è´¥ï¼ˆexit ${code}ï¼‰\n`);
      }
    }
  );
});

document.getElementById('btn-step4-config').addEventListener('click', () => {
  loadConfigIntoWizardForm();
  setStep(2);
});

document.getElementById('btn-step4-enter').addEventListener('click', () => {
  showWorkspace();
});

// â”€â”€â”€ Workspace: tab switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const IFRAME_IDS = { ide: 'iframe-ide', kanban: 'iframe-kanban', vnc: 'iframe-vnc', ai: 'iframe-ai' };
const iframeLoaded = {};

function iframeUrl(tab) {
  switch (tab) {
    case 'ide':    return 'http://localhost:14001';
    case 'kanban': return 'http://localhost:14002';
    case 'vnc':    return `http://localhost:26080/?autoconnect=true&password=${encodeURIComponent(cfg.VNC_PASSWORD)}`;
    case 'ai':     return `http://localhost:14003/?token=${encodeURIComponent(cfg.OPENCLAW_TOKEN)}`;
  }
}

function activateTab(tab) {
  currentTab = tab;

  // Update tab buttons
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.tab === tab);
  });

  // Show/hide status panel vs iframes
  const panel = document.getElementById('panel-status');
  panel.classList.toggle('visible', tab === 'status');

  Object.keys(IFRAME_IDS).forEach(t => {
    const fr = document.getElementById(IFRAME_IDS[t]);
    fr.classList.toggle('visible', t === tab);
    if (t === tab && !iframeLoaded[t]) {
      fr.src = iframeUrl(t);
      iframeLoaded[t] = true;
    }
  });
}

document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => activateTab(btn.dataset.tab));
});

// â”€â”€â”€ Workspace: status polling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function startStatusPolling() {
  app.startPolling(cfg, (containers) => {
    updateStatusUI(containers);
  });
}

function containerRunning(containers) {
  if (!containers || containers.length === 0) return false;
  return containers.some(c => (c.State || c.status || '').toLowerCase().includes('running'));
}

function updateStatusUI(containers) {
  const running = containerRunning(containers);
  const dot  = document.getElementById('status-dot');
  const text = document.getElementById('status-text');

  if (running) {
    dot.className = 'dot dot-green';
    text.textContent = 'è¿è¡Œä¸­';
  } else {
    dot.className = 'dot dot-gray';
    text.textContent = 'å·²åœæ­¢';
  }

  // Status grid
  const grid = document.getElementById('status-grid');
  if (containers.length === 0) {
    grid.innerHTML = '<div class="svc-card"><div class="svc-name">webcode</div><div class="svc-state"><span class="dot dot-gray"></span> æœªè¿è¡Œ</div></div>';
    return;
  }
  grid.innerHTML = containers.map(c => {
    const state = (c.State || c.Status || 'unknown').toLowerCase();
    const dotClass = state.includes('running') ? 'dot-green' :
                     state.includes('starting') ? 'dot-yellow' : 'dot-red';
    return `<div class="svc-card">
      <div class="svc-name">${escHtml(c.Service || c.Name || 'webcode')}</div>
      <div class="svc-state"><span class="dot ${dotClass}"></span> ${escHtml(state)}</div>
    </div>`;
  }).join('');
}

function escHtml(s) {
  return String(s)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// â”€â”€â”€ Workspace: live logs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function startLogStream() {
  if (logsProc) { try { logsProc.kill(); } catch(e) {} }
  const el = document.getElementById('ws-log');
  el.textContent = '';
  logsProc = app.dockerLogs(cfg, (data) => {
    el.textContent += data;
    el.scrollTop = el.scrollHeight;
  });
}

// â”€â”€â”€ Workspace: start / stop buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

document.getElementById('btn-restart').addEventListener('click', () => {
  if (!confirm('ç¡®å®šè¦é‡å¯å®¹å™¨å—ï¼Ÿ')) return;
  app.dockerDown(cfg, null, () => {
    app.dockerUp(cfg, null, () => {
      iframeLoaded['ide'] = iframeLoaded['kanban'] = iframeLoaded['vnc'] = iframeLoaded['ai'] = false;
      if (currentTab !== 'status') activateTab(currentTab);
      startLogStream();
    });
  });
});

document.getElementById('btn-stop').addEventListener('click', () => {
  if (!confirm('ç¡®å®šè¦åœæ­¢å®¹å™¨å—ï¼Ÿ')) return;
  app.dockerDown(cfg, null, null);
});

// â”€â”€â”€ Workspace: config form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let wsMode = cfg.MODE || 'desktop';

document.querySelectorAll('#panel-status [data-mode]').forEach(btn => {
  btn.addEventListener('click', () => {
    wsMode = btn.dataset.mode;
    document.getElementById('ws-mode-desktop').classList.toggle('active', wsMode === 'desktop');
    document.getElementById('ws-mode-lite').classList.toggle('active', wsMode === 'lite');
  });
});

function loadConfigIntoWorkspaceForm() {
  document.getElementById('ws-auth-password').value  = cfg.AUTH_PASSWORD || '';
  document.getElementById('ws-vnc-password').value   = cfg.VNC_PASSWORD  || '';
  document.getElementById('ws-openclaw-token').value = cfg.OPENCLAW_TOKEN || '';
  document.getElementById('ws-auth-user').value      = cfg.AUTH_USER || 'admin';
  document.getElementById('ws-vnc-resolution').value = cfg.VNC_RESOLUTION || '1920x1080';
  document.getElementById('ws-git-name').value       = cfg.GIT_USER_NAME || '';
  document.getElementById('ws-git-email').value      = cfg.GIT_USER_EMAIL || '';
  document.getElementById('ws-cf-token').value       = cfg.CF_TUNNEL_TOKEN || '';
  wsMode = cfg.MODE || 'desktop';
  document.getElementById('ws-mode-desktop').classList.toggle('active', wsMode === 'desktop');
  document.getElementById('ws-mode-lite').classList.toggle('active', wsMode === 'lite');
}

function collectWorkspaceForm() {
  cfg.AUTH_PASSWORD  = document.getElementById('ws-auth-password').value  || 'changeme';
  cfg.VNC_PASSWORD   = document.getElementById('ws-vnc-password').value   || 'changeme';
  cfg.OPENCLAW_TOKEN = document.getElementById('ws-openclaw-token').value || 'changeme';
  cfg.AUTH_USER      = document.getElementById('ws-auth-user').value      || 'admin';
  cfg.VNC_RESOLUTION = document.getElementById('ws-vnc-resolution').value || '1920x1080';
  cfg.GIT_USER_NAME  = document.getElementById('ws-git-name').value  || '';
  cfg.GIT_USER_EMAIL = document.getElementById('ws-git-email').value || '';
  cfg.CF_TUNNEL_TOKEN= document.getElementById('ws-cf-token').value  || '';
  cfg.MODE = wsMode;
  writeConfig(cfg);
}

document.getElementById('btn-save-config').addEventListener('click', () => {
  collectWorkspaceForm();
  // Restart proxies with new credentials
  app.startProxies(cfg);
  // Reset iframes so they reload with new auth
  Object.keys(iframeLoaded).forEach(k => iframeLoaded[k] = false);
  alert('é…ç½®å·²ä¿å­˜ã€‚å¦‚éœ€ç”Ÿæ•ˆè¯·é‡å¯å®¹å™¨ã€‚');
});

document.getElementById('btn-save-restart').addEventListener('click', () => {
  collectWorkspaceForm();
  app.startProxies(cfg);
  Object.keys(iframeLoaded).forEach(k => iframeLoaded[k] = false);
  app.dockerDown(cfg, null, () => {
    app.dockerUp(cfg, (data) => {
      document.getElementById('ws-log').textContent += data;
      document.getElementById('ws-log').scrollTop = document.getElementById('ws-log').scrollHeight;
    }, () => {
      if (currentTab !== 'status') activateTab(currentTab);
      startLogStream();
    });
  });
});

// â”€â”€â”€ Boot logic â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function boot() {
  if (!configExists()) {
    // First run: wizard from step 1
    showWizard(1);
    runDockerCheck();
  } else {
    // Config exists: check if container is running
    ensureComposeFile();
    app.dockerPs(cfg, (err, containers) => {
      if (!err && containerRunning(containers)) {
        // Already running â†’ go straight to workspace
        showWorkspace();
      } else {
        // Not running â†’ step 4
        showWizard(4);
      }
    });
  }
}

boot();
</script>
</body>
</html>
